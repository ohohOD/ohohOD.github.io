import{q as i}from"./index-CpR_-4mG.js";const s="vnlog-save-",o="vnlog-filedata-",p=5,u="vnlog-autosave";class c{static save(e,n,t=null){try{const a=e===null?u:`${s}${e}`,l={...n,timestamp:Date.now(),version:"1.0.0"};return localStorage.setItem(a,JSON.stringify(l)),t&&n.fileCode&&this.saveFileData(n.fileCode,t),console.log(`저장 완료: ${a}`),!0}catch(a){return console.error("저장 실패:",a),!1}}static saveFileData(e,n){try{const t=`${o}${e}`;return localStorage.setItem(t,JSON.stringify(n)),console.log(`파일 데이터 저장 완료: ${t}`),!0}catch(t){return console.error("파일 데이터 저장 실패:",t),!1}}static loadFileData(e){try{const n=`${o}${e}`,t=localStorage.getItem(n);return t?JSON.parse(t):null}catch(n){return console.error("파일 데이터 불러오기 실패:",n),null}}static load(e){try{const n=e===null?u:`${s}${e}`,t=localStorage.getItem(n);if(!t)return null;const a=JSON.parse(t);return console.log(`불러오기 완료: ${n}`),a}catch(n){return console.error("불러오기 실패:",n),null}}static deleteSave(e){try{const n=`${s}${e}`;return localStorage.removeItem(n),console.log(`삭제 완료: ${n}`),!0}catch(n){return console.error("삭제 실패:",n),!1}}static getAllSaves(){const e=[];for(let n=0;n<p;n++){const t=this.load(n);e.push({slotIndex:n,isEmpty:!t,timestamp:(t==null?void 0:t.timestamp)||null,fileCode:(t==null?void 0:t.fileCode)||null,logTitle:(t==null?void 0:t.logTitle)||"",currentSceneIndex:(t==null?void 0:t.currentSceneIndex)||0,currentStepIndex:(t==null?void 0:t.currentStepIndex)||0,totalSteps:(t==null?void 0:t.totalSteps)||0})}return e}static autoSave(e){return this.save(null,e)}static loadAutoSave(){return this.load(null)}static canSave(){try{const e="vnlog-test";return localStorage.setItem(e,"test"),localStorage.removeItem(e),!0}catch(e){return console.error("LocalStorage 사용 불가:",e),!1}}static createSaveData(e){return{fileCode:e.vnData.fileCode,logTitle:e.vnData.title||"제목 없음",currentSceneIndex:e.playback.currentSceneIndex,currentStepIndex:e.playback.currentStepIndex,totalSteps:e.vnData.scenes.reduce((n,t)=>n+t.steps.length,0)}}static applySaveData(e,n){try{if(!n||!n.fileCode)return!1;const t=this.loadFileData(n.fileCode);return t?(e.setVNData(t,!1),e.playback.currentSceneIndex=n.currentSceneIndex,e.playback.currentStepIndex=n.currentStepIndex,console.log("진행도 및 파일 데이터 복원 완료:",n),!0):(console.error("저장된 파일 데이터를 찾을 수 없습니다:",n.fileCode),!1)}catch(t){return console.error("진행도 복원 실패:",t),!1}}static formatSaveInfo(e){if(e.isEmpty)return{title:"빈 슬롯",subtitle:"",date:""};const n=new Date(e.timestamp),t=n.toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"}),a=n.toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit"}),l=e.totalSteps>0?Math.round(e.currentStepIndex/e.totalSteps*100):0;return{title:e.logTitle,subtitle:`진행도: ${l}% (${e.currentStepIndex}/${e.totalSteps})`,date:`${t} ${a}`}}}const d=i("log",{state:()=>({rawLog:null,vnData:{title:"",scenes:[],characters:{},handouts:[]},playback:{currentSceneIndex:0,currentStepIndex:0,isPlaying:!1,autoPlayEnabled:!1,autoPlaySpeed:2e3},settings:{textSpeed:50,skipUnread:!1}}),getters:{currentScene:r=>r.vnData.scenes[r.playback.currentSceneIndex]||null,currentStep:r=>{const e=r.vnData.scenes[r.playback.currentSceneIndex];return(e==null?void 0:e.steps[r.playback.currentStepIndex])||null},hasNextStep:r=>{const e=r.vnData.scenes[r.playback.currentSceneIndex];return e?r.playback.currentStepIndex<e.steps.length-1?!0:r.playback.currentSceneIndex<r.vnData.scenes.length-1:!1},hasPreviousStep:r=>r.playback.currentStepIndex>0||r.playback.currentSceneIndex>0},actions:{setRawLog(r){this.rawLog=r},setVNData(r,e=!0){this.vnData=r,e&&(this.playback.currentSceneIndex=0,this.playback.currentStepIndex=0)},nextStep(){const r=this.vnData.scenes[this.playback.currentSceneIndex];return r?this.playback.currentStepIndex<r.steps.length-1?(this.playback.currentStepIndex++,!0):this.playback.currentSceneIndex<this.vnData.scenes.length-1?(this.playback.currentSceneIndex++,this.playback.currentStepIndex=0,!0):!1:!1},previousStep(){if(this.playback.currentStepIndex>0)return this.playback.currentStepIndex--,!0;if(this.playback.currentSceneIndex>0){this.playback.currentSceneIndex--;const r=this.vnData.scenes[this.playback.currentSceneIndex];return this.playback.currentStepIndex=r.steps.length-1,!0}return!1},goToStep(r,e){return r>=0&&r<this.vnData.scenes.length&&e>=0&&e<this.vnData.scenes[r].steps.length?(this.playback.currentSceneIndex=r,this.playback.currentStepIndex=e,!0):!1},toggleAutoPlay(){this.playback.autoPlayEnabled=!this.playback.autoPlayEnabled},setPlaying(r){this.playback.isPlaying=r},reset(){this.rawLog=null,this.vnData={title:"",scenes:[],characters:{},handouts:[]},this.playback.currentSceneIndex=0,this.playback.currentStepIndex=0,this.playback.isPlaying=!1},saveProgress(r){const e=c.createSaveData(this);return c.save(r,e,this.vnData)},loadProgress(r){const e=c.load(r);return e?c.applySaveData(this,e):!1},autoSave(){const r=c.createSaveData(this);return c.autoSave(r)},loadAutoSave(){const r=c.loadAutoSave();return r?c.applySaveData(this,r):!1}}});export{c as S,d as u};
