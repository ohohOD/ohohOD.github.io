import{u as V}from"./logStore-D5c4XSh6.js";import{_ as W,c as _,a as C,b as P,d as H,r as X,n as j,e as B,t as O,o as U}from"./index-DVE2W4C7.js";class z{static parseHTMLLog(e){const o=new DOMParser().parseFromString(e,"text/html"),t={title:"ì½”ì½”í¬ë¦¬ì•„ ë¡œê·¸",scenes:[],characters:{},handouts:[]},r=o.querySelectorAll(".ccl_tab");if(r.length>0)r.forEach((n,l)=>{const a=this.parseScene(n,l);a.steps.length>0&&t.scenes.push(a),this.collectCharacters(n,t.characters)});else{const n=o.querySelector(".ccfolia_wrap")||o.body,l=this.parseSceneFlat(n);l.steps.length>0&&t.scenes.push(l),this.collectCharactersFlat(n,t.characters)}return t}static parseScene(e,s){const o=e.querySelector(".ccl_tabtitle"),t=o?o.textContent.trim():`ì”¬ ${s+1}`,r={id:`scene_${s}`,name:t,description:null,steps:[]},n=e.querySelectorAll(".ccl_player");let l=0;return n.forEach(a=>{const h=this.parseStep(a,s,l);h&&h.length>0&&h.forEach(d=>{r.steps.push(d),l++})}),r}static parseStep(e,s,o){const t=e.classList.contains("system"),r=e.classList.contains("narrator"),n=e.querySelector(".ccl_Uname"),l=e.querySelector(".ccl_Utext"),a=e.querySelector(".ccl_imgWrap img");if(!l)return null;const h=n?n.textContent.trim():"",d=n?this.extractColor(n):"var(--text-color)",i=l.innerHTML.trim(),v=a?a.getAttribute("src"):null,m=/^ì”¬\s+(\d+)::\s*(.+?)(?:\s*\(([^)]+)\))?\s*(?:<br|$)/i,f=i.match(m);if(f){const c=f[1],R=f[2]?f[2].trim():"",x=f[3]?f[3].trim():null;let y="";const p=i.indexOf("<br>");return p!==-1&&(y=this.cleanText(i.substring(p+4))),console.log("Scene Description Parsed:",{sceneNumber:c,sceneTitle:R,scenePCs:x,sceneDescription:y,rawHTML:i.substring(0,100)}),[{id:`scene_${s}_desc_${o}`,type:"scene-description",character:{name:h,color:d},text:this.cleanText(i),rawText:i,isSceneDescription:!0,sceneNumber:c,sceneTitle:R,scenePCs:x,sceneDescription:y,avatarUrl:v}]}const S=this.splitByBreaks(i),g=[];return S.forEach((c,R)=>{if(!c.trim())return;const x=this.extractDiceRolls(c),y=this.extractStatusChanges(c),p=this.extractDXCombo(c);let u=c;if((x.length>0||y.length>0||p.length>0)&&(u=this.removeDiceCommands(c)),x.length>0&&!this.cleanText(u).trim()){const N=x.some(q=>q.type==="judgement"),I=x.some(q=>q.type==="choice");N?u="* íŒì •":I?u="* ì„ íƒ":u="* ë‹¤ì´ìŠ¤"}y.length>0&&!this.cleanText(u).trim()&&(u="* ìƒíƒœ ë³€í™”"),p.length>0&&!this.cleanText(u).trim()&&(p.length>1||p[0].effects&&p[0].effects.length>1?u="* ì½¤ë³´":u="* ì´í™íŠ¸");const T={id:`step_${s}_${o+R}`,type:t?"system":r?"narrator":"dialogue",character:{name:h,color:d,avatarUrl:v},text:this.cleanText(u),rawText:c,diceRolls:x,hasDice:x.length>0,statusChanges:y,hasStatusChange:y.length>0,dxCombos:p,hasDXCombo:p.length>0,effects:{sfx:null,bgm:null,background:null,backgroundOpacity:.3}};g.push(T)}),g.length>0?g:null}static splitByBreaks(e){return e.split(/<br\s*\/?>/gi).map(s=>s.trim()).filter(s=>s.length>0)}static parseSceneFlat(e){const s={id:"scene_0",name:"ë¡œê·¸",description:null,steps:[]},o=e.querySelectorAll(".gap");let t=0;return o.forEach(r=>{const n=this.parseStepFlat(r,0,t);n&&n.length>0&&n.forEach(l=>{s.steps.push(l),t++})}),s}static parseStepFlat(e,s,o){const t=e.querySelector("p");if(!t)return null;if((e.getAttribute("style")||"").includes("display: flow-root"))return this.parseFlowRootStep(t,s,o);const l=e.querySelector(".msg_container img"),a=t.querySelectorAll("span");let h="",d="var(--text-color)",i="";a.forEach(c=>{var R;window.getComputedStyle||c.style.fontWeight,(c.style.fontWeight==="bold"||(R=c.getAttribute("style"))!=null&&R.includes("font-weight: bold"))&&(h||(h=c.textContent.trim(),d=this.extractColorFromStyle(c.getAttribute("style"))||"var(--text-color)"))});const v=t.innerHTML,m=v.indexOf("<br>");if(m!==-1&&(i=v.substring(m+4).trim()),!i)return null;const f=l?l.getAttribute("src"):null,S=this.splitByBreaks(i),g=[];return S.forEach((c,R)=>{if(!c.trim())return;const x=this.extractDiceRolls(c),y=this.extractStatusChanges(c);let p=c;if((x.length>0||y.length>0)&&(p=this.removeDiceCommands(c)),x.length>0&&!this.cleanText(p).trim()){const N=x.some(q=>q.type==="judgement"),I=x.some(q=>q.type==="choice");N?p="* íŒì •":I?p="* ì„ íƒ":p="* ë‹¤ì´ìŠ¤"}y.length>0&&!this.cleanText(p).trim()&&(p="* ìƒíƒœ ë³€í™”");const u=this.extractDXCombo(c);u.length>0&&!this.cleanText(p).trim()&&(u.length>1||u[0].effects&&u[0].effects.length>1?p="* ì½¤ë³´":p="* ì´í™íŠ¸");const T={id:`step_${s}_${o+R}`,type:h==="GM"?"narrator":"dialogue",character:{name:h,color:d,avatarUrl:f},text:this.cleanText(p),rawText:c,diceRolls:x,hasDice:x.length>0,statusChanges:y,hasStatusChange:y.length>0,dxCombos:this.extractDXCombo(c),hasDXCombo:this.extractDXCombo(c).length>0,effects:{sfx:null,bgm:null,background:null,backgroundOpacity:.3}};g.push(T)}),g.length>0?g:null}static collectCharacters(e,s){e.querySelectorAll(".ccl_player:not(.system):not(.narrator)").forEach(t=>{const r=t.querySelector(".ccl_Uname"),n=t.querySelector(".ccl_imgWrap img");if(r){const l=r.textContent.trim(),a=this.extractColor(r),h=n?n.getAttribute("src"):null;l&&!s[l]&&(s[l]={id:`char_${Object.keys(s).length}`,name:l,color:a,avatarUrl:h,emotions:{default:h}})}})}static parseFlowRootStep(e,s,o){const t=e.querySelectorAll("span");let r="",n="var(--text-color)",l="",a=!1;if(t.forEach((f,S)=>{const g=f.getAttribute("style")||"",c=f.textContent.trim();if(g.includes("background: black")||g.includes("background:black")){a=!0;const R=c.split(" - ");R.length>=1&&(r=R[0].trim())}if(!n||n==="var(--text-color)"){const R=this.extractColorFromStyle(g);R&&!g.includes("background: black")&&(n=R)}c&&!g.includes("background: black")&&!g.includes("background:black")&&(c.includes("cc")||c.includes("CHOICE")||c.includes("choice")||c.includes("ï¼"))&&(l=c)}),!r){const S=e.textContent.trim().match(/^([^-]+)\s*-\s*íŒì •/);S&&(r=S[1].trim())}if(!l){const f=e.textContent.trim();if(a){const S=f.split(/íŒì •\s*/);S.length>1&&(l=S[1].trim())}l||(l=f)}if(l=l.replace(/^[^-]+-\s*íŒì •\s*/,"").trim(),!l)return null;const h=this.extractDiceRolls(l),d=this.extractStatusChanges(l);let i=l;if((h.length>0||d.length>0)&&(i=this.removeDiceCommands(l)),h.length>0&&!i.trim()){const f=h.some(g=>g.type==="judgement"),S=h.some(g=>g.type==="choice");f?i="* íŒì •":S?i="* ì„ íƒ":i="* ë‹¤ì´ìŠ¤"}d.length>0&&!i.trim()&&(i="* ìƒíƒœ ë³€í™”");const v=this.extractDXCombo(l);return v.length>0&&!i.trim()&&(v.length>1||v[0].effects&&v[0].effects.length>1?i="* ì½¤ë³´":i="* ì´í™íŠ¸"),[{id:`step_${s}_${o}`,type:"system",character:{name:r||"ì‹œìŠ¤í…œ",color:n,avatarUrl:null},text:this.cleanText(i),rawText:l,diceRolls:h,hasDice:h.length>0,statusChanges:d,hasStatusChange:d.length>0,dxCombos:v,hasDXCombo:v.length>0,effects:{sfx:null,bgm:null,background:null}}]}static collectCharactersFlat(e,s){e.querySelectorAll(".gap").forEach(t=>{const r=t.querySelector(".msg_container img"),n=t.querySelector("p");if(n){const l=n.querySelectorAll("span");let a="",h="var(--text-color)";if(l.forEach(d=>{var i;(d.style.fontWeight==="bold"||(i=d.getAttribute("style"))!=null&&i.includes("font-weight: bold"))&&(a||(a=d.textContent.trim(),h=this.extractColorFromStyle(d.getAttribute("style"))||"var(--text-color)"))}),a&&!s[a]){const d=r?r.getAttribute("src"):null;s[a]={id:`char_${Object.keys(s).length}`,name:a,color:h,avatarUrl:d,emotions:{default:d}}}}})}static extractColorFromStyle(e){if(!e)return null;const s=e.match(/color:\s*rgb\(([^)]+)\)/);if(s)return`rgb(${s[1]})`;const o=e.match(/color:\s*(#[0-9a-fA-F]{3,6})/);return o?o[1]:null}static extractColor(e){const s=e.getAttribute("style");if(s){const o=s.match(/color:\s*([^;]+)/);if(o)return o[1].trim()}return"var(--text-color)"}static extractDXCombo(e){const s=[],o=/(?:(\d+)[â†‘â†“])?\s*([^ã€Š\|]+?)?\s*ã€ŠC:([^ã€‹]+)ã€‹(?:\s*\|\s*([^\|]+)\s*\|\s*([^\|]+)\s*\|\s*(.+?))?(?:<br\s*\/?>|\n)?(?:\s*(\d+dx\d*(?:\+\d+)?)\s*\(([^)]+)\)\s*[ï¼>]\s*([^\sï¼>]+)\s*[ï¼>]\s*(\d+))?(?:<br\s*\/?>|$)/gim;let t;for(;(t=o.exec(e))!==null;){const l=t[1]?parseInt(t[1],10):null,a=t[2]?t[2].trim():"",h=t[3].trim(),d=t[4]?t[4].trim():"",i=t[5]?t[5].trim():"",v=t[6]?t[6].trim():"",m=t[7],f=t[8],S=t[9],g=t[10],c=[];if(h.split("+").forEach(x=>{const y=x.trim().match(/(.+?)\((\d+)\)/);y&&c.push({name:y[1].trim(),level:parseInt(y[2],10)})}),c.length>0){const x=d.split("/").map(D=>D.trim()),y=x[0]||"",p=x[1]||"",u=i.split("/").map(D=>D.trim()),T=(u[0]||"").replace(/^ë‹¤ì´ìŠ¤\s*/i,""),N=(u[1]||"").replace(/^í¬ë¦¬ì¹˜\s*/i,""),I=(u[2]||"").replace(/^ê³µê²©ë ¥\s*/i,""),q=(u[3]||"").replace(/^ì¹¨ì‹\s*/i,"");let A=null;m&&g&&(A={type:"dx3",formula:m.toUpperCase(),fullFormula:f,diceRolls:S,result:parseInt(g,10)}),s.push({type:"dx-combo",isSingleEffect:c.length===1,comboName:a,effects:c,erosionCost:l,timing:y,difficulty:p,dice:T,critical:N,attack:I,erosion:q,description:v,diceRoll:A,rawText:t[0]})}}const r=/ã€Š([^ã€‹]+)ã€‹\s*Lv(\d+)\s*\|\s*([^\|]+)\s*\|\s*([^\|]+)\s*\|\s*([^\|]+)\s*\|\s*([^\|]+)\s*\|\s*([^\|]+)(?:\s*\|\s*(.+?))?(?:<br\s*\/?>|\n)?(?:\s*(\d+dx\d*(?:\+\d+)?)\s*\(([^)]+)\)\s*[ï¼>]\s*([^\sï¼>]+)\s*[ï¼>]\s*(\d+))?(?:<br\s*\/?>|$)/gim;for(;(t=r.exec(e))!==null;){const l=t[1].trim(),a=parseInt(t[2],10),h=t[3].trim(),d=t[4].trim(),i=t[5].trim(),v=t[6].trim(),m=t[7].trim(),f=t[8]?t[8].trim():"",S=t[9],g=t[10],c=t[11],R=t[12];let x=null;S&&R&&(x={type:"dx3",formula:S.toUpperCase(),fullFormula:g,diceRolls:c,result:parseInt(R,10)}),s.push({type:"dx-effect",isSingleEffect:!0,effects:[{name:l,level:a}],timing:h,difficulty:d,target:i,range:v,description:m,erosion:f,diceRoll:x,rawText:t[0]})}const n=/(?:(\d+)[â†‘â†“])?\s*([^\|ã€Š]+?)?\s*(ã€Š[^ã€‹]+ã€‹(?:\s*\+\s*ã€Š[^ã€‹]+ã€‹)+)\s*(?:\|\s*([^\|]+)\s*\|\s*([^\|]+)\s*\|\s*(.+?))?(?:<br\s*\/?>|\n)?(?:\s*(\d+dx\d*(?:\+\d+)?)\s*\(([^)]+)\)\s*[ï¼>]\s*([^\sï¼>]+)\s*[ï¼>]\s*(\d+))?(?:<br\s*\/?>|$)/gim;for(;(t=n.exec(e))!==null;){const l=t[1]?parseInt(t[1],10):null,a=t[2]?t[2].trim():"",h=t[3],d=t[4]?t[4].trim():"",i=t[5]?t[5].trim():"",v=t[6]?t[6].trim():"",m=t[7],f=t[8],S=t[9],g=t[10],c=[],R=h.match(/ã€Š([^ã€‹]+)ã€‹/gi);R&&R.forEach(D=>{const F=D.match(/ã€Š(.+?)\((\d+)\)ã€‹/);F&&c.push({name:F[1].trim(),level:parseInt(F[2],10)})});const x=d.split("/").map(D=>D.trim()),y=x[0]||"",p=x[1]||"",u=i.split("/").map(D=>D.trim()),T=(u[0]||"").replace(/^ë‹¤ì´ìŠ¤\s*/i,""),N=(u[1]||"").replace(/^í¬ë¦¬ì¹˜\s*/i,""),I=(u[2]||"").replace(/^ê³µê²©ë ¥\s*/i,""),q=(u[3]||"").replace(/^ì¹¨ì‹\s*/i,"");let A=null;m&&g&&(A={type:"dx3",formula:m.toUpperCase(),fullFormula:f,diceRolls:S,result:parseInt(g,10)}),c.length>1&&s.push({type:"dx-combo",isSingleEffect:!1,comboName:a,effects:c,erosionCost:l,timing:y,difficulty:p,dice:T,critical:N,attack:I,erosion:q,description:v,diceRoll:A,rawText:t[0]})}return s}static extractStatusChanges(e){const s=[],o=/\[\s*([^\]]+)\s*\]\s*([^:ï¼š]+)\s*[ï¼š:]\s*(\d+)\s*[â†’>]\s*(\d+)/gi;let t;for(;(t=o.exec(e))!==null;){const r=t[1].trim(),n=t[2].trim(),l=parseInt(t[3],10),a=parseInt(t[4],10);s.push({characterName:r,statusName:n,oldValue:l,newValue:a,delta:a-l})}return s}static extractDiceRolls(e){const s=[],o=/(?:CHOICE|choice)\[([^\]]+)\]\([^)]+\)\s*[ï¼>]\s*(.+?)(?:<|$)/gi;let t;for(;(t=o.exec(e))!==null;){const a=t[1].split(",").map(d=>d.trim()),h=t[2].trim();s.push({type:"choice",options:a,result:h,formula:`CHOICE[${a.join(",")}]`})}const r=/(cc[<>=]+\d+)\s+(.+?)\((\d+[dD]\d+[<>=]+\d+)\)\s*.*?[ï¼>]\s*(\d+)(?:\s*[ï¼>]\s*\d+)*\s*[ï¼>]\s*(.+?)$/gi;for(;(t=r.exec(e))!==null;)s.push({type:"judgement",command:t[1],checkName:t[2].trim(),formula:t[3],result:parseInt(t[4],10),judgement:t[5].trim()});const n=/(\d+dx\d*(?:\+\d+)?)\s*\(([^)]+)\)\s*[ï¼>]\s*([^\sï¼>]+)\s*[ï¼>]\s*(\d+)/gi;for(;(t=n.exec(e))!==null;)s.push({type:"dx3",formula:t[1].toUpperCase(),fullFormula:t[2],diceRolls:t[3],result:parseInt(t[4],10)});const l=/(\d+[dD]\d+)\s*(?:\([^)]+\))?\s*[ï¼>]\s*(\d+)/gi;for(;(t=l.exec(e))!==null;)t[1].toLowerCase().includes("dx")||s.push({type:"normal",formula:t[1].toUpperCase(),result:parseInt(t[2],10)});return s}static cleanText(e){return e.replace(/<br\s*\/?>/gi,`
`).replace(/<[^>]+>/g,"").trim()}static removeDiceCommands(e){let s=e;return s=s.replace(/(?:CHOICE|choice)\[[^\]]+\]\([^)]+\)\s*[ï¼>]\s*.+?(?=<|$)/gi,""),s=s.replace(/(cc[<>=]+\d+)\s+(.*?)\((\d+D\d+[<>=]+\d+)\)\s*[^ï¼>]*?ï¼\s*\d+(?:\s*ï¼\s*\d+)*\s*ï¼\s*.+?$/gi,""),s=s.replace(/(\d+dx\d*(?:\+\d+)?)\s*\([^)]+\)\s*[ï¼>]\s*[^\sï¼>]+\s*[ï¼>]\s*\d+/gi,""),s=s.replace(/(\d+[dD]\d+)\s*(?:\([^)]+\))?\s*[ï¼>]\s*\d+/gi,""),s=s.replace(/\[\s*[^\]]+?\s*\]\s*[^:ï¼š\n]+?\s*[ï¼š:]\s*\d+\s*[â†’>]\s*\d+/g,""),s=s.replace(/ã€Š[^ã€‹]+ã€‹\s*Lv\d+\s*(?:\|[^\n<]*)+(?:(?:<br\s*\/?>\s*|\n)\d+dx\d*(?:\+\d+)?\s*\([^)]+\)\s*[ï¼>]\s*[^\sï¼>]+\s*[ï¼>]\s*\d+)?/gi,""),s=s.replace(/(?:\d+[â†‘â†“])?\s*[^\|ã€Š\n]*?\s*ã€Š[^ã€‹]+ã€‹(?:\s*\+\s*ã€Š[^ã€‹]+ã€‹)*\s*(?:\|[^\n<]*){0,3}(?:(?:<br\s*\/?>\s*|\n)\d+dx\d*(?:\+\d+)?\s*\([^)]+\)\s*[ï¼>]\s*[^\sï¼>]+\s*[ï¼>]\s*\d+)?/gi,""),s=s.replace(/ã€ŠC:[^ã€‹]+ã€‹(?:\s*\|[^\n<]*)*(?:(?:<br\s*\/?>\s*|\n)\d+dx\d*(?:\+\d+)?\s*\([^)]+\)\s*[ï¼>]\s*[^\sï¼>]+\s*[ï¼>]\s*\d+)?/gi,""),s=s.replace(/ã€Š[^ã€‹]+ã€‹(?:\s*\+\s*ã€Š[^ã€‹]+ã€‹)+(?:(?:<br\s*\/?>\s*|\n)\d+dx\d*(?:\+\d+)?\s*\([^)]+\)\s*[ï¼>]\s*[^\sï¼>]+\s*[ï¼>]\s*\d+)?/gi,""),s=s.replace(/^(<br\s*\/?>|\s)+$/gi,""),s.trim()}static parseTextLog(e){return console.warn("í”Œë ˆì¸ í…ìŠ¤íŠ¸ íŒŒì‹±ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."),{title:"í…ìŠ¤íŠ¸ ë¡œê·¸",scenes:[{id:"scene_0",name:"ë¡œê·¸",steps:[{id:"step_0_0",type:"narrator",character:{name:"",color:"#333"},text:e,rawText:e,diceRolls:[],hasDice:!1}]}],characters:{},handouts:[]}}static parseRoll20Log(e){console.log("[Roll20 Parser] Starting parse..."),console.log("[Roll20 Parser] Content length:",e.length);const o=new DOMParser().parseFromString(e,"text/html");console.log("[Roll20 Parser] DOM parsed, body exists:",!!o.body);const t=o.querySelector("title"),r=t?t.textContent.replace("Chat Log for ","").trim():"Roll20 ë¡œê·¸";console.log("[Roll20 Parser] Title:",r);const n={title:r,scenes:[],characters:{},handouts:[]},l={id:"scene_0",name:"ë¡œê·¸",description:null,steps:[]};let a=o.querySelectorAll("div.message");if(console.log(`[Roll20 Parser] Found ${a.length} messages with 'div.message'`),a.length===0){const i=o.querySelector(".content");console.log("[Roll20 Parser] Content container exists:",!!i),i&&(a=i.querySelectorAll(".message"),console.log(`[Roll20 Parser] Found ${a.length} messages inside .content`))}if(a.length===0){const i=o.querySelectorAll("div[class*='message']");console.log(`[Roll20 Parser] Found ${i.length} divs with 'message' in class`),a=i}let h=0,d=null;return a.forEach((i,v)=>{const m=this.parseRoll20Message(i,h,d);m?(console.log(`[Roll20 Parser] Step ${h}:`,m.character.name,"-",m.text.substring(0,50)),l.steps.push(m),m.character&&m.character.name&&!n.characters[m.character.name]&&(n.characters[m.character.name]={id:`char_${Object.keys(n.characters).length}`,name:m.character.name,color:m.character.color||"var(--text-color)",avatarUrl:m.character.avatarUrl||null,emotions:{default:m.character.avatarUrl||null}}),d=m.character,h++):console.log(`[Roll20 Parser] Skipped message ${v}: empty or invalid`)}),l.steps.length>0&&n.scenes.push(l),n}static parseRoll20Message(e,s,o=null){const t=e.classList;let r="dialogue";t.contains("desc")||t.contains("emote")?r="narrator":t.contains("rollresult")&&(r="system");const n=e.querySelector(".by");let l="",a=!1;n?(l=n.textContent.replace(":","").trim(),(l==="GM"||l.includes("(GM)"))&&(r="narrator",l="GM")):r!=="narrator"&&o?(l=o.name,a=!0):r==="narrator"&&(l="GM");const h=e.querySelector(".avatar img");let d=h?h.getAttribute("src"):null;d&&d.startsWith("/")&&(d="https://app.roll20.net"+d),a&&!d&&o&&o.avatarUrl&&(d=o.avatarUrl);const i=[];e.querySelectorAll("img").forEach(b=>{if(!b.closest(".avatar")){let w=b.getAttribute("src");const L=b.getAttribute("alt")||"";w&&(w.startsWith("/")&&(w="https://app.roll20.net"+w),i.push({url:w,alt:L}))}});let m="",f=[],S=[],g=[];const c=e.querySelector(".sheet-rolltemplate-coc, .sheet-rolltemplate-coc-1");if(c){const b=this.parseRoll20DiceTemplate(c);b&&(f.push(b),m="* íŒì •")}e.querySelectorAll("[class*='sheet-rolltemplate-']").forEach(b=>{if(!b.classList.contains("sheet-rolltemplate-coc")&&!b.classList.contains("sheet-rolltemplate-coc-1")&&!b.classList.contains("sheet-rolltemplate-Dx3Dice")){const w=this.parseRoll20TableTemplate(b);w&&(m||(m=w.html))}});const x=e.querySelector(".sheet-rolltemplate-Dx3Dice");x&&(m=`<div class="roll20-dx3-template">${x.outerHTML}</div>`);let y=null;const p=/<strong>([^<]+)<\/strong>\s*\/\s*<span[^>]*>(\d*)<\/span>\s*<span[^>]*>\s*â†’\s*<\/span>\s*<b>(\d*)<\/b>/;let u=e.innerHTML.match(p);if(u){const b=u[1].trim(),w=u[2]?parseInt(u[2],10):null,L=u[3]?parseInt(u[3],10):null;if(y=u[0],w!==null||L!==null){const $=(L||0)-(w||0);g.push({characterName:l,statusName:b,oldValue:w,newValue:L,delta:$})}}else{e.textContent;const b=/(ì¹¨ì‹ë¥ |HP|MP|SAN|æ­£æ°—åº¦|ä¾µè•ç‡)\s*<span[^>]*inlinerollresult[^>]*>(\d+)<\/span>\s*(ìƒìŠ¹|í•˜ê°•|ì¦ê°€|ê°ì†Œ|ä¸Šæ˜‡|æ¸›å°‘)/i;if(u=e.innerHTML.match(b),u){const w=u[1].trim(),L=parseInt(u[2],10),J=u[3].match(/ìƒìŠ¹|ì¦ê°€|ä¸Šæ˜‡/)?L:-L;y=u[0],g.push({characterName:l,statusName:w,oldValue:null,newValue:null,delta:J})}}const T=e.querySelectorAll(".inlinerollresult");T.length>0&&!c&&!x&&!u&&T.forEach(b=>{const w=b.getAttribute("title"),L=b.textContent.trim();if(w&&L){const $=w.match(/Rolling\s+([^\s=]+)/i);$&&f.push({type:"inline",formula:$[1].toUpperCase(),result:parseInt(L,10)||L})}});const N=e.cloneNode(!0);[".by",".tstamp",".avatar",".spacer",".flyout","[class*='sheet-rolltemplate']"].forEach(b=>{N.querySelectorAll(b).forEach(L=>L.remove())}),N.querySelectorAll("a").forEach(b=>{b.querySelector("img")&&b.remove()}),N.querySelectorAll(".inlinerollresult").forEach(b=>{b.removeAttribute("title"),b.removeAttribute("original-title"),b.className="inlinerollresult"});let D=N.innerHTML.trim();y&&(D=D.replace(y,"")),D=D.replace(/<br\s*\/?>/gi," "),D=D.replace(/<div>/gi," "),D=D.replace(/<\/div>/gi,"");const F=document.createElement("div");F.innerHTML=D;let E=D,M=F.textContent.trim();if(l&&M.startsWith(l)){const b=l.length;M=M.substring(b).trim(),E=E.replace(new RegExp(`^${l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}`),"").trim()}return M.startsWith(":")&&(M=M.substring(1).trim(),E=E.replace(/^:\s*/,"")),M&&M!==m&&(m=E||M),!m&&i.length===0?null:(e.querySelector("em")&&(m=m),{id:`step_0_${s}`,type:r,character:{name:l||"ì•Œ ìˆ˜ ì—†ìŒ",color:"var(--text-color)",avatarUrl:d},text:m||"",rawText:m,diceRolls:f,hasDice:f.length>0,statusChanges:g,hasStatusChange:g.length>0,dxCombos:S,hasDXCombo:S.length>0,illustrations:i,hasIllustration:i.length>0,effects:{sfx:null,bgm:null,background:null,backgroundOpacity:.3}})}static parseRoll20DiceTemplate(e){var s;try{const o=(s=e.querySelector("caption"))==null?void 0:s.textContent.trim(),t=e.querySelectorAll("tr");let r=null,n=null,l=null,a=null;if(t.forEach(h=>{var v;const d=(v=h.querySelector(".sheet-template_label"))==null?void 0:v.textContent.trim(),i=h.querySelector(".sheet-template_value");if(d&&i){const m=i.textContent.trim();if(d.includes("ê¸°ì¤€ì¹˜")||d.includes("value")){const f=m.split("/");r=parseInt(f[0],10)}else if(d.includes("êµ´ë¦¼")||d.includes("rolled")){const f=m.match(/\d+/);f&&(n=parseInt(f[0],10));const S=m.match(/\d+/g);S&&S.length>1&&(a=S.slice(1).map(g=>parseInt(g,10)))}else(d.includes("íŒì •ê²°ê³¼")||d.includes("result")||d.includes("íŒì •"))&&(l=m)}}),n!==null){const h={type:"judgement",checkName:o||"íŒì •",formula:r?`1D100<=${r}`:"1D100",threshold:r||100,result:n,judgement:l||"ì•Œ ìˆ˜ ì—†ìŒ"};return a&&a.length>0&&(h.bonusDice=a),h}}catch(o){console.error("Roll20 ë‹¤ì´ìŠ¤ í…œí”Œë¦¿ íŒŒì‹± ì˜¤ë¥˜:",o)}return null}static parseRoll20DX3Template(e){var s,o,t,r,n;try{const l=(s=e.querySelector(".sheet-chname"))==null?void 0:s.textContent.trim(),a=(o=e.querySelector(".sheet-title"))==null?void 0:o.textContent.trim(),h=(t=e.querySelector(".sheet-sub-title"))==null?void 0:t.textContent.trim(),d=(r=e.querySelector(".sheet-mid-title"))==null?void 0:r.textContent.trim(),i=(n=e.querySelector(".sheet-descript"))==null?void 0:n.textContent.trim();let v=null,m=null,f=null;const S=e.querySelector(".sheet-dicearea");if(S){const y=S.querySelector(".inlinerollresult");if(y){v=parseInt(y.textContent.trim(),10);const p=e.querySelector(".sheet-sub-title .inlinerollresult");if(p){const u=p.getAttribute("title");(u==null?void 0:u.match(/Rolling\s+\d+\s*=\s*(\d+)/i))&&(m=h.trim())}}}const g=e.querySelector(".sheet-dicedetail .inlinerollresult");g&&(f=g.textContent.trim());const c={};return e.querySelectorAll(".sheet-info p, .sheet-info span").forEach(y=>{const p=y.querySelector("strong");if(p){const u=p.textContent.trim(),T=y.textContent.replace(p.textContent,"").trim();u==="íƒ€ì´ë°"?c.timing=T:u==="ë‚œì´ë„"?c.difficulty=T:u==="ëŒ€ìƒ"?c.target=T:u==="ì‚¬ê±°ë¦¬"?c.range=T:u==="ê³µê²©ë ¥"?c.attack=T:u==="ì¹¨ì‹ì¹˜"||u==="ì¹¨ì‹ë¥ "?c.erosion=T:u==="Lv"?c.level=T:u==="ê¸°ëŠ¥"&&(c.spec=T)}}),{type:"dx-effect",isSingleEffect:!0,characterName:l,effectName:a,comboName:d||null,effects:[{name:a,level:c.level?parseInt(c.level,10):null}],timing:c.timing||"",difficulty:c.difficulty||"",target:c.target||"",range:c.range||"",attack:c.attack||"",erosion:c.erosion||"",spec:c.spec||"",description:i||"",diceRoll:v?{type:"dx3",formula:m||"",result:v,detail:f||""}:null}}catch(l){console.error("Roll20 DX3 í…œí”Œë¦¿ íŒŒì‹± ì˜¤ë¥˜:",l)}return null}static parseRoll20TableTemplate(e){var s;try{const o=(s=e.querySelector("caption"))==null?void 0:s.textContent.trim(),t=e.querySelector("table");if(!t)return null;let r='<div class="roll20-table">';return o&&(r+=`<div class="table-caption"><strong>${o}</strong></div>`),r+="<table>",t.querySelectorAll("tr").forEach(l=>{const a=l.querySelectorAll("td");a.length>0&&(r+="<tr>",a.forEach(h=>{const d=h.querySelector(".inlinerollresult");let i=h.innerHTML;i=i.replace(/<span[^>]*>/gi,""),i=i.replace(/<\/span>/gi,""),r+=`<td>${i}</td>`}),r+="</tr>")}),r+="</table></div>",{type:"table",caption:o,html:r}}catch(o){console.error("Roll20 í…Œì´ë¸” í…œí”Œë¦¿ íŒŒì‹± ì˜¤ë¥˜:",o)}return null}static parse(e,s=null,o="auto"){if(!e)throw new Error("ë¡œê·¸ ë‚´ìš©ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");let t;if(o==="roll20")console.log("[Parser] ê°•ì œ Roll20 ëª¨ë“œ"),t=this.parseRoll20Log(e);else if(o==="cocofolia")console.log("[Parser] ê°•ì œ Cocofolia ëª¨ë“œ"),t=this.parseHTMLLog(e);else if(o==="auto")if(console.log("[Parser] ìë™ ê°ì§€ ëª¨ë“œ"),e.trim().startsWith("<!DOCTYPE html")||e.trim().startsWith("<html"))e.includes('class="message"')&&(e.includes('class="sheet-rolltemplate')||e.includes('class="by"')||e.includes("Chat Log for"))?(console.log("[Parser] Roll20 ë¡œê·¸ ê°ì§€"),t=this.parseRoll20Log(e)):e.includes('<div class="cclog_wrap"')||e.includes('<div class="ccfolia_wrap"')||e.includes('<div class="gap"')?(console.log("[Parser] Cocofolia ë¡œê·¸ ê°ì§€"),t=this.parseHTMLLog(e)):(console.log("[Parser] ê¸°ë³¸ HTML íŒŒì„œ ì‚¬ìš©"),t=this.parseHTMLLog(e));else if(e.trim().startsWith("{")||e.trim().startsWith("[")){console.log("[Parser] JSON í˜•ì‹ ê°ì§€");try{t=JSON.parse(e)}catch(r){throw new Error("JSON íŒŒì‹± ì‹¤íŒ¨: "+r.message)}}else console.log("[Parser] í”Œë ˆì¸ í…ìŠ¤íŠ¸ë¡œ ì²˜ë¦¬"),t=this.parseTextLog(e);if(t.fileCode=this.generateFileCode(e),s){const r=s.replace(/\.(txt|log|json|html)$/i,"");t.title=r||t.title,t.fileName=s}return t}static generateFileCode(e){let s=0;for(let o=0;o<e.length;o++){const t=e.charCodeAt(o);s=(s<<5)-s+t,s=s&s}return"file_"+Math.abs(s).toString(36)+"_"+e.length}}const G={name:"Home",setup(){return{logStore:V()}},data(){return{isLoading:!1,errorMessage:"",parserMode:"cocofolia"}},methods:{triggerFileInput(){this.$refs.fileInput.click()},triggerJSONInput(){this.$refs.jsonInput.click()},handleJSONSelect(k){const e=k.target.files[0];if(!e)return;if(!e.name.endsWith(".json")){this.errorMessage="JSON íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.";return}this.isLoading=!0,this.errorMessage="";const s=new FileReader;s.onload=o=>{try{const t=o.target.result,r=JSON.parse(t);if(!r.scenes||!Array.isArray(r.scenes))throw new Error("ìœ íš¨í•˜ì§€ ì•Šì€ VN ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.");console.log("[Home] JSON ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ:",{title:r.title,sceneCount:r.scenes.length}),this.logStore.setRawLog(JSON.stringify(r)),this.logStore.setVNData(r),this.logStore.resetPlayback(),this.$router.push("/player")}catch(t){console.error("[Home] JSON íŒŒì‹± ì˜¤ë¥˜:",t),this.errorMessage=`JSON íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${t.message}`}finally{this.isLoading=!1}},s.onerror=()=>{this.errorMessage="íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",this.isLoading=!1},s.readAsText(e)},async handleFileSelect(k){const e=k.target.files[0];if(!e)return;this.isLoading=!0,this.errorMessage="";const s=new FileReader;s.onload=o=>{var t,r;try{const n=o.target.result;console.log("[Home] íŒŒì¼ ì½ê¸° ì™„ë£Œ:",{fileName:e.name,fileSize:n.length,parserMode:this.parserMode,contentPreview:n.substring(0,200)}),this.logStore.setRawLog(n);const l=z.parse(n,e.name,this.parserMode);if(console.log("[Home] íŒŒì‹± ì™„ë£Œ:",{title:l.title,sceneCount:((t=l.scenes)==null?void 0:t.length)||0,characterCount:Object.keys(l.characters||{}).length,firstScene:(r=l.scenes)==null?void 0:r[0]}),!l.scenes||l.scenes.length===0)throw new Error("íŒŒì‹±ëœ ì”¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");this.logStore.setVNData(l),console.log("[Home] logStoreì— ë°ì´í„° ì €ì¥ ì™„ë£Œ, PlayerViewë¡œ ì´ë™"),this.$refs.fileInput.value="",this.$router.push("/player")}catch(n){console.error("[Home] íŒŒì‹± ì˜¤ë¥˜:",n),this.errorMessage=`íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨: ${n.message}`,this.$refs.fileInput.value=""}finally{this.isLoading=!1}},s.onerror=()=>{this.errorMessage="íŒŒì¼ ì½ê¸° ì‹¤íŒ¨",this.isLoading=!1,this.$refs.fileInput.value=""},s.readAsText(e)}}},Y={class:"home"},K={class:"container"},Q={class:"header"},Z={class:"parser-mode-section"},ee={class:"mode-buttons"},te={class:"upload-section"},se={class:"upload-card"},le=["disabled"],re={key:0,class:"error-message"},oe={class:"upload-card"},ne=["disabled"];function ce(k,e,s,o,t,r){const n=X("EmojiToIcon");return U(),_("div",Y,[C("div",K,[C("header",Q,[C("h1",null,[P(n,{emoji:"ğŸ“–",size:40}),e[6]||(e[6]=H(" VNLog Player (v0.5) ",-1))]),e[7]||(e[7]=C("p",{class:"subtitle"},"TRPG ë¡œê·¸ë¥¼ ë¹„ì£¼ì–¼ ë…¸ë²¨ë¡œ ì¬ìƒí•˜ì„¸ìš”",-1)),e[8]||(e[8]=C("small",null,"(2025.11.19 15:28) ì €ì¥ & ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥ ì¶”ê°€, ìë™ì¬ìƒ ì†ë„ ê°œì„ ",-1)),e[9]||(e[9]=C("small",null,"(2025.11.20 09:45) ëª¨ë°”ì¼ ì§€ì› ì¶”ê°€ ë° ìë™ì¬ìƒ ë²„ê·¸ ìˆ˜ì •",-1)),e[10]||(e[10]=C("small",null,"(2025.11.20 11:39) ë¡œê·¸ í¸ì§‘ ëª¨ë“œ ì¶”ê°€ ë° ìì˜í•œ ë²„ê·¸ ê°œì„ ",-1))]),C("div",Z,[e[15]||(e[15]=C("h2",null,"íŒŒì„œ ëª¨ë“œ ì„ íƒ",-1)),C("div",ee,[C("button",{class:j(["mode-button",{active:t.parserMode==="cocofolia"}]),onClick:e[0]||(e[0]=l=>t.parserMode="cocofolia")},[P(n,{emoji:"ğŸ¦",size:24}),e[11]||(e[11]=C("span",null,"Cocolog",-1)),e[12]||(e[12]=C("small",null,"ì½”ì½”ë¡œê·¸ í˜•ì‹ .html",-1))],2),C("button",{class:j(["mode-button",{active:t.parserMode==="roll20"}]),onClick:e[1]||(e[1]=l=>t.parserMode="roll20")},[P(n,{emoji:"ğŸ²",size:24}),e[13]||(e[13]=C("span",null,"Roll20",-1)),e[14]||(e[14]=C("small",null,"Roll20 ì±„íŒ… ë¡œê·¸ .html",-1))],2)])]),C("div",te,[C("div",se,[P(n,{emoji:"ğŸ“",size:48,class:"upload-icon"}),e[16]||(e[16]=C("h2",null,"ë¡œê·¸ íŒŒì¼ ì—…ë¡œë“œ",-1)),e[17]||(e[17]=C("p",null,"HTML ë¡œê·¸ íŒŒì¼ì„ ì„ íƒí•˜ì—¬ íŒŒì‹±í•©ë‹ˆë‹¤",-1)),C("input",{ref:"fileInput",type:"file",accept:".txt,.log,.html",onChange:e[2]||(e[2]=(...l)=>r.handleFileSelect&&r.handleFileSelect(...l)),class:"file-input"},null,544),C("button",{onClick:e[3]||(e[3]=(...l)=>r.triggerFileInput&&r.triggerFileInput(...l)),class:"upload-button",disabled:t.isLoading},[P(n,{emoji:"ğŸ“¤",size:20}),H(" "+O(t.isLoading?"ì²˜ë¦¬ ì¤‘...":"íŒŒì¼ ì„ íƒ"),1)],8,le),t.errorMessage?(U(),_("p",re,O(t.errorMessage),1)):B("",!0)]),e[20]||(e[20]=C("div",{class:"upload-divider"},[C("span",null,"ë˜ëŠ”")],-1)),C("div",oe,[P(n,{emoji:"ğŸ’»",size:48,class:"upload-icon"}),e[18]||(e[18]=C("h2",null,"JSON íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°",-1)),e[19]||(e[19]=C("p",null,"í¸ì§‘ëœ VN ë°ì´í„°ë¥¼ ì§ì ‘ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤ (íŒŒì‹± ìƒëµ)",-1)),C("input",{ref:"jsonInput",type:"file",accept:".json",onChange:e[4]||(e[4]=(...l)=>r.handleJSONSelect&&r.handleJSONSelect(...l)),class:"file-input"},null,544),C("button",{onClick:e[5]||(e[5]=(...l)=>r.triggerJSONInput&&r.triggerJSONInput(...l)),class:"upload-button json-button",disabled:t.isLoading},[P(n,{emoji:"ğŸ“¦",size:20}),H(" "+O(t.isLoading?"ì²˜ë¦¬ ì¤‘...":"JSON ì„ íƒ"),1)],8,ne)])])])])}const me=W(G,[["render",ce],["__scopeId","data-v-88fec6e1"]]);export{me as default};
