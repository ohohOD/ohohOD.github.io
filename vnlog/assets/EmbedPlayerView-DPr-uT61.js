import{u as w}from"./logStore-DnJZj5Zw.js";import{B as A,D as O,a as E,P as T,C as k,b as N}from"./BGMPlayer-MY3siSnV.js";import{_,c as h,a as n,g as S,f as c,d as u,n as M,r as d,t as y,h as b,w as v,T as f,o as a,l as I}from"./index-Dzor8hNl.js";const B={name:"EmbedPlayerView",components:{DialogBox:N,CharacterDisplay:k,PlaybackControls:T,DiceRoll:E,DXCombo:O,BGMPlayer:A},setup(){return{logStore:w()}},data(){return{isLoading:!0,loadingMessage:"Î°úÍ∑∏Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...",loadError:null,autoPlayTimer:null,typingSpeed:50,theaterMode:!1,autoPlaySpeed:1,bgmSettings:{url:"",type:"youtube",volume:.5,autoPlay:!1},showDiceOverlay:!1,currentDiceRolls:[],diceCharacterName:"",diceCharacterColor:"#ffffff",diceOverlayTimer:null,showComboOverlay:!1,currentDXCombos:[],comboCharacterName:"",comboCharacterColor:"#ffffff",comboOverlayTimer:null,showSceneDescription:!1,sceneDescriptionData:null,sceneDescriptionTimer:null,sfxAudio:null,currentBackground:null,previousBgmUrl:null,isMobile:!1}},computed:{logTitle(){var e;return((e=this.logStore.vnData)==null?void 0:e.title)||"VN Log Player"},currentScene(){var r,i;const e=((r=this.logStore.vnData)==null?void 0:r.scenes)||[],t=((i=this.logStore.playback)==null?void 0:i.currentSceneIndex)||0;return e[t]||null},currentStep(){return this.logStore.currentStep},hasNextStep(){return this.logStore.hasNextStep},hasPreviousStep(){return this.logStore.hasPreviousStep},autoPlayEnabled(){var e;return((e=this.logStore.playback)==null?void 0:e.autoPlayEnabled)||!1},currentStepNumber(){var s,o,p,g;let e=0;const t=((s=this.logStore.vnData)==null?void 0:s.scenes)||[],r=((o=this.logStore.playback)==null?void 0:o.currentSceneIndex)||0,i=((p=this.logStore.playback)==null?void 0:p.currentStepIndex)||0;for(let m=0;m<r;m++)e+=((g=t[m])==null?void 0:g.steps.length)||0;return e+=i+1,e},totalSteps(){var t;return(((t=this.logStore.vnData)==null?void 0:t.scenes)||[]).reduce((r,i)=>{var s;return r+(((s=i==null?void 0:i.steps)==null?void 0:s.length)||0)},0)},currentSceneName(){const e=this.logStore.currentScene;return(e==null?void 0:e.name)||""},hasActiveOverlay(){return this.showDiceOverlay||this.showComboOverlay||this.showSceneDescription}},methods:{async loadExternalJSON(e){this.isLoading=!0,this.loadingMessage="JSON ÌååÏùºÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...",this.loadError=null;try{console.log("[EmbedPlayerView] Ïô∏Î∂Ä JSON Î°úÎìú ÏãúÎèÑ:",e);const t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const r=await t.text();if(!r||r.trim()==="")throw new Error("Îπà ÌååÏùºÏûÖÎãàÎã§.");console.log("[EmbedPlayerView] JSON Î°úÎìú ÏôÑÎ£å, ÌååÏã± ÏãúÏûë");const i=JSON.parse(r);let s,o=null;if(i.vnData&&i.version?(s=i.vnData,o=i.theme,console.log("[EmbedPlayerView] ÌÖåÎßà ÏÑ§Ï†ï Î∞úÍ≤¨:",o)):(s=i,console.log("[EmbedPlayerView] Íµ¨ ÌòïÏãù JSON (ÌÖåÎßà ÏóÜÏùå)")),!s||!s.scenes||s.scenes.length===0)throw new Error("Ïú†Ìö®Ìïú VN Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. JSON ÌååÏùºÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.");this.logStore.rawLog=JSON.stringify(s),this.logStore.vnData=s,this.logStore.playback.currentSceneIndex=0,this.logStore.playback.currentStepIndex=0,o&&this.applyThemeSettings(o),console.log("[EmbedPlayerView] ÌååÏã± ÏôÑÎ£å:",{title:s.title,sceneCount:s.scenes.length,totalSteps:this.totalSteps}),this.isLoading=!1,this.loadingMessage="",this.$nextTick(()=>{this.applyStepEffects(),this.showOverlaysIfPresent()})}catch(t){console.error("[EmbedPlayerView] JSON Î°úÎìú Ïã§Ìå®:",t),this.loadError=t.message,this.loadingMessage=`Î°úÎìú Ïã§Ìå®: ${t.message}`,this.isLoading=!1}},detectDevice(){const e=navigator.userAgent.toLowerCase(),t=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(e),r="ontouchstart"in window||navigator.maxTouchPoints>0,s=window.innerWidth<=767;this.isMobile=t&&s||r&&s,this.isMobile&&(this.typingSpeed=30)},getCharacterName(e){return e.type==="system"?e.character.name||"ÏãúÏä§ÌÖú":e.type==="narrator"?"":e.character.name},handleAdvance(){this.hasNextStep?this.nextStep():this.autoPlayEnabled&&this.logStore.toggleAutoPlay()},handleTypingComplete(){},onSceneChange(){this.showDiceOverlay=!1,this.showComboOverlay=!1,this.stopSceneDescriptionAutoAdvance(),this.stopDiceOverlayAutoClose(),this.stopComboOverlayAutoClose(),this.displaySceneDescriptionIfPresent()},displaySceneDescriptionIfPresent(){if(!this.currentScene)return;const e=this.currentScene.steps[0];e&&e.type==="scene-description"&&(this.sceneDescriptionData={number:e.sceneNumber,title:e.sceneTitle,pcs:e.scenePCs,description:e.sceneDescription,fullText:e.text},this.showSceneDescription=!0,this.autoPlayEnabled&&this.startSceneDescriptionAutoAdvance())},closeSceneDescription(){this.showSceneDescription=!1;const e=this.sceneDescriptionTimer!==null;this.stopSceneDescriptionAutoAdvance(),!e&&this.autoPlayEnabled&&this.hasNextStep&&setTimeout(()=>{this.nextStep()},500)},startSceneDescriptionAutoAdvance(){this.stopSceneDescriptionAutoAdvance(),this.sceneDescriptionTimer=setTimeout(()=>{this.closeSceneDescription(),this.autoPlayEnabled&&(this.hasNextStep?this.nextStep():this.logStore.toggleAutoPlay())},3e3/this.autoPlaySpeed)},stopSceneDescriptionAutoAdvance(){this.sceneDescriptionTimer&&(clearTimeout(this.sceneDescriptionTimer),this.sceneDescriptionTimer=null)},nextStep(){const e=this.logStore.playback.currentSceneIndex;this.logStore.nextStep();const t=this.logStore.playback.currentSceneIndex;e!==t&&this.onSceneChange(),this.applyStepEffects(),this.showOverlaysIfPresent()},previousStep(){const e=this.logStore.playback.currentSceneIndex;this.logStore.previousStep();const t=this.logStore.playback.currentSceneIndex;e!==t&&this.onSceneChange(),this.applyStepEffects(),this.showOverlaysIfPresent()},showOverlaysIfPresent(){if(this.currentStep&&this.currentStep.type==="scene-description"){this.sceneDescriptionData={number:this.currentStep.sceneNumber,title:this.currentStep.sceneTitle,pcs:this.currentStep.scenePCs,description:this.currentStep.sceneDescription,fullText:this.currentStep.text},this.showSceneDescription=!0,this.autoPlayEnabled&&this.startSceneDescriptionAutoAdvance();return}const e=this.currentStep&&this.currentStep.diceRolls&&this.currentStep.diceRolls.length>0,t=this.currentStep&&this.currentStep.ougis&&this.currentStep.ougis.length>0,r=this.currentStep&&this.currentStep.shinobigamis&&this.currentStep.shinobigamis.length>0,i=this.currentStep&&this.currentStep.dxCombos&&this.currentStep.dxCombos.length>0;if(e||t||r){const s=[...this.currentStep.ougis||[],...this.currentStep.shinobigamis||[],...this.currentStep.diceRolls||[]];this.currentDiceRolls=s,this.diceCharacterName=this.getCharacterName(this.currentStep),this.diceCharacterColor=this.currentStep.character.color,this.showDiceOverlay=!0,this.autoPlayEnabled&&this.startDiceOverlayAutoClose();return}i&&(this.currentDXCombos=this.currentStep.dxCombos,this.comboCharacterName=this.getCharacterName(this.currentStep),this.comboCharacterColor=this.currentStep.character.color,this.showComboOverlay=!0,this.autoPlayEnabled&&this.startComboOverlayAutoClose())},closeDiceOverlay(){this.showDiceOverlay=!1;const e=this.diceOverlayTimer!==null;this.stopDiceOverlayAutoClose(),!e&&this.autoPlayEnabled&&this.hasNextStep&&setTimeout(()=>{this.nextStep()},500)},startDiceOverlayAutoClose(){this.stopDiceOverlayAutoClose(),this.diceOverlayTimer=setTimeout(()=>{this.closeDiceOverlay(),this.autoPlayEnabled&&this.hasNextStep&&this.nextStep()},3e3/this.autoPlaySpeed)},stopDiceOverlayAutoClose(){this.diceOverlayTimer&&(clearTimeout(this.diceOverlayTimer),this.diceOverlayTimer=null)},closeComboOverlay(){this.showComboOverlay=!1;const e=this.comboOverlayTimer!==null;this.stopComboOverlayAutoClose(),!e&&this.autoPlayEnabled&&this.hasNextStep&&setTimeout(()=>{this.nextStep()},500)},startComboOverlayAutoClose(){this.stopComboOverlayAutoClose(),this.comboOverlayTimer=setTimeout(()=>{this.closeComboOverlay(),this.autoPlayEnabled&&this.hasNextStep&&this.nextStep()},3e3/this.autoPlaySpeed)},stopComboOverlayAutoClose(){this.comboOverlayTimer&&(clearTimeout(this.comboOverlayTimer),this.comboOverlayTimer=null)},toggleAutoPlay(){const e=this.autoPlayEnabled;this.logStore.toggleAutoPlay(),!e&&this.autoPlayEnabled&&this.hasActiveOverlay},toggleTheaterMode(){this.theaterMode=!this.theaterMode,this.theaterMode&&!this.autoPlayEnabled&&(this.logStore.toggleAutoPlay(),!this.hasActiveOverlay&&this.hasNextStep&&this.nextStep())},handleTheaterModeClick(e){if(this.theaterMode){if(e.target.closest("button")||e.target.closest(".dialog-box"))return;this.theaterMode=!1}},changeAutoPlaySpeed(e){this.autoPlaySpeed=e},applyStepEffects(){if(!this.currentStep)return;const e=this.currentStep.effects;e!=null&&e.sfx&&this.playSFX(e.sfx);const t=(e==null?void 0:e.bgm)||null;if(t!==this.previousBgmUrl&&(t&&this.changeBGM(t),this.previousBgmUrl=t),e!=null&&e.background){const r=e.backgroundOpacity??.3;this.changeBackground(e.background,r)}},async playSFX(e){if(!(!e||!e.trim()))try{let t=e.trim();if(t.includes("youtube.com")||t.includes("youtu.be")){console.warn("[EmbedPlayerView] YouTube Ìö®Í≥ºÏùåÏùÄ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.");return}if(t.includes("drive.google.com")||t.includes("docs.google.com")){let i=null;const s=t.match(/\/file\/d\/([^\/\?]+)/);s&&(i=s[1]);const o=t.match(/[?&]id=([^&]+)/);o&&(i=o[1]),i&&(t=`https://docs.google.com/uc?export=download&id=${i}`)}const r=new Audio(t);r.volume=.7,r.loop=!1,r.addEventListener("ended",()=>{r.src="",this.sfxAudio===r&&(this.sfxAudio=null)}),await r.play(),this.sfxAudio=r}catch(t){console.error("[EmbedPlayerView] Ìö®Í≥ºÏùå Ïû¨ÏÉù Ïã§Ìå®:",t)}},changeBGM(e){const t=e.includes("youtube.com")||e.includes("youtu.be");this.bgmSettings={url:e,type:t?"youtube":"audio",volume:this.bgmSettings.volume||.5,autoPlay:!0}},changeBackground(e,t=.3){this.currentBackground=e;const r=`linear-gradient(rgba(0, 0, 0, ${1-t}), rgba(0, 0, 0, ${1-t}))`;document.documentElement.style.setProperty("--bg-image",`${r}, url(${e})`),document.documentElement.style.setProperty("--bg-image-size","cover")},applyThemeSettings(e){if(!e)return;console.log("[EmbedPlayerView] ÌÖåÎßà Ï†ÅÏö© ÏãúÏûë:",e);const t=document.documentElement;if(e.primaryColor&&t.style.setProperty("--primary-color",e.primaryColor),e.textColor&&t.style.setProperty("--text-color",e.textColor),e.bgColor&&t.style.setProperty("--bg-color",e.bgColor),e.bgSecondary&&t.style.setProperty("--bg-secondary",e.bgSecondary),e.borderColor&&t.style.setProperty("--border-color",e.borderColor),e.fontFamily&&(t.style.setProperty("--font-pretendard",e.fontFamily),document.body.style.fontFamily=e.fontFamily),e.bgImageUrl){const r=e.bgImageOpacity??.3,i=`linear-gradient(rgba(0, 0, 0, ${1-r}), rgba(0, 0, 0, ${1-r}))`;t.style.setProperty("--bg-image",`${i}, url(${e.bgImageUrl})`),t.style.setProperty("--bg-image-size",e.bgImageSize||"cover")}e.bgmUrl&&(this.bgmSettings={url:e.bgmUrl,type:e.bgmType||"youtube",volume:e.bgmVolume||.5,autoPlay:e.bgmAutoPlay||!1}),console.log("[EmbedPlayerView] ÌÖåÎßà Ï†ÅÏö© ÏôÑÎ£å")},handleKeyPress(e){if(!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"))switch(e.key){case" ":case"Enter":e.preventDefault(),this.handleAdvance();break;case"ArrowLeft":e.preventDefault(),this.hasPreviousStep&&this.previousStep();break;case"ArrowRight":e.preventDefault(),this.hasNextStep&&this.nextStep();break}}},async mounted(){this.detectDevice(),window.addEventListener("resize",this.detectDevice),window.addEventListener("keydown",this.handleKeyPress);const e=new URLSearchParams(window.location.search),t=e.get("json"),r=e.get("autoplay")==="true";if(!t){this.loadingMessage="Ïò§Î•ò: JSON URLÏù¥ Ï†úÍ≥µÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.",this.loadError="json ÏøºÎ¶¨ ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§.",console.error("[EmbedPlayerView] json ÏøºÎ¶¨ ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.");return}await this.loadExternalJSON(t),r&&!this.loadError&&this.logStore.toggleAutoPlay()},beforeUnmount(){this.stopSceneDescriptionAutoAdvance(),this.stopDiceOverlayAutoClose(),this.stopComboOverlayAutoClose(),window.removeEventListener("keydown",this.handleKeyPress),window.removeEventListener("resize",this.detectDevice),this.sfxAudio&&(this.sfxAudio.pause(),this.sfxAudio=null),this.currentBackground&&(document.documentElement.style.removeProperty("--bg-image"),document.documentElement.style.removeProperty("--bg-image-size"));const e=document.documentElement;e.style.removeProperty("--primary-color"),e.style.removeProperty("--text-color"),e.style.removeProperty("--bg-color"),e.style.removeProperty("--bg-secondary"),e.style.removeProperty("--border-color")}},V={class:"player-container"},L={class:"embed-logo"},R={class:"embed-title"},U={class:"header-buttons"},z=["title"],j={class:"player-stage"},J={key:1,class:"dialog-wrapper"},X={key:1,class:"dialog-placeholder"},F={class:"dice-overlay-hint"},G={class:"combo-overlay-header"},W={class:"combo-character-info"},K={class:"dice-overlay-hint"},Y={class:"scene-description-content"},H={class:"scene-description-header"},q={class:"scene-number"},Q={class:"scene-title"},Z={key:0,class:"scene-pcs"},$={class:"scene-pcs-value"},ee={key:1,class:"scene-description-text"};function te(e,t,r,i,s,o){const p=d("EmojiToIcon"),g=d("CharacterDisplay"),m=d("DialogBox"),C=d("DiceRoll"),D=d("DXCombo"),P=d("PlaybackControls"),x=d("BGMPlayer");return a(),h("div",{class:"embed-player-view",onClick:t[6]||(t[6]=(...l)=>o.handleTheaterModeClick&&o.handleTheaterModeClick(...l))},[n("div",V,[n("div",{class:M(["player-header",{"theater-mode":s.theaterMode}])},[n("div",L,[u(p,{emoji:"üé¨",size:20}),n("span",R,y(o.logTitle),1)]),n("div",U,[n("button",{onClick:t[0]||(t[0]=b((...l)=>o.toggleTheaterMode&&o.toggleTheaterMode(...l),["stop"])),class:"header-button",title:s.theaterMode?"Í∞êÏÉÅ Î™®Îìú Ï¢ÖÎ£å":"Í∞êÏÉÅ Î™®Îìú"},[u(p,{emoji:s.theaterMode?"üé¨":"üé•",size:20},null,8,["emoji"])],8,z)])],2),n("div",j,[o.currentStep&&!o.currentStep.isSceneDescription&&i.logStore.vnData.characters?(a(),S(g,{key:0,"current-step":o.currentStep,characters:i.logStore.vnData.characters,layout:"single"},null,8,["current-step","characters"])):c("",!0),!o.currentStep||o.currentStep.type!=="scene-description"?(a(),h("div",J,[o.currentStep&&o.currentStep.character?(a(),S(m,{key:0,"step-type":o.currentStep.type||"dialogue","character-name":o.getCharacterName(o.currentStep),"character-color":o.currentStep.character.color,text:o.currentStep.text,"status-changes":o.currentStep.statusChanges||[],illustrations:o.currentStep.illustrations||[],"typing-speed":s.typingSpeed,"auto-play-speed":s.autoPlaySpeed,"auto-advance":o.autoPlayEnabled,"has-overlay":o.hasActiveOverlay,onAdvance:o.handleAdvance,onTypingComplete:o.handleTypingComplete},null,8,["step-type","character-name","character-color","text","status-changes","illustrations","typing-speed","auto-play-speed","auto-advance","has-overlay","onAdvance","onTypingComplete"])):(a(),h("div",X,[n("p",null,y(s.loadingMessage),1)]))])):c("",!0)]),u(f,{name:"dice-overlay"},{default:v(()=>[s.showDiceOverlay&&s.currentDiceRolls.length>0?(a(),h("div",{key:0,class:"dice-overlay",onClick:t[2]||(t[2]=(...l)=>o.closeDiceOverlay&&o.closeDiceOverlay(...l))},[n("div",{class:"dice-overlay-content",onClick:t[1]||(t[1]=b(()=>{},["stop"]))},[u(C,{"dice-rolls":s.currentDiceRolls,"character-name":s.diceCharacterName,"character-color":s.diceCharacterColor,animated:!0,"play-sound-effect":!1},null,8,["dice-rolls","character-name","character-color"]),n("div",F,[u(p,{emoji:"üëÜ",size:14}),t[7]||(t[7]=n("span",null,"ÌÅ¥Î¶≠ÌïòÏó¨ Îã´Í∏∞",-1))])])])):c("",!0)]),_:1}),u(f,{name:"dice-overlay"},{default:v(()=>[s.showComboOverlay&&s.currentDXCombos.length>0?(a(),h("div",{key:0,class:"dice-overlay",onClick:t[4]||(t[4]=(...l)=>o.closeComboOverlay&&o.closeComboOverlay(...l))},[n("div",{class:"dice-overlay-content",onClick:t[3]||(t[3]=b(()=>{},["stop"]))},[n("div",G,[n("div",W,[n("div",{class:"combo-character-name",style:I({color:s.comboCharacterColor})},y(s.comboCharacterName),5)])]),u(D,{dxCombos:s.currentDXCombos},null,8,["dxCombos"]),n("div",K,[u(p,{emoji:"üëÜ",size:14}),t[8]||(t[8]=n("span",null,"ÌÅ¥Î¶≠ÌïòÏó¨ Îã´Í∏∞",-1))])])])):c("",!0)]),_:1}),u(f,{name:"scene-description"},{default:v(()=>[s.showSceneDescription&&s.sceneDescriptionData?(a(),h("div",{key:0,class:"scene-description-overlay",onClick:t[5]||(t[5]=(...l)=>o.closeSceneDescription&&o.closeSceneDescription(...l))},[n("div",Y,[n("div",H,[n("span",q,"Ïî¨ "+y(s.sceneDescriptionData.number),1),n("span",Q,y(s.sceneDescriptionData.title),1)]),s.sceneDescriptionData.pcs?(a(),h("div",Z,[t[9]||(t[9]=n("span",{class:"scene-pcs-label"},"PC:",-1)),n("span",$,y(s.sceneDescriptionData.pcs),1)])):c("",!0),s.sceneDescriptionData.description?(a(),h("div",ee,y(s.sceneDescriptionData.description),1)):c("",!0),t[10]||(t[10]=n("div",{class:"scene-description-hint"},"ÌÅ¥Î¶≠ÌïòÏó¨ Îã´Í∏∞",-1))])])):c("",!0)]),_:1}),s.theaterMode?c("",!0):(a(),S(P,{key:0,"current-step-number":o.currentStepNumber,"total-steps":o.totalSteps,"current-scene-name":o.currentSceneName,"has-previous-step":o.hasPreviousStep,"has-next-step":o.hasNextStep,"auto-play-enabled":o.autoPlayEnabled,"auto-play-speed":s.autoPlaySpeed,"show-progress-bar":!0,"show-scene-selector":!1,onPrevious:o.previousStep,onNext:o.handleAdvance,onToggleAutoplay:o.toggleAutoPlay,onChangeSpeed:o.changeAutoPlaySpeed},null,8,["current-step-number","total-steps","current-scene-name","has-previous-step","has-next-step","auto-play-enabled","auto-play-speed","onPrevious","onNext","onToggleAutoplay","onChangeSpeed"]))]),s.theaterMode?c("",!0):(a(),S(x,{key:0,"bgm-url":s.bgmSettings.url,"bgm-type":s.bgmSettings.type,volume:s.bgmSettings.volume,"auto-play":s.bgmSettings.autoPlay},null,8,["bgm-url","bgm-type","volume","auto-play"]))])}const ie=_(B,[["render",te]]);export{ie as default};
