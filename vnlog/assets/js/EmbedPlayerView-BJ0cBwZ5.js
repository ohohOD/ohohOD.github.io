import{u as O}from"./logStore-Cp5b7cuG.js";import{B as T,D as C,a as k,S as B,P as A,C as N,b as V}from"./BGMPlayer-DxKjMitT.js";import{_ as I,c as g,a,d,g as D,f as y,n as M,r as m,t as f,h as w,w as x,T as E,o as u,l as _}from"./index-Cy47AAQa.js";const R={name:"EmbedPlayerView",components:{DialogBox:V,CharacterDisplay:N,PlaybackControls:A,SceneSelectorModal:B,DiceRoll:k,DXCombo:C,BGMPlayer:T},props:{vnData:{type:Object,default:null},customCSS:{type:Object,default:null}},setup(){return{logStore:O()}},data(){return{isLoading:!0,loadingMessage:"Î°úÍ∑∏Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...",loadError:null,autoPlayTimer:null,typingSpeed:50,theaterMode:!1,autoPlaySpeed:1,bgmSettings:{url:"",type:"youtube",volume:.5,autoPlay:!1},showDiceOverlay:!1,currentDiceRolls:[],diceCharacterName:"",diceCharacterColor:"#ffffff",diceOverlayTimer:null,showComboOverlay:!1,currentDXCombos:[],comboCharacterName:"",comboCharacterColor:"#ffffff",comboOverlayTimer:null,showSceneDescription:!1,sceneDescriptionData:null,sceneDescriptionTimer:null,showSceneSelector:!1,sfxAudio:null,currentBackground:null,previousBgmUrl:null,isMobile:!1}},watch:{customCSS:{handler(e){e&&this.useProvidedData&&(console.log("[EmbedPlayerView] customCSS changed, reapplying..."),this.$nextTick(()=>{this.applyCustomCSS(e)}))},deep:!0,immediate:!1}},computed:{useProvidedData(){return this.vnData!==null},effectiveVNData(){return this.useProvidedData?this.vnData:this.logStore.vnData},logTitle(){var e;return((e=this.effectiveVNData)==null?void 0:e.title)||"VN Log Player"},currentScene(){var s,i;const e=((s=this.effectiveVNData)==null?void 0:s.scenes)||[],t=this.useProvidedData?0:((i=this.logStore.playback)==null?void 0:i.currentSceneIndex)||0;return e[t]||null},currentStep(){var e,t;if(this.useProvidedData){const s=(t=(e=this.effectiveVNData)==null?void 0:e.scenes)==null?void 0:t[0];return((s==null?void 0:s.steps)||[])[0]||null}return this.logStore.currentStep},hasNextStep(){return this.logStore.hasNextStep},hasPreviousStep(){return this.logStore.hasPreviousStep},autoPlayEnabled(){var e;return((e=this.logStore.playback)==null?void 0:e.autoPlayEnabled)||!1},currentStepNumber(){var r,o,n,l;if(this.useProvidedData)return 1;let e=0;const t=((r=this.logStore.vnData)==null?void 0:r.scenes)||[],s=((o=this.logStore.playback)==null?void 0:o.currentSceneIndex)||0,i=((n=this.logStore.playback)==null?void 0:n.currentStepIndex)||0;for(let c=0;c<s;c++)e+=((l=t[c])==null?void 0:l.steps.length)||0;return e+=i+1,e},totalSteps(){var t,s,i,r;if(this.useProvidedData){const o=(s=(t=this.effectiveVNData)==null?void 0:t.scenes)==null?void 0:s[0];return((i=o==null?void 0:o.steps)==null?void 0:i.length)||0}return(((r=this.logStore.vnData)==null?void 0:r.scenes)||[]).reduce((o,n)=>{var l;return o+(((l=n==null?void 0:n.steps)==null?void 0:l.length)||0)},0)},currentSceneName(){var t,s;if(this.useProvidedData){const i=(s=(t=this.effectiveVNData)==null?void 0:t.scenes)==null?void 0:s[0];return(i==null?void 0:i.name)||""}const e=this.logStore.currentScene;return(e==null?void 0:e.name)||""},hasActiveOverlay(){return this.showDiceOverlay||this.showComboOverlay||this.showSceneDescription},scenes(){var e,t;return this.useProvidedData?((e=this.effectiveVNData)==null?void 0:e.scenes)||[]:((t=this.logStore.vnData)==null?void 0:t.scenes)||[]},dialogStepKey(){var s,i;if(this.useProvidedData)return"preview-0-0";const e=((s=this.logStore.playback)==null?void 0:s.currentSceneIndex)??0,t=((i=this.logStore.playback)==null?void 0:i.currentStepIndex)??0;return`${e}-${t}`}},methods:{normalizeUrl(e){if(e.includes("dropbox.com")){let t=e.replace(/dl=0(&|$)/,"dl=1$1");return t.includes("dl=")||(t+=(t.includes("?")?"&":"?")+"dl=1"),console.log("[EmbedPlayerView] Dropbox ÎßÅÌÅ¨ Î≥ÄÌôò:",e,"‚Üí",t),t}if(e.includes("blog.kakaocdn.net")&&e.includes("attach=1")){const t=e.replace(/attach=1(&|$)/,"attach=0$1");return console.log("[EmbedPlayerView] Ïπ¥Ïπ¥Ïò§ Î∏îÎ°úÍ∑∏ ÎßÅÌÅ¨ Î≥ÄÌôò:","attach=1 ‚Üí attach=0"),t}return e},async loadExternalJSON(e,t=0){e=this.normalizeUrl(e);const s=[null,o=>`https://corsproxy.io/?${encodeURIComponent(o)}`,o=>`https://api.allorigins.win/raw?url=${encodeURIComponent(o)}`,o=>`https://cors-anywhere.herokuapp.com/${o}`],i=s[t],r=t===0;this.isLoading=!0,this.loadingMessage=r?"JSON ÌååÏùºÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...":`CORS ÌîÑÎ°ùÏãúÎ•º ÌÜµÌï¥ Ïû¨ÏãúÎèÑ Ï§ë... (${t}/${s.length-1})`,this.loadError=null;try{let o=r?e:i(e);console.log(`[EmbedPlayerView] ÏãúÎèÑ ${t+1}/${s.length}:`,o);const n=new AbortController,l=setTimeout(()=>n.abort(),1e4),c=await fetch(o,{mode:"cors",credentials:"omit",headers:{Accept:"application/json, text/plain, */*"},signal:n.signal});if(clearTimeout(l),!c.ok)throw new Error(`HTTP ${c.status}: ${c.statusText}`);const S=c.headers.get("content-type");console.log("[EmbedPlayerView] Content-Type:",S);const v=await c.text();if(!v||v.trim()==="")throw new Error("Îπà ÌååÏùºÏûÖÎãàÎã§.");console.log("[EmbedPlayerView] JSON Î°úÎìú ÏôÑÎ£å (Í∏∏Ïù¥:",v.length,"bytes), ÌååÏã± ÏãúÏûë");const b=JSON.parse(v);let h,P=null;if(b.vnData&&b.version?(h=b.vnData,P=b.theme,console.log("[EmbedPlayerView] ÌÖåÎßà ÏÑ§Ï†ï Î∞úÍ≤¨:",P)):(h=b,console.log("[EmbedPlayerView] Íµ¨ ÌòïÏãù JSON (ÌÖåÎßà ÏóÜÏùå)")),!h||!h.scenes||h.scenes.length===0)throw new Error("Ïú†Ìö®Ìïú VN Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. JSON ÌååÏùºÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.");this.logStore.rawLog=JSON.stringify(h),this.logStore.vnData=h,this.logStore.playback.currentSceneIndex=0,this.logStore.playback.currentStepIndex=0,P&&this.applyThemeSettings(P),console.log("[EmbedPlayerView] ÌååÏã± ÏôÑÎ£å:",{title:h.title,sceneCount:h.scenes.length,totalSteps:this.totalSteps}),this.isLoading=!1,this.loadingMessage="",this.$nextTick(()=>{this.applyStepEffects(),this.showOverlaysIfPresent()})}catch(o){console.error(`[EmbedPlayerView] ÏãúÎèÑ ${t+1} Ïã§Ìå®:`,o);const n=o.name==="TypeError"||o.name==="AbortError"||o.message.includes("Failed to fetch")||o.message.includes("CORS")||o.message.includes("408")||o.message.includes("502")||o.message.includes("503")||o.message.includes("504"),l=t<3;if(n&&l)return console.warn(`[EmbedPlayerView] Îã§Ïùå ÌîÑÎ°ùÏãúÎ°ú Ïû¨ÏãúÎèÑ... (${t+1} -> ${t+2})`),await this.loadExternalJSON(e,t+1);o instanceof SyntaxError?(this.loadError="JSON ÌååÏã± Ïò§Î•ò",this.loadingMessage=`‚ùå JSON ÌòïÏãù Ïò§Î•ò

ÌååÏùºÏù¥ Ïò¨Î∞îÎ•∏ JSON ÌòïÏãùÏù¥ ÏïÑÎãôÎãàÎã§.

ÏÉÅÏÑ∏: ${o.message}`):t>=3?(this.loadError="Î™®Îì† Ï†ëÍ∑º Î∞©Î≤ï Ïã§Ìå®",this.loadingMessage=`‚ùå ÌååÏùºÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§

ÏßÅÏ†ë Ï†ëÍ∑º Î∞è Î™®Îì† CORS ÌîÑÎ°ùÏãú ÏãúÎèÑÍ∞Ä Ïã§Ìå®ÌñàÏäµÎãàÎã§.

Ìï¥Í≤∞ Î∞©Î≤ï:
1. GitHub Gist ÏÇ¨Ïö© (Ï∂îÏ≤ú)
2. GitHub Pages ÏÇ¨Ïö©
3. Pastebin, JSFiddle ÏÇ¨Ïö©

ÌòÑÏû¨ URLÏù¥ Îã§Ïö¥Î°úÎìú ÎßÅÌÅ¨Ïù∏ Í≤ΩÏö∞,
Í≥µÍ∞úÏ†ÅÏúºÎ°ú Ï†ëÍ∑º Í∞ÄÎä•Ìïú ÏßÅÏ†ë ÎßÅÌÅ¨Î°ú Î≥ÄÍ≤ΩÌï¥Ï£ºÏÑ∏Ïöî.`):(this.loadError=o.message,this.loadingMessage=`‚ùå Î°úÎìú Ïã§Ìå®

${o.message}`),this.isLoading=!1}},detectDevice(){const e=navigator.userAgent.toLowerCase(),t=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(e),s="ontouchstart"in window||navigator.maxTouchPoints>0,r=window.innerWidth<=767;this.isMobile=t&&r||s&&r,this.isMobile&&(this.typingSpeed=30)},getCharacterName(e){return e.type==="system"?e.character.name||"ÏãúÏä§ÌÖú":e.type==="narrator"?"":e.character.name},handleAdvance(){this.hasNextStep?this.nextStep():this.autoPlayEnabled&&this.logStore.toggleAutoPlay()},handleTypingComplete(){},onSceneChange(){this.showDiceOverlay=!1,this.showComboOverlay=!1,this.stopSceneDescriptionAutoAdvance(),this.stopDiceOverlayAutoClose(),this.stopComboOverlayAutoClose(),this.displaySceneDescriptionIfPresent()},displaySceneDescriptionIfPresent(){if(!this.currentScene)return;const e=this.currentScene.steps[0];e&&e.type==="scene-description"&&(this.sceneDescriptionData={number:e.sceneNumber,title:e.sceneTitle,pcs:e.scenePCs,description:e.sceneDescription,fullText:e.text},this.showSceneDescription=!0,this.autoPlayEnabled&&this.startSceneDescriptionAutoAdvance())},closeSceneDescription(){this.showSceneDescription=!1;const e=this.sceneDescriptionTimer!==null;this.stopSceneDescriptionAutoAdvance(),!e&&this.autoPlayEnabled&&this.hasNextStep&&setTimeout(()=>{this.nextStep()},500)},startSceneDescriptionAutoAdvance(){this.stopSceneDescriptionAutoAdvance(),this.sceneDescriptionTimer=setTimeout(()=>{this.closeSceneDescription(),this.autoPlayEnabled&&(this.hasNextStep?this.nextStep():this.logStore.toggleAutoPlay())},3e3/this.autoPlaySpeed)},stopSceneDescriptionAutoAdvance(){this.sceneDescriptionTimer&&(clearTimeout(this.sceneDescriptionTimer),this.sceneDescriptionTimer=null)},nextStep(){const e=this.logStore.playback.currentSceneIndex;this.logStore.nextStep();const t=this.logStore.playback.currentSceneIndex;e!==t&&this.onSceneChange(),this.applyStepEffects(),this.showOverlaysIfPresent()},previousStep(){const e=this.logStore.playback.currentSceneIndex;this.logStore.previousStep();const t=this.logStore.playback.currentSceneIndex;e!==t&&this.onSceneChange(),this.applyStepEffects(),this.showOverlaysIfPresent()},showOverlaysIfPresent(){var r;if(console.log("[EmbedPlayerView] showOverlaysIfPresent called"),console.log("[EmbedPlayerView] currentStep:",this.currentStep),this.currentStep&&this.currentStep.type==="scene-description"){this.sceneDescriptionData={number:this.currentStep.sceneNumber,title:this.currentStep.sceneTitle,pcs:this.currentStep.scenePCs,description:this.currentStep.sceneDescription,fullText:this.currentStep.text},this.showSceneDescription=!0,this.autoPlayEnabled&&this.startSceneDescriptionAutoAdvance();return}const e=this.currentStep&&this.currentStep.diceRolls&&this.currentStep.diceRolls.length>0,t=this.currentStep&&this.currentStep.ougis&&this.currentStep.ougis.length>0,s=this.currentStep&&this.currentStep.shinobigamis&&this.currentStep.shinobigamis.length>0,i=this.currentStep&&this.currentStep.dxCombos&&this.currentStep.dxCombos.length>0;if(console.log("[EmbedPlayerView] hasDice:",e,"diceRolls:",(r=this.currentStep)==null?void 0:r.diceRolls),console.log("[EmbedPlayerView] hasOugi:",t,"hasShinobigami:",s),console.log("[EmbedPlayerView] hasCombo:",i),e||t||s){const o=[...this.currentStep.ougis||[],...this.currentStep.shinobigamis||[],...this.currentStep.diceRolls||[]];console.log("[EmbedPlayerView] Setting dice overlay, allRolls:",o),this.currentDiceRolls=o,this.diceCharacterName=this.getCharacterName(this.currentStep),this.diceCharacterColor=this.currentStep.character.color,this.showDiceOverlay=!0,console.log("[EmbedPlayerView] showDiceOverlay set to true"),this.autoPlayEnabled&&this.startDiceOverlayAutoClose();return}i&&(this.currentDXCombos=this.currentStep.dxCombos,this.comboCharacterName=this.getCharacterName(this.currentStep),this.comboCharacterColor=this.currentStep.character.color,this.showComboOverlay=!0,this.autoPlayEnabled&&this.startComboOverlayAutoClose())},closeDiceOverlay(){this.showDiceOverlay=!1;const e=this.diceOverlayTimer!==null;this.stopDiceOverlayAutoClose(),!e&&this.autoPlayEnabled&&this.hasNextStep&&setTimeout(()=>{this.nextStep()},500)},startDiceOverlayAutoClose(){this.stopDiceOverlayAutoClose(),this.diceOverlayTimer=setTimeout(()=>{this.closeDiceOverlay(),this.autoPlayEnabled&&this.hasNextStep&&this.nextStep()},3e3/this.autoPlaySpeed)},stopDiceOverlayAutoClose(){this.diceOverlayTimer&&(clearTimeout(this.diceOverlayTimer),this.diceOverlayTimer=null)},closeComboOverlay(){this.showComboOverlay=!1;const e=this.comboOverlayTimer!==null;this.stopComboOverlayAutoClose(),!e&&this.autoPlayEnabled&&this.hasNextStep&&setTimeout(()=>{this.nextStep()},500)},startComboOverlayAutoClose(){this.stopComboOverlayAutoClose(),this.comboOverlayTimer=setTimeout(()=>{this.closeComboOverlay(),this.autoPlayEnabled&&this.hasNextStep&&this.nextStep()},3e3/this.autoPlaySpeed)},stopComboOverlayAutoClose(){this.comboOverlayTimer&&(clearTimeout(this.comboOverlayTimer),this.comboOverlayTimer=null)},toggleAutoPlay(){const e=this.autoPlayEnabled;this.logStore.toggleAutoPlay(),!e&&this.autoPlayEnabled&&this.hasActiveOverlay},toggleTheaterMode(){this.theaterMode=!this.theaterMode,this.theaterMode&&!this.autoPlayEnabled&&(this.logStore.toggleAutoPlay(),!this.hasActiveOverlay&&this.hasNextStep&&this.nextStep())},handleTheaterModeClick(e){if(this.theaterMode){if(e.target.closest("button")||e.target.closest(".dialog-box"))return;this.theaterMode=!1}},changeAutoPlaySpeed(e){this.autoPlaySpeed=e},openSceneSelector(){this.showSceneSelector=!0},closeSceneSelector(){this.showSceneSelector=!1},handleGoToStep(e,t){const s=this.logStore.playback.currentSceneIndex;this.logStore.goToStep(e,t),s!==e&&this.onSceneChange(),this.closeSceneSelector(),this.showOverlaysIfPresent()},applyStepEffects(){if(!this.currentStep)return;const e=this.currentStep.effects;e!=null&&e.sfx&&this.playSFX(e.sfx);const t=(e==null?void 0:e.bgm)||null;if(t!==this.previousBgmUrl&&(t&&this.changeBGM(t),this.previousBgmUrl=t),e!=null&&e.background){const s=e.backgroundOpacity??.3;this.changeBackground(e.background,s)}},async playSFX(e){if(!(!e||!e.trim()))try{let t=e.trim();if(t.includes("youtube.com")||t.includes("youtu.be")){console.warn("[EmbedPlayerView] YouTube Ìö®Í≥ºÏùåÏùÄ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.");return}if(t.includes("drive.google.com")||t.includes("docs.google.com")){let i=null;const r=t.match(/\/file\/d\/([^\/\?]+)/);r&&(i=r[1]);const o=t.match(/[?&]id=([^&]+)/);o&&(i=o[1]),i&&(t=`https://docs.google.com/uc?export=download&id=${i}`)}const s=new Audio(t);s.volume=.7,s.loop=!1,s.addEventListener("ended",()=>{s.src="",this.sfxAudio===s&&(this.sfxAudio=null)}),await s.play(),this.sfxAudio=s}catch(t){console.error("[EmbedPlayerView] Ìö®Í≥ºÏùå Ïû¨ÏÉù Ïã§Ìå®:",t)}},changeBGM(e){const t=e.includes("youtube.com")||e.includes("youtu.be");this.bgmSettings={url:e,type:t?"youtube":"audio",volume:this.bgmSettings.volume||.5,autoPlay:!0}},changeBackground(e,t=.3){this.currentBackground=e;const s=`linear-gradient(rgba(0, 0, 0, ${1-t}), rgba(0, 0, 0, ${1-t}))`;document.documentElement.style.setProperty("--bg-image",`${s}, url(${e})`),document.documentElement.style.setProperty("--bg-image-size","cover")},applyThemeSettings(e){if(!e)return;console.log("[EmbedPlayerView] ÌÖåÎßà Ï†ÅÏö© ÏãúÏûë:",e);const t=document.documentElement;if(e.primaryColor&&t.style.setProperty("--primary-color",e.primaryColor),e.textColor&&t.style.setProperty("--text-color",e.textColor),e.bgColor&&t.style.setProperty("--bg-color",e.bgColor),e.bgSecondary&&t.style.setProperty("--bg-secondary",e.bgSecondary),e.borderColor&&t.style.setProperty("--border-color",e.borderColor),e.fontFamily&&(t.style.setProperty("--font-pretendard",e.fontFamily),document.body.style.fontFamily=e.fontFamily),e.bgImageUrl){const s=e.bgImageOpacity??.3,i=`linear-gradient(rgba(0, 0, 0, ${1-s}), rgba(0, 0, 0, ${1-s}))`;t.style.setProperty("--bg-image",`${i}, url(${e.bgImageUrl})`),t.style.setProperty("--bg-image-size",e.bgImageSize||"cover")}e.bgmUrl&&(this.bgmSettings={url:e.bgmUrl,type:e.bgmType||"youtube",volume:e.bgmVolume||.5,autoPlay:e.bgmAutoPlay||!1}),console.log("[EmbedPlayerView] ÌÖåÎßà Ï†ÅÏö© ÏôÑÎ£å")},applyCustomCSS(e){if(!e)return;const t=document.getElementById("vnlog-custom-css-embed");t&&t.remove();let s="";if(e.cssVars)s=this.generateCSSFromVars(e.cssVars),e.userCustomCSS&&(s+=`
`+e.userCustomCSS);else if(Object.keys(e).length>0)s=this.generateCSSFromVars(e);else return;const i=this.wrapCSSWithEmbedScope(s),r=document.createElement("style");r.id="vnlog-custom-css-embed",r.textContent=i,document.head.appendChild(r),console.log("[EmbedPlayerView] Ïª§Ïä§ÌÖÄ CSS Ï†ÅÏö© ÏôÑÎ£å")},generateCSSFromVars(e){const t=["/* VNLog Custom CSS - EmbedPlayerView */",":root {"];return e.dialogBackground&&t.push(`  --custom-dialog-bg: ${e.dialogBackground};`),e.dialogBorderColor&&t.push(`  --custom-dialog-border: ${e.dialogBorderColor};`),e.dialogBorderWidth&&t.push(`  --custom-dialog-border-width: ${e.dialogBorderWidth};`),e.dialogTextColor&&t.push(`  --custom-dialog-text: ${e.dialogTextColor};`),e.dialogNameFontSize&&t.push(`  --custom-dialog-name-size: ${e.dialogNameFontSize};`),e.dialogTextFontSize&&t.push(`  --custom-dialog-text-size: ${e.dialogTextFontSize};`),e.dialogPadding&&t.push(`  --custom-dialog-padding: ${e.dialogPadding};`),e.dialogBorderRadius&&t.push(`  --custom-dialog-radius: ${e.dialogBorderRadius};`),e.dialogMinHeight&&t.push(`  --custom-dialog-min-height: ${e.dialogMinHeight};`),e.dialogLineHeight&&t.push(`  --custom-dialog-line-height: ${e.dialogLineHeight};`),e.characterMaxHeight&&t.push(`  --custom-character-max-height: ${e.characterMaxHeight};`),e.characterMaxWidth&&t.push(`  --custom-character-max-width: ${e.characterMaxWidth};`),e.characterInactiveOpacity&&t.push(`  --custom-character-inactive-opacity: ${e.characterInactiveOpacity};`),e.characterBorderRadius&&t.push(`  --custom-character-border-radius: ${e.characterBorderRadius};`),e.characterBorderWidth&&t.push(`  --custom-character-border-width: ${e.characterBorderWidth};`),e.characterTransition&&t.push(`  --custom-character-transition: ${e.characterTransition};`),e.controlsBackground&&t.push(`  --custom-controls-bg: ${e.controlsBackground};`),e.controlsBorderColor&&t.push(`  --custom-controls-border: ${e.controlsBorderColor};`),e.controlsButtonColor&&t.push(`  --custom-controls-button: ${e.controlsButtonColor};`),e.controlsButtonHoverColor&&t.push(`  --custom-controls-button-hover: ${e.controlsButtonHoverColor};`),e.controlsButtonBg&&t.push(`  --custom-controls-button-bg: ${e.controlsButtonBg};`),e.controlsButtonHoverBg&&t.push(`  --custom-controls-button-hover-bg: ${e.controlsButtonHoverBg};`),e.controlsProgressColor&&t.push(`  --custom-controls-progress: ${e.controlsProgressColor};`),e.controlsProgressBg&&t.push(`  --custom-controls-progress-bg: ${e.controlsProgressBg};`),e.controlsButtonSize&&t.push(`  --custom-controls-button-size: ${e.controlsButtonSize};`),e.controlsPrimaryButtonSize&&t.push(`  --custom-controls-primary-button-size: ${e.controlsPrimaryButtonSize};`),e.controlsBorderRadius&&t.push(`  --custom-controls-border-radius: ${e.controlsBorderRadius};`),e.overlayBackground&&t.push(`  --custom-overlay-bg: ${e.overlayBackground};`),e.overlayBlur&&t.push(`  --custom-overlay-blur: ${e.overlayBlur};`),e.overlayContentBackground&&t.push(`  --custom-overlay-content-bg: ${e.overlayContentBackground};`),e.overlayTextColor&&t.push(`  --custom-overlay-text: ${e.overlayTextColor};`),e.overlayBorderRadius&&t.push(`  --custom-overlay-radius: ${e.overlayBorderRadius};`),e.overlayPadding&&t.push(`  --custom-overlay-padding: ${e.overlayPadding};`),e.overlayMaxWidth&&t.push(`  --custom-overlay-max-width: ${e.overlayMaxWidth};`),e.globalBackground&&t.push(`  --custom-global-bg: ${e.globalBackground};`),e.globalTextColor&&t.push(`  --custom-global-text: ${e.globalTextColor};`),e.globalFontFamily&&t.push(`  --custom-global-font: ${e.globalFontFamily};`),e.globalLineHeight&&t.push(`  --custom-global-line-height: ${e.globalLineHeight};`),e.globalBackgroundImage&&e.globalBackgroundImage!=="none"&&t.push(`  --bg-image: ${e.globalBackgroundImage};`),e.globalBackgroundSize&&t.push(`  --bg-image-size: ${e.globalBackgroundSize};`),t.push("}"),t.push(""),t.push(".dialog-box {"),t.push("  background: var(--custom-dialog-bg, rgba(0, 0, 0, 0.85)) !important;"),t.push("  border-color: var(--custom-dialog-border, rgba(255, 255, 255, 0.2)) !important;"),t.push("  color: var(--custom-dialog-text, #ffffff) !important;"),t.push("  padding: var(--custom-dialog-padding, 1.5rem) !important;"),t.push("  border-radius: var(--custom-dialog-radius, 12px) !important;"),t.push("}"),t.join(`
`)},wrapCSSWithEmbedScope(e){const t=e.split(`
`),s=[];for(const i of t){const r=i.trim();if(r.startsWith("/*")||r.endsWith("*/")){s.push(i);continue}if(r===":root {"){s.push(".embed-player-view {");continue}if(r.endsWith("{")&&!r.startsWith("}")){const o=r.slice(0,-1).trim();if(o.startsWith(".embed-player-view"))s.push(i);else{const n=i.match(/^\s*/)[0];s.push(`${n}.embed-player-view ${o} {`)}continue}s.push(i)}return s.join(`
`)},handleKeyPress(e){if(!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"))switch(e.key){case" ":case"Enter":e.preventDefault(),this.handleAdvance();break;case"ArrowLeft":e.preventDefault(),this.hasPreviousStep&&this.previousStep();break;case"ArrowRight":e.preventDefault(),this.hasNextStep&&this.nextStep();break}}},async mounted(){var i;if(this.detectDevice(),window.addEventListener("resize",this.detectDevice),window.addEventListener("keydown",this.handleKeyPress),this.useProvidedData){console.log("[EmbedPlayerView] Preview mode detected"),console.log("[EmbedPlayerView] vnData:",this.vnData),console.log("[EmbedPlayerView] effectiveVNData:",this.effectiveVNData),this.isLoading=!1,this.customCSS&&this.applyCustomCSS(this.customCSS),this.$nextTick(()=>{console.log("[EmbedPlayerView] $nextTick - calling showOverlaysIfPresent"),console.log("[EmbedPlayerView] currentStep before showOverlays:",this.currentStep),this.showOverlaysIfPresent(),console.log("[EmbedPlayerView] After showOverlaysIfPresent - showDiceOverlay:",this.showDiceOverlay),console.log("[EmbedPlayerView] After showOverlaysIfPresent - currentDiceRolls:",this.currentDiceRolls)});return}const e=new URLSearchParams(window.location.search),t=e.get("json"),s=e.get("autoplay")==="true";if(!t){this.loadingMessage="Ïò§Î•ò: JSON URLÏù¥ Ï†úÍ≥µÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.",this.loadError="json ÏøºÎ¶¨ ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§.",console.error("[EmbedPlayerView] json ÏøºÎ¶¨ ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.");return}await this.loadExternalJSON(t),(i=this.logStore.vnData)!=null&&i.customCSS&&this.applyCustomCSS(this.logStore.vnData.customCSS),s&&!this.loadError&&this.logStore.toggleAutoPlay()},beforeUnmount(){this.stopSceneDescriptionAutoAdvance(),this.stopDiceOverlayAutoClose(),this.stopComboOverlayAutoClose(),window.removeEventListener("keydown",this.handleKeyPress),window.removeEventListener("resize",this.detectDevice),this.sfxAudio&&(this.sfxAudio.pause(),this.sfxAudio=null),this.currentBackground&&(document.documentElement.style.removeProperty("--bg-image"),document.documentElement.style.removeProperty("--bg-image-size"));const e=document.documentElement;e.style.removeProperty("--primary-color"),e.style.removeProperty("--text-color"),e.style.removeProperty("--bg-color"),e.style.removeProperty("--bg-secondary"),e.style.removeProperty("--border-color")}},z={class:"player-container"},L={class:"embed-logo"},U={class:"embed-title"},F={class:"header-buttons"},W=["title"],j={class:"player-stage"},H={key:1,class:"dialog-wrapper"},J={key:1,class:"dialog-placeholder"},G={class:"dice-overlay-hint"},X={class:"combo-overlay-header"},K={class:"combo-character-info"},Y={class:"dice-overlay-hint"},q={class:"scene-description-content"},Q={class:"scene-description-header"},Z={class:"scene-number"},$={class:"scene-title"},ee={key:0,class:"scene-pcs"},te={class:"scene-pcs-value"},oe={key:1,class:"scene-description-text"};function re(e,t,s,i,r,o){const n=m("EmojiToIcon"),l=m("CharacterDisplay"),c=m("DialogBox"),S=m("DiceRoll"),v=m("DXCombo"),b=m("PlaybackControls"),h=m("SceneSelectorModal"),P=m("BGMPlayer");return u(),g("div",{class:"embed-player-view",onClick:t[6]||(t[6]=(...p)=>o.handleTheaterModeClick&&o.handleTheaterModeClick(...p))},[a("div",z,[a("div",{class:M(["player-header",{"theater-mode":r.theaterMode}])},[a("div",L,[d(n,{emoji:"üé¨",size:20}),a("span",U,f(o.logTitle),1)]),a("div",F,[a("button",{onClick:t[0]||(t[0]=w((...p)=>o.toggleTheaterMode&&o.toggleTheaterMode(...p),["stop"])),class:"header-button",title:r.theaterMode?"Í∞êÏÉÅ Î™®Îìú Ï¢ÖÎ£å":"Í∞êÏÉÅ Î™®Îìú"},[d(n,{emoji:r.theaterMode?"üé¨":"üé•",size:20},null,8,["emoji"])],8,W)])],2),a("div",j,[o.currentStep&&!o.currentStep.isSceneDescription&&o.effectiveVNData.characters?(u(),D(l,{key:0,"current-step":o.currentStep,characters:o.effectiveVNData.characters,layout:"single"},null,8,["current-step","characters"])):y("",!0),!o.currentStep||o.currentStep.type!=="scene-description"?(u(),g("div",H,[o.currentStep&&o.currentStep.character?(u(),D(c,{key:0,"step-key":o.dialogStepKey,"step-type":o.currentStep.type||"dialogue","character-name":o.getCharacterName(o.currentStep),"character-color":o.currentStep.character.color,text:o.currentStep.text,"status-changes":o.currentStep.statusChanges||[],illustrations:o.currentStep.illustrations||[],"typing-speed":r.typingSpeed,"auto-play-speed":r.autoPlaySpeed,"auto-advance":o.autoPlayEnabled,"has-overlay":o.hasActiveOverlay,onAdvance:o.handleAdvance,onTypingComplete:o.handleTypingComplete},null,8,["step-key","step-type","character-name","character-color","text","status-changes","illustrations","typing-speed","auto-play-speed","auto-advance","has-overlay","onAdvance","onTypingComplete"])):(u(),g("div",J,[a("p",null,f(r.loadingMessage),1)]))])):y("",!0)]),d(E,{name:"dice-overlay"},{default:x(()=>[r.showDiceOverlay&&r.currentDiceRolls.length>0?(u(),g("div",{key:0,class:"dice-overlay",onClick:t[2]||(t[2]=(...p)=>o.closeDiceOverlay&&o.closeDiceOverlay(...p))},[a("div",{class:"dice-overlay-content",onClick:t[1]||(t[1]=w(()=>{},["stop"]))},[d(S,{"dice-rolls":r.currentDiceRolls,"character-name":r.diceCharacterName,"character-color":r.diceCharacterColor,animated:!0,"play-sound-effect":!1},null,8,["dice-rolls","character-name","character-color"]),a("div",G,[d(n,{emoji:"üëÜ",size:14}),t[7]||(t[7]=a("span",null,"ÌÅ¥Î¶≠ÌïòÏó¨ Îã´Í∏∞",-1))])])])):y("",!0)]),_:1}),d(E,{name:"dice-overlay"},{default:x(()=>[r.showComboOverlay&&r.currentDXCombos.length>0?(u(),g("div",{key:0,class:"dice-overlay",onClick:t[4]||(t[4]=(...p)=>o.closeComboOverlay&&o.closeComboOverlay(...p))},[a("div",{class:"dice-overlay-content",onClick:t[3]||(t[3]=w(()=>{},["stop"]))},[a("div",X,[a("div",K,[a("div",{class:"combo-character-name",style:_({color:r.comboCharacterColor})},f(r.comboCharacterName),5)])]),d(v,{dxCombos:r.currentDXCombos},null,8,["dxCombos"]),a("div",Y,[d(n,{emoji:"üëÜ",size:14}),t[8]||(t[8]=a("span",null,"ÌÅ¥Î¶≠ÌïòÏó¨ Îã´Í∏∞",-1))])])])):y("",!0)]),_:1}),d(E,{name:"scene-description"},{default:x(()=>[r.showSceneDescription&&r.sceneDescriptionData?(u(),g("div",{key:0,class:"scene-description-overlay",onClick:t[5]||(t[5]=(...p)=>o.closeSceneDescription&&o.closeSceneDescription(...p))},[a("div",q,[a("div",Q,[a("span",Z,"Ïî¨ "+f(r.sceneDescriptionData.number),1),a("span",$,f(r.sceneDescriptionData.title),1)]),r.sceneDescriptionData.pcs?(u(),g("div",ee,[t[9]||(t[9]=a("span",{class:"scene-pcs-label"},"PC:",-1)),a("span",te,f(r.sceneDescriptionData.pcs),1)])):y("",!0),r.sceneDescriptionData.description?(u(),g("div",oe,f(r.sceneDescriptionData.description),1)):y("",!0),t[10]||(t[10]=a("div",{class:"scene-description-hint"},"ÌÅ¥Î¶≠ÌïòÏó¨ Îã´Í∏∞",-1))])])):y("",!0)]),_:1}),r.theaterMode?y("",!0):(u(),D(b,{key:0,"current-step-number":o.currentStepNumber,"total-steps":o.totalSteps,"current-scene-name":o.currentSceneName,"has-previous-step":o.hasPreviousStep,"has-next-step":o.hasNextStep,"auto-play-enabled":o.autoPlayEnabled,"auto-play-speed":r.autoPlaySpeed,"show-progress-bar":!0,"show-scene-selector":!0,onPrevious:o.previousStep,onNext:o.handleAdvance,onToggleAutoplay:o.toggleAutoPlay,onChangeSpeed:o.changeAutoPlaySpeed,onOpenSceneSelector:o.openSceneSelector},null,8,["current-step-number","total-steps","current-scene-name","has-previous-step","has-next-step","auto-play-enabled","auto-play-speed","onPrevious","onNext","onToggleAutoplay","onChangeSpeed","onOpenSceneSelector"]))]),d(h,{"is-visible":r.showSceneSelector,scenes:o.scenes,"current-scene-index":i.logStore.playback.currentSceneIndex,"current-step-index":i.logStore.playback.currentStepIndex,onClose:o.closeSceneSelector,onGoToStep:o.handleGoToStep},null,8,["is-visible","scenes","current-scene-index","current-step-index","onClose","onGoToStep"]),d(P,{"bgm-url":r.bgmSettings.url,"bgm-type":r.bgmSettings.type,volume:r.bgmSettings.volume,"auto-play":r.bgmSettings.autoPlay,"show-controls":!r.theaterMode},null,8,["bgm-url","bgm-type","volume","auto-play","show-controls"])])}const ne=I(R,[["render",re]]);export{ne as default};
