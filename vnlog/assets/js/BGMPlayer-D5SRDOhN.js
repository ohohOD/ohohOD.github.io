import{_ as k,c as n,f as u,F as g,m as T,r as P,o,n as b,a as i,d as h,t as l,g as S,l as C,w as _,T as v,h as I,e as x,q as A,i as B,v as M}from"./index-KTK-BX4d.js";const R={name:"StatusChange",props:{statusChanges:{type:Array,default:()=>[]}},methods:{getStatusIcon(t){const e=t.toLowerCase();return e.includes("Ïπ®Ïãù")?"‚ö°":e.includes("hp")||e.includes("ÏÉùÎ™Ö")||e.includes("Ï≤¥Î†•")?"‚ù§Ô∏è":e.includes("mp")||e.includes("ÎßàÎÇò")||e.includes("ÎßàÎ†•")?"üíô":e.includes("san")||e.includes("Ï†ïÏã†")||e.includes("Ïù¥ÏÑ±")?"üß†":"üìä"}}},$={key:0,class:"status-change-container"},j={class:"status-icon"},E={class:"status-info"},N={class:"character-name"},D={class:"status-name"},V={class:"status-values"},U={class:"old-value"},G={class:"new-value"},z={key:1,class:"new-value"},H={key:2,class:"old-value"};function O(t,e,a,f,c,r){const d=P("EmojiToIcon");return a.statusChanges&&a.statusChanges.length>0?(o(),n("div",$,[(o(!0),n(g,null,T(a.statusChanges,(s,y)=>(o(),n("div",{key:y,class:b(["status-change",{"is-positive":s.delta>0,"is-negative":s.delta<0}])},[i("div",j,[h(d,{emoji:r.getStatusIcon(s.statusName),size:16},null,8,["emoji"])]),i("div",E,[i("span",N,l(s.characterName),1),i("span",D,l(s.statusName),1)]),i("div",V,[s.oldValue!==null&&s.newValue!==null?(o(),n(g,{key:0},[i("span",U,l(s.oldValue),1),e[0]||(e[0]=i("span",{class:"arrow"},"‚Üí",-1)),i("span",G,l(s.newValue),1)],64)):s.oldValue===null&&s.newValue!==null?(o(),n("span",z,l(s.newValue),1)):s.oldValue!==null&&s.newValue===null?(o(),n("span",H,l(s.oldValue),1)):u("",!0),s.delta!==0?(o(),n("span",{key:3,class:b(["delta",{"delta-positive":s.delta>0,"delta-negative":s.delta<0}])},l(s.delta>0?"+":"")+l(s.delta),3)):u("",!0)])],2))),128))])):u("",!0)}const Y=k(R,[["render",O],["__scopeId","data-v-820fc90f"]]),L={name:"DXCombo",props:{dxCombos:{type:Array,default:()=>[]}},methods:{decodeHtml(t){if(!t)return t;const e=document.createElement("textarea");e.innerHTML=t;let a=e.value;return a=a.replace(/\\n/g,`
`),a=a.replace(/\\t/g,"	"),a=a.replace(/\\r/g,"\r"),a}}},F={key:0,class:"dx-combo-container"},q={class:"combo-header"},K={class:"combo-icon"},X={class:"combo-label"},J={key:0,class:"combo-name"},Q={key:1,class:"erosion-cost"},W={class:"combo-effects"},Z={class:"effect-name"},ee={class:"effect-level"},te={key:0,class:"combo-info-row"},se={key:0,class:"info-item"},ie={class:"info-value"},ae={key:1,class:"info-item"},oe={class:"info-value"},ne={key:2,class:"info-item"},le={class:"info-value"},re={key:3,class:"info-item"},ue={class:"info-value"},de={key:1,class:"combo-stats-row"},ce={key:0,class:"info-item"},he={class:"info-value"},ye={key:1,class:"info-item"},me={class:"info-value"},fe={key:2,class:"info-item"},pe={class:"info-value"},ge={key:3,class:"info-item"},_e={class:"info-value"},be={key:2,class:"combo-description"},ve={key:3,class:"combo-dice-roll"},Pe={class:"dice-roll-header"},Te={class:"dice-roll-content"},ke={class:"dice-formula"},Ce={class:"dice-detail"},Se={class:"dice-result"};function we(t,e,a,f,c,r){const d=P("EmojiToIcon");return a.dxCombos&&a.dxCombos.length>0?(o(),n("div",F,[(o(!0),n(g,null,T(a.dxCombos,(s,y)=>(o(),n("div",{key:y,class:"dx-combo"},[i("div",q,[i("div",K,[h(d,{emoji:"‚ö°",size:16})]),i("span",X,l(s.isSingleEffect?"Ïù¥ÌéôÌä∏":"ÏΩ§Î≥¥"),1),s.comboName?(o(),n("span",J,l(r.decodeHtml(s.comboName)),1)):u("",!0),s.erosionCost?(o(),n("span",Q,l(s.erosionCost)+"‚Üë",1)):u("",!0)]),i("div",W,[(o(!0),n(g,null,T(s.effects,(m,p)=>(o(),n("div",{key:p,class:"combo-effect"},[i("span",Z,l(r.decodeHtml(m.name)),1),i("span",ee,"Lv."+l(m.level),1)]))),128))]),s.timing||s.difficulty||s.target||s.range?(o(),n("div",te,[s.timing?(o(),n("span",se,[e[0]||(e[0]=i("span",{class:"info-label"},"ÌÉÄÏù¥Î∞ç:",-1)),i("span",ie,l(r.decodeHtml(s.timing)),1)])):u("",!0),s.difficulty?(o(),n("span",ae,[e[1]||(e[1]=i("span",{class:"info-label"},"ÎÇúÏù¥ÎèÑ:",-1)),i("span",oe,l(r.decodeHtml(s.difficulty)),1)])):u("",!0),s.target?(o(),n("span",ne,[e[2]||(e[2]=i("span",{class:"info-label"},"ÎåÄÏÉÅ:",-1)),i("span",le,l(r.decodeHtml(s.target)),1)])):u("",!0),s.range?(o(),n("span",re,[e[3]||(e[3]=i("span",{class:"info-label"},"ÏÇ¨Í±∞Î¶¨:",-1)),i("span",ue,l(r.decodeHtml(s.range)),1)])):u("",!0)])):u("",!0),s.dice||s.critical||s.attack||s.erosion?(o(),n("div",de,[s.dice?(o(),n("span",ce,[e[4]||(e[4]=i("span",{class:"info-label"},"Îã§Ïù¥Ïä§:",-1)),i("span",he,l(r.decodeHtml(s.dice)),1)])):u("",!0),s.critical?(o(),n("span",ye,[e[5]||(e[5]=i("span",{class:"info-label"},"ÌÅ¨Î¶¨Ïπò:",-1)),i("span",me,l(r.decodeHtml(s.critical)),1)])):u("",!0),s.attack?(o(),n("span",fe,[e[6]||(e[6]=i("span",{class:"info-label"},"Í≥µÍ≤©Î†•:",-1)),i("span",pe,l(r.decodeHtml(s.attack)),1)])):u("",!0),s.erosion?(o(),n("span",ge,[e[7]||(e[7]=i("span",{class:"info-label"},"Ïπ®Ïãù:",-1)),i("span",_e,l(r.decodeHtml(s.erosion)),1)])):u("",!0)])):u("",!0),s.description?(o(),n("div",be,l(r.decodeHtml(s.description)),1)):u("",!0),s.diceRoll?(o(),n("div",ve,[i("div",Pe,[h(d,{emoji:"üé≤",size:14}),e[8]||(e[8]=i("span",{class:"dice-roll-label"},"ÌåêÏ†ï",-1))]),i("div",Te,[i("span",ke,l(s.diceRoll.formula),1),e[9]||(e[9]=i("span",{class:"dice-separator"},"‚Üí",-1)),i("span",Ce,l(s.diceRoll.diceRolls),1),e[10]||(e[10]=i("span",{class:"dice-separator"},"‚Üí",-1)),i("span",Se,l(s.diceRoll.result),1)])])):u("",!0)]))),128))])):u("",!0)}const xe=k(L,[["render",we],["__scopeId","data-v-73107c03"]]),Ie={name:"Illustration",props:{illustrations:{type:Array,default:()=>[]}},data(){return{failedImages:new Set}},methods:{handleImageError(t){this.failedImages.add(t),this.$forceUpdate()},handleImageLoad(){}}},Ae={key:0,class:"illustration-container"},Be=["src","alt","onError"];function Me(t,e,a,f,c,r){return a.illustrations&&a.illustrations.length>0?(o(),n("div",Ae,[(o(!0),n(g,null,T(a.illustrations,(d,s)=>(o(),n("div",{key:s,class:"illustration-item"},[c.failedImages.has(s)?u("",!0):(o(),n("img",{key:0,src:d.url,alt:d.alt||"ÏÇΩÌôî",class:"illustration-image",onError:y=>r.handleImageError(s),onLoad:e[0]||(e[0]=(...y)=>r.handleImageLoad&&r.handleImageLoad(...y))},null,40,Be))]))),128))])):u("",!0)}const Re=k(Ie,[["render",Me],["__scopeId","data-v-c3f90253"]]),$e={name:"DialogBox",components:{StatusChange:Y,DXCombo:xe,Illustration:Re},props:{stepKey:{type:[String,Number],default:null},stepType:{type:String,default:"dialogue",validator:t=>["dialogue","system","narrator","scene-description"].includes(t)},characterName:{type:String,default:""},characterColor:{type:String,default:"#333333"},text:{type:String,required:!0},statusChanges:{type:Array,default:()=>[]},dxCombos:{type:Array,default:()=>[]},illustrations:{type:Array,default:()=>[]},typingSpeed:{type:Number,default:50},autoPlaySpeed:{type:Number,default:1},autoAdvance:{type:Boolean,default:!1},hasOverlay:{type:Boolean,default:!1}},data(){return{displayedText:"",isTyping:!1,isComplete:!1,typingTimer:null,autoAdvanceTimer:null,currentIndex:0,originalHtmlText:null,lastTypingSignature:null}},computed:{decodedText(){return this.decodeHtmlEntities(this.displayedText)}},watch:{stepKey:{handler(){this.restartTyping("stepKey")}},text:{immediate:!0,handler(){this.restartTyping("text")}},autoAdvance(t,e){if(console.log("[DialogBox] autoAdvance Î≥ÄÍ≤Ω:",{old:e,new:t,isComplete:this.isComplete,hasOverlay:this.hasOverlay}),!t&&e){console.log("[DialogBox] ÏûêÎèôÏû¨ÏÉù Ï∑®ÏÜå - ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨"),this.stopAutoAdvance();return}t&&!e&&this.isComplete&&!this.hasOverlay&&(this.stopAutoAdvance(),this.autoAdvanceTimer=setTimeout(()=>{this.autoAdvance&&this.isComplete&&!this.hasOverlay&&(console.log("[DialogBox] autoAdvance watchÏóêÏÑú ÏßÑÌñâ"),this.autoAdvanceTimer=null,this.$emit("advance"))},1500))}},methods:{restartTyping(t){const e=`${this.stepKey??""}::${this.text??""}`;e!==this.lastTypingSignature&&(this.lastTypingSignature=e,console.log(`[DialogBox] ${t} Î≥ÄÍ≤Ω, ÌÉÄÏù¥Ìïë ÏãúÏûë`),this.startTyping(this.text))},decodeHtmlEntities(t){if(!t)return t;const e={"&lt;":"<","&gt;":">","&amp;":"&","&quot;":'"',"&#39;":"'","&apos;":"'"};return t.replace(/&[a-z]+;|&#\d+;/gi,a=>e[a]||a)},startTyping(t){if(this.stopTyping(),this.stopAutoAdvance(),this.displayedText="",this.currentIndex=0,this.isTyping=!0,this.isComplete=!1,!t||t.length===0){this.displayedText=t,this.completeTyping(!0);return}if(t.includes("roll20-dx3-template")||t.includes("sheet-rolltemplate-")){this.displayedText=t,this.completeTyping(!0);return}if(this.hasHtmlTags(t)){const e=this.extractPlainText(t);this.originalHtmlText=t,this.typeNextCharacter(e,t);return}this.originalHtmlText=null,this.typeNextCharacter(t,t)},hasHtmlTags(t){return/<[^>]+>/i.test(t)},extractPlainText(t){const e=document.createElement("div");return e.innerHTML=t,e.textContent||e.innerText||""},typeNextCharacter(t,e){this.currentIndex<t.length?(this.originalHtmlText?this.displayedText=this.reconstructHtmlUpToIndex(this.originalHtmlText,this.currentIndex):this.displayedText+=t[this.currentIndex],this.currentIndex++,this.typingTimer=setTimeout(()=>{this.typeNextCharacter(t,e)},this.typingSpeed/this.autoPlaySpeed)):(this.displayedText=e,this.completeTyping())},reconstructHtmlUpToIndex(t,e){const a=document.createElement("div");a.innerHTML=t;let f=0,c="";const r=d=>{if(f>=e)return!1;if(d.nodeType===Node.TEXT_NODE){const s=d.textContent,y=e-f;if(f+s.length<=e)c+=s,f+=s.length;else return c+=s.substring(0,y),f=e,!1}else if(d.nodeType===Node.ELEMENT_NODE){const s=d.tagName.toLowerCase(),y=Array.from(d.attributes).map(m=>`${m.name}="${m.value}"`).join(" ");c+=`<${s}${y?" "+y:""}>`;for(let m of d.childNodes)if(!r(m))return!1;c+=`</${s}>`}return!0};for(let d of a.childNodes)if(!r(d))break;return c},completeTyping(t=!1){if(this.isTyping=!1,this.isComplete=!0,this.$emit("typing-complete"),console.log("[DialogBox] completeTyping:",{autoAdvance:this.autoAdvance,hasOverlay:this.hasOverlay,isEmpty:t,textLength:this.text.length}),this.autoAdvance&&!this.hasOverlay){let e=1500;t&&(e=3e3);const a=this.text.length*this.typingSpeed/this.autoPlaySpeed,c=a+e/this.autoPlaySpeed<3e3/this.autoPlaySpeed?3e3/this.autoPlaySpeed-a:e/this.autoPlaySpeed;console.log("[DialogBox] ÏûêÎèô ÏßÑÌñâ ÌÉÄÏù¥Î®∏ ÏãúÏûë:",Math.max(c,e),"ms"),this.autoAdvanceTimer=setTimeout(()=>{this.autoAdvance&&!this.hasOverlay?(console.log("[DialogBox] ÏûêÎèô ÏßÑÌñâ Ïã§Ìñâ"),this.autoAdvanceTimer=null,this.$emit("advance")):(console.log("[DialogBox] ÏûêÎèô ÏßÑÌñâ Ï∑®ÏÜåÎê® (autoAdvance:",this.autoAdvance,", hasOverlay:",this.hasOverlay,")"),this.autoAdvanceTimer=null)},Math.max(c,e))}},handleClick(){this.skipTyping()},skipTyping(){this.isTyping?(this.stopTyping(),this.displayedText=this.text,this.completeTyping()):this.isComplete&&this.$emit("advance")},stopTyping(){this.typingTimer&&(clearTimeout(this.typingTimer),this.typingTimer=null)},stopAutoAdvance(){this.autoAdvanceTimer&&(clearTimeout(this.autoAdvanceTimer),this.autoAdvanceTimer=null)}},beforeUnmount(){this.stopTyping(),this.stopAutoAdvance()}},je=["innerHTML"],Ee={key:0,class:"continue-indicator"};function Ne(t,e,a,f,c,r){const d=P("EmojiToIcon"),s=P("Illustration"),y=P("DXCombo"),m=P("StatusChange");return o(),n("div",{class:b(["dialog-box",{"dialog-system":a.stepType==="system","dialog-narrator":a.stepType==="narrator","dialog-scene-description":a.stepType==="scene-description"}]),style:C({borderColor:a.characterColor}),onClick:e[0]||(e[0]=(...p)=>r.handleClick&&r.handleClick(...p))},[a.characterName?(o(),n("div",{key:0,class:"character-name",style:C({color:a.characterColor})},l(a.characterName),5)):u("",!0),a.text&&a.text.trim().length>0?(o(),n("div",{key:1,class:b(["dialog-text",{"is-typing":c.isTyping,"is-narration":!a.characterName}])},[i("p",{class:"text-content",innerHTML:r.decodedText},null,8,je),!c.isTyping&&!c.isComplete?(o(),n("div",Ee,[h(d,{emoji:"‚ñº",size:12})])):u("",!0)],2)):u("",!0),a.illustrations&&a.illustrations.length>0?(o(),S(s,{key:2,illustrations:a.illustrations},null,8,["illustrations"])):u("",!0),a.dxCombos&&a.dxCombos.length>0?(o(),S(y,{key:3,dxCombos:a.dxCombos},null,8,["dxCombos"])):u("",!0),a.statusChanges&&a.statusChanges.length>0?(o(),S(m,{key:4,statusChanges:a.statusChanges},null,8,["statusChanges"])):u("",!0)],6)}const Vs=k($e,[["render",Ne],["__scopeId","data-v-49fa8f30"]]),De={name:"CharacterDisplay",props:{currentStep:{type:Object,default:null},characters:{type:Object,default:()=>({})},maxVisibleCharacters:{type:Number,default:3},layout:{type:String,default:"single",validator:t=>["single","left","center","right"].includes(t)}},data(){return{activeCharacterIds:[],failedImageIds:new Set}},computed:{speakingCharacterId(){var t;return!this.currentStep||this.currentStep.type==="system"||this.currentStep.type==="narrator"?null:((t=this.currentStep.character)==null?void 0:t.id)||null},currentCharacter(){return this.currentStep?this.getCurrentCharacter():null}},methods:{getCurrentCharacter(){if(!this.currentStep||!this.currentStep.character)return null;const t=this.currentStep.character;return{id:t.id||t.name,name:t.name,avatarUrl:t.avatarUrl,color:t.color,emotion:t.emotion||"default"}},getCharacterStyle(t){const e={};return t.color&&t.id===this.speakingCharacterId&&(e.borderColor=t.color),e},handleImageError(t){console.warn(`Ï∫êÎ¶≠ÌÑ∞ Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®: ${t.name}`),this.failedImageIds.add(t.id),this.$forceUpdate()}},watch:{currentStep:{handler(t){if(!t)return;const e=this.speakingCharacterId;e&&!this.activeCharacterIds.includes(e)&&(this.activeCharacterIds.push(e),this.activeCharacterIds.length>this.maxVisibleCharacters&&this.activeCharacterIds.shift())},immediate:!0}}},Ve={class:"character-display"},Ue={class:"character-container"},Ge={class:"character-avatar"},ze=["src","alt"];function He(t,e,a,f,c,r){return o(),n("div",Ve,[i("div",Ue,[h(v,{name:"character-fade",mode:"out-in"},{default:_(()=>[r.currentCharacter&&r.currentCharacter.avatarUrl&&!c.failedImageIds.has(r.currentCharacter.id)?(o(),n("div",{key:r.currentCharacter.id,class:b(["character-wrapper",{"is-speaking":r.currentCharacter.id===r.speakingCharacterId}]),style:C(r.getCharacterStyle(r.currentCharacter))},[i("div",Ge,[i("img",{src:r.currentCharacter.avatarUrl,alt:r.currentCharacter.name,onError:e[0]||(e[0]=d=>r.handleImageError(r.currentCharacter))},null,40,ze)])],6)):u("",!0)]),_:1})])])}const Us=k(De,[["render",He],["__scopeId","data-v-b271bfe7"]]),Oe={name:"PlaybackControls",data(){return{speedOptions:[.5,1,1.2,2]}},props:{currentStepNumber:{type:Number,required:!0},totalSteps:{type:Number,required:!0},currentSceneName:{type:String,default:""},hasPreviousStep:{type:Boolean,default:!1},hasNextStep:{type:Boolean,default:!0},autoPlayEnabled:{type:Boolean,default:!1},autoPlaySpeed:{type:Number,default:1},showProgressBar:{type:Boolean,default:!0},showSceneSelector:{type:Boolean,default:!1}},computed:{progressPercentage(){return this.totalSteps===0?0:this.currentStepNumber/this.totalSteps*100}},methods:{handleSceneSelectorClick(){console.log("[PlaybackControls] Ïî¨ ÏÑ†ÌÉù Î≤ÑÌäº ÌÅ¥Î¶≠Îê®"),console.log("[PlaybackControls] showSceneSelector prop:",this.showSceneSelector),this.$emit("open-scene-selector"),console.log("[PlaybackControls] open-scene-selector Ïù¥Î≤§Ìä∏ emit ÏôÑÎ£å")}}},Ye={class:"playback-controls"},Le={key:0,class:"progress-bar"},Fe={class:"progress-info"},qe={class:"scene-name"},Ke={class:"step-counter"},Xe={class:"controls-buttons"},Je=["disabled"],Qe=["disabled"],We={class:"speed-control"},Ze=["onClick","title"],et={key:1,class:"step-counter"};function tt(t,e,a,f,c,r){const d=P("EmojiToIcon");return o(),n("div",Ye,[a.showProgressBar?(o(),n("div",Le,[i("div",{class:"progress-fill",style:C({width:r.progressPercentage+"%"})},null,4),i("div",Fe,[i("span",qe,l(a.currentSceneName),1),i("span",Ke,l(a.currentStepNumber)+" / "+l(a.totalSteps),1)])])):u("",!0),i("div",Xe,[i("button",{class:"control-button",onClick:e[0]||(e[0]=s=>t.$emit("previous")),disabled:!a.hasPreviousStep,title:"Ïù¥Ï†Ñ (‚Üê)"},[h(d,{emoji:"‚èÆÔ∏è",size:20})],8,Je),i("button",{class:"control-button primary",onClick:e[1]||(e[1]=s=>t.$emit("next")),disabled:!a.hasNextStep,title:"Îã§Ïùå (‚Üí / Space)"},[h(d,{emoji:"‚ñ∂Ô∏è",size:24})],8,Qe),i("button",{class:b(["control-button",{"is-active":a.autoPlayEnabled}]),onClick:e[2]||(e[2]=s=>t.$emit("toggle-autoplay")),title:"ÏûêÎèô Ïû¨ÏÉù"},[h(d,{emoji:a.autoPlayEnabled?"‚è∏Ô∏è":"‚èØÔ∏è",size:20},null,8,["emoji"])],2),i("div",We,[(o(!0),n(g,null,T(c.speedOptions,s=>(o(),n("button",{key:s,class:b(["speed-button",{"is-active":a.autoPlaySpeed===s}]),onClick:y=>t.$emit("change-speed",s),title:s+"Î∞∞ÏÜç"},l(s)+"x ",11,Ze))),128))]),a.showSceneSelector?(o(),n("button",{key:0,class:"control-button",onClick:e[3]||(e[3]=(...s)=>r.handleSceneSelectorClick&&r.handleSceneSelectorClick(...s)),title:"Ïî¨ ÏÑ†ÌÉù"},[h(d,{emoji:"üìë",size:20})])):u("",!0),a.showProgressBar?u("",!0):(o(),n("div",et,l(a.currentStepNumber)+" / "+l(a.totalSteps),1))])])}const Gs=k(Oe,[["render",tt],["__scopeId","data-v-c19d5e78"]]),st={name:"SceneSelectorModal",props:{isVisible:{type:Boolean,default:!1},scenes:{type:Array,default:()=>[]},currentSceneIndex:{type:Number,default:0},currentStepIndex:{type:Number,default:0},closeOnOverlayClick:{type:Boolean,default:!0}},data(){return{expandedScenes:new Set}},methods:{close(){this.$emit("close")},handleOverlayClick(){this.closeOnOverlayClick&&this.close()},toggleScene(t){this.expandedScenes.has(t)?this.expandedScenes.delete(t):this.expandedScenes.add(t),this.$forceUpdate()},goToStep(t,e){this.$emit("go-to-step",t,e),this.close()},getStepPreview(t){return t?t.length>50?t.substring(0,50)+"...":t:"(ÌÖçÏä§Ìä∏ ÏóÜÏùå)"},handleKeyPress(t){t.key==="Escape"&&this.isVisible&&this.close()},initExpandedScenes(){this.currentSceneIndex!==null&&this.expandedScenes.add(this.currentSceneIndex)},scrollToCurrentScene(){setTimeout(()=>{this.$nextTick(()=>{const t=this.$refs.currentStep;if(t){const e=Array.isArray(t)?t[0]:t;e&&e.scrollIntoView({behavior:"smooth",block:"center"})}})},250)}},watch:{isVisible:{immediate:!0,handler(t){t?(this.initExpandedScenes(),window.addEventListener("keydown",this.handleKeyPress),document.body.style.overflow="hidden",this.scrollToCurrentScene()):(window.removeEventListener("keydown",this.handleKeyPress),document.body.style.overflow="",this.expandedScenes.clear())}},currentSceneIndex:{handler(t){this.isVisible&&t!==null&&(this.expandedScenes.add(t),this.$forceUpdate())}}},beforeUnmount(){window.removeEventListener("keydown",this.handleKeyPress),document.body.style.overflow=""}},it={class:"modal-header"},at={class:"modal-title"},ot={class:"modal-content"},nt=["onClick"],lt={class:"scene-info"},rt={class:"scene-number"},ut={class:"scene-name"},dt={class:"scene-meta"},ct={class:"step-count"},ht={key:0,class:"steps-list"},yt=["onClick"],mt={class:"step-number"},ft={class:"step-preview"},pt={class:"step-text"},gt={key:0,class:"empty-state"},_t={class:"modal-footer"},bt={class:"footer-info"};function vt(t,e,a,f,c,r){const d=P("EmojiToIcon");return o(),S(v,{name:"modal-overlay"},{default:_(()=>[a.isVisible?(o(),n("div",{key:0,class:"modal-overlay",onClick:e[3]||(e[3]=(...s)=>r.handleOverlayClick&&r.handleOverlayClick(...s))},[i("div",{class:"modal-container",onClick:e[2]||(e[2]=I(()=>{},["stop"]))},[i("div",it,[i("h2",at,[h(d,{emoji:"üìë",size:24}),e[4]||(e[4]=x(" Ïî¨ ÏÑ†ÌÉù ",-1))]),i("button",{class:"close-button",onClick:e[0]||(e[0]=(...s)=>r.close&&r.close(...s)),title:"Îã´Í∏∞ (ESC)"},[h(d,{emoji:"‚úñÔ∏è",size:20})])]),i("div",ot,[(o(!0),n(g,null,T(a.scenes,(s,y)=>(o(),n("div",{key:`scene-${y}`,class:b(["scene-item",{"is-current":y===a.currentSceneIndex}])},[i("div",{class:"scene-header",onClick:m=>r.toggleScene(y)},[i("div",lt,[i("span",rt,"Ïî¨ "+l(y+1),1),i("h3",ut,l(s.name||"Ï†úÎ™© ÏóÜÏùå"),1)]),i("div",dt,[i("span",ct,l(s.steps.length)+"Í∞ú Ïä§ÌÖù",1),h(d,{emoji:c.expandedScenes.has(y)?"üîΩ":"‚ñ∂Ô∏è",size:16,class:"expand-icon"},null,8,["emoji"])])],8,nt),h(v,{name:"steps-expand"},{default:_(()=>[c.expandedScenes.has(y)?(o(),n("div",ht,[(o(!0),n(g,null,T(s.steps,(m,p)=>{var w;return o(),n("div",{key:`step-${y}-${p}`,ref_for:!0,ref:y===a.currentSceneIndex&&p===a.currentStepIndex?"currentStep":null,class:b(["step-item",{"is-current":y===a.currentSceneIndex&&p===a.currentStepIndex}]),onClick:Ns=>r.goToStep(y,p)},[i("span",mt,l(p+1),1),i("div",ft,[(w=m.character)!=null&&w.name?(o(),n("span",{key:0,class:"step-character",style:C({color:m.character.color||"#ffffff"})},l(m.character.name)+": ",5)):u("",!0),i("span",pt,l(r.getStepPreview(m.text)),1)]),y===a.currentSceneIndex&&p===a.currentStepIndex?(o(),S(d,{key:0,emoji:"‚ñ∂Ô∏è",size:14,class:"current-indicator"})):u("",!0)],10,yt)}),128))])):u("",!0)]),_:2},1024)],2))),128)),a.scenes.length===0?(o(),n("div",gt,[h(d,{emoji:"üì≠",size:48}),e[5]||(e[5]=i("p",null,"Ïî¨Ïù¥ ÏóÜÏäµÎãàÎã§",-1))])):u("",!0)]),i("div",_t,[i("div",bt,[h(d,{emoji:"‚ÑπÔ∏è",size:14}),e[6]||(e[6]=i("span",null,"Ïî¨ÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÌéºÏπòÍ≥†, Ïä§ÌÖùÏùÑ ÏÑ†ÌÉùÌïòÏó¨ Ïù¥ÎèôÌï©ÎãàÎã§.",-1))]),i("button",{class:"action-button primary",onClick:e[1]||(e[1]=(...s)=>r.close&&r.close(...s))}," Îã´Í∏∞ ")])])])):u("",!0)]),_:1})}const zs=k(st,[["render",vt],["__scopeId","data-v-94d16136"]]),Pt={name:"DiceRoll",props:{diceRolls:{type:Array,default:()=>[]},characterName:{type:String,default:""},characterColor:{type:String,default:"#ffffff"},animated:{type:Boolean,default:!0},animationDuration:{type:Number,default:800},playSoundEffect:{type:Boolean,default:!1}},data(){return{processedRolls:[],audioContext:null}},watch:{diceRolls:{immediate:!0,handler(t){this.processRolls(t)}}},methods:{processRolls(t){if(!t||t.length===0){this.processedRolls=[];return}this.processedRolls=t.map((e,a)=>({...e,isAnimating:!1,showResult:e.type==="choice"||e.type==="judgement",showDetails:!1})),this.animated?this.processedRolls.forEach((e,a)=>{e.type==="choice"||e.type==="judgement"||setTimeout(()=>{this.animateRoll(a)},a*200)}):this.processedRolls.forEach(e=>{e.showResult=!0})},animateRoll(t){const e=this.processedRolls[t];e&&(e.isAnimating=!0,this.playSoundEffect&&this.playDiceSound(),setTimeout(()=>{e.isAnimating=!1,e.showResult=!0},this.animationDuration))},toggleDetails(t){const e=this.processedRolls[t];e&&(e.showDetails=!e.showDetails)},playDiceSound(){this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext));const t=this.audioContext,e=t.createOscillator(),a=t.createGain();e.connect(a),a.connect(t.destination),e.type="square",e.frequency.setValueAtTime(200,t.currentTime),e.frequency.exponentialRampToValueAtTime(100,t.currentTime+.1),a.gain.setValueAtTime(.1,t.currentTime),a.gain.exponentialRampToValueAtTime(.01,t.currentTime+.1),e.start(t.currentTime),e.stop(t.currentTime+.1)}}},Tt={class:"dice-roll-container"},kt={class:"dice-icon-wrapper"},Ct={class:"dice-result choice-result"},St=["onClick","title"],wt={key:0,class:"dice-details choice-options"},xt={key:1,class:"ougi-full-wrapper"},It={class:"ougi-header"},At={class:"dice-icon-wrapper"},Bt={class:"ougi-info"},Mt={class:"ougi-title-line"},Rt={class:"ougi-name"},$t={class:"ougi-main-name"},jt={class:"ougi-info-table"},Et={key:0},Nt={key:0},Dt={class:"ougi-presentation"},Vt={key:1},Ut={key:2},Gt={class:"ougi-ninpou"},zt={class:"shinobigami-full-wrapper"},Ht={class:"shinobigami-header"},Ot={class:"dice-icon-wrapper"},Yt={class:"shinobigami-info"},Lt={class:"shinobigami-main"},Ft={class:"dice-formula"},qt={class:"shinobigami-result-line"},Kt={key:1,class:"dice-placeholder"},Xt={class:"shinobigami-judgement"},Jt={key:0,class:"shinobigami-info-table"},Qt={key:0},Wt={key:1},Zt={key:2},es={key:3},ts={key:4},ss=["onClick","title"],is={key:0,class:"dice-details shinobigami-details"},as={class:"shinobigami-formula"},os={class:"shinobigami-rolls"},ns={key:0},ls={key:1},rs={class:"judgement-header"},us={class:"dice-icon-wrapper"},ds={class:"judgement-info"},cs={class:"judgement-main"},hs={class:"dice-formula"},ys={class:"judgement-result-line"},ms={key:1,class:"dice-placeholder"},fs={class:"judgement-text"},ps=["onClick","title"],gs={key:0,class:"dice-details"},_s={class:"dice-formula"},bs={key:1,class:"dice-placeholder"},vs={key:0,class:"dice-details-wrapper"},Ps=["onClick","title"],Ts={key:0,class:"dice-details"};function ks(t,e,a,f,c,r){const d=P("EmojiToIcon");return o(),n("div",Tt,[h(A,{name:"dice-list",tag:"div",class:"dice-rolls"},{default:_(()=>[(o(!0),n(g,null,T(c.processedRolls,(s,y)=>(o(),n("div",{key:`${s.formula}-${y}`,class:b(["dice-roll",[{"is-animating":s.isAnimating},`roll-type-${s.type}`]])},[s.type==="choice"?(o(),n(g,{key:0},[i("div",kt,[h(d,{emoji:"üéØ",size:18,class:"dice-icon"})]),e[0]||(e[0]=i("span",{class:"dice-formula"},"ÏÑ†ÌÉù",-1)),e[1]||(e[1]=i("span",{class:"dice-arrow"},"‚Üí",-1)),i("span",Ct,l(s.result),1),i("button",{class:"details-toggle",onClick:m=>r.toggleDetails(y),title:s.showDetails?"ÏòµÏÖò Ïà®Í∏∞Í∏∞":"ÏòµÏÖò Î≥¥Í∏∞"},[h(d,{emoji:s.showDetails?"üîΩ":"‚ñ∂Ô∏è",size:12},null,8,["emoji"])],8,St),h(v,{name:"details-expand"},{default:_(()=>[s.showDetails?(o(),n("div",wt,[(o(!0),n(g,null,T(s.options,(m,p)=>(o(),n("span",{key:p,class:"choice-option"},l(m),1))),128))])):u("",!0)]),_:2},1024)],64)):s.type==="ougi"?(o(),n("div",xt,[i("div",It,[i("div",At,[h(d,{emoji:"üåü",size:20,class:"dice-icon"})]),i("div",Bt,[i("div",Mt,[i("span",{class:"ougi-character",style:C({color:a.characterColor})},l(a.characterName),5),i("span",Rt,"„ÄêÂ••Áæ©: "+l(s.ougiType)+"„Äë",1),i("span",$t,l(s.ougiName),1)]),i("table",jt,[i("tbody",null,[i("tr",null,[e[2]||(e[2]=i("th",null,"ÏßÄÏ†ï ÌäπÍ∏∞",-1)),i("td",null,[(o(!0),n(g,null,T(s.skills,(m,p)=>(o(),n("span",{key:p,class:"ougi-skill"},[x(" „Ää"+l(m)+"„Äã",1),p<s.skills.length-1?(o(),n("span",Et,", ")):u("",!0)]))),128))])]),s.presentation?(o(),n("tr",Nt,[e[3]||(e[3]=i("th",null,"Ïó∞Ï∂ú",-1)),i("td",Dt,l(s.presentation),1)])):u("",!0),s.ougiEffect?(o(),n("tr",Vt,[e[4]||(e[4]=i("th",null,"Ìö®Í≥º",-1)),i("td",null,l(s.ougiEffect),1)])):u("",!0),s.ninpouInfo?(o(),n("tr",Ut,[e[5]||(e[5]=i("th",null,"Ïù∏Î≤ï",-1)),i("td",Gt,l(s.ninpouInfo),1)])):u("",!0)])])])])])):s.type==="shinobigami"?(o(),n(g,{key:2},[i("div",zt,[i("div",Ht,[i("div",Ot,[h(d,{emoji:"‚öîÔ∏è",size:18,class:"dice-icon"})]),i("div",Yt,[i("div",Lt,[i("span",{class:"shinobigami-character",style:C({color:a.characterColor})},l(a.characterName),5),i("span",Ft,"„Äê"+l(s.checkName)+"„Äë",1)]),i("div",qt,[e[6]||(e[6]=i("span",{class:"dice-arrow"},"‚Üí",-1)),h(v,{name:"dice-result",mode:"out-in"},{default:_(()=>[s.showResult?(o(),n("span",{key:s.result,class:"dice-result"},l(s.result),1)):(o(),n("span",Kt,"???"))]),_:2},1024),i("span",Xt,l(s.judgement),1)]),s.additionalInfo?(o(),n("table",Jt,[i("tbody",null,[s.additionalInfo.type?(o(),n("tr",Qt,[e[7]||(e[7]=i("th",null,"ÌÉÄÏûÖ",-1)),i("td",null,l(s.additionalInfo.type),1)])):u("",!0),s.additionalInfo.range?(o(),n("tr",Wt,[e[8]||(e[8]=i("th",null,"Í∞ÑÍ≤©",-1)),i("td",null,l(s.additionalInfo.range.replace("Í∞ÑÍ≤©:","").trim()),1)])):u("",!0),s.additionalInfo.cost?(o(),n("tr",Zt,[e[9]||(e[9]=i("th",null,"ÏΩîÏä§Ìä∏",-1)),i("td",null,l(s.additionalInfo.cost.replace("ÏΩîÏä§Ìä∏:","").trim()),1)])):u("",!0),s.additionalInfo.skill?(o(),n("tr",es,[e[10]||(e[10]=i("th",null,"ÌäπÍ∏∞",-1)),i("td",null,l(s.additionalInfo.skill),1)])):u("",!0),s.additionalInfo.description?(o(),n("tr",ts,[e[11]||(e[11]=i("th",null,"ÏÑ§Î™Ö",-1)),i("td",null,l(s.additionalInfo.description),1)])):u("",!0)])])):u("",!0)])])]),i("button",{class:"details-toggle",onClick:m=>r.toggleDetails(y),title:s.showDetails?"ÏÉÅÏÑ∏ Ïà®Í∏∞Í∏∞":"ÏÉÅÏÑ∏ Î≥¥Í∏∞"},[h(d,{emoji:s.showDetails?"üîΩ":"‚ñ∂Ô∏è",size:12},null,8,["emoji"])],8,ss),h(v,{name:"details-expand"},{default:_(()=>[s.showDetails?(o(),n("div",is,[i("div",as,l(s.command),1),i("div",os,[s.diceExpression?(o(),n("span",ns,"Ï£ºÏÇ¨ÏúÑ: "+l(s.diceExpression),1)):(o(),n("span",ls,"Í∞úÎ≥Ñ Ï£ºÏÇ¨ÏúÑ: "+l(s.diceRolls),1))])])):u("",!0)]),_:2},1024)],64)):s.type==="judgement"?(o(),n(g,{key:3},[i("div",rs,[i("div",us,[h(d,{emoji:"‚öñÔ∏è",size:18,class:"dice-icon"})]),i("div",ds,[i("div",cs,[i("span",{class:"judgement-character",style:C({color:a.characterColor})},l(a.characterName),5),i("span",hs,l(s.checkName),1)]),i("div",ys,[e[12]||(e[12]=i("span",{class:"dice-arrow"},"‚Üí",-1)),h(v,{name:"dice-result",mode:"out-in"},{default:_(()=>[s.showResult?(o(),n("span",{key:s.result,class:"dice-result"},l(s.result),1)):(o(),n("span",ms,"???"))]),_:2},1024),i("span",fs,l(s.judgement),1)])])]),i("button",{class:"details-toggle",onClick:m=>r.toggleDetails(y),title:s.showDetails?"ÏÉÅÏÑ∏ Ïà®Í∏∞Í∏∞":"ÏÉÅÏÑ∏ Î≥¥Í∏∞"},[h(d,{emoji:s.showDetails?"üîΩ":"‚ñ∂Ô∏è",size:12},null,8,["emoji"])],8,ps),h(v,{name:"details-expand"},{default:_(()=>[s.showDetails?(o(),n("div",gs,l(s.formula),1)):u("",!0)]),_:2},1024)],64)):(o(),n(g,{key:4},[i("div",{class:b(["dice-icon-wrapper",{"is-rolling":s.isAnimating}])},[h(d,{emoji:"üé≤",size:18,class:"dice-icon"})],2),i("span",_s,l(s.formula),1),e[13]||(e[13]=i("span",{class:"dice-arrow"},"‚Üí",-1)),h(v,{name:"dice-result",mode:"out-in"},{default:_(()=>[s.showResult?(o(),n("span",{key:s.result,class:"dice-result"},l(s.result),1)):(o(),n("span",bs,"???"))]),_:2},1024),s.type==="dx3"&&s.diceRolls?(o(),n("div",vs,[i("button",{class:"details-toggle",onClick:m=>r.toggleDetails(y),title:s.showDetails?"ÏÉÅÏÑ∏ Ïà®Í∏∞Í∏∞":"ÏÉÅÏÑ∏ Î≥¥Í∏∞"},[h(d,{emoji:s.showDetails?"üîΩ":"‚ñ∂Ô∏è",size:12},null,8,["emoji"])],8,Ps),h(v,{name:"details-expand"},{default:_(()=>[s.showDetails?(o(),n("div",Ts,l(s.diceRolls),1)):u("",!0)]),_:2},1024)])):u("",!0)],64))],2))),128))]),_:1})])}const Hs=k(Pt,[["render",ks],["__scopeId","data-v-3b3fb983"]]),Cs={name:"BGMPlayer",props:{bgmUrl:{type:String,default:""},bgmType:{type:String,default:"youtube",validator:t=>["youtube","audio"].includes(t)},volume:{type:Number,default:.5},autoPlay:{type:Boolean,default:!1},showControls:{type:Boolean,default:!0}},data(){return{isPlaying:!1,isPaused:!1,isMuted:!1,currentVolume:this.volume,youtubePlayer:null,youtubeApiReady:!1,shouldBePlaying:!1,resumeTimer:null,userGestureArmed:!1,autoMutedForAutoplay:!1,hasUserToggledMute:!1}},computed:{youtubeVideoId(){if(this.bgmType!=="youtube"||!this.bgmUrl)return"";const t=[/(?:youtube\.com\/watch\?v=)([\w-]+)/,/(?:youtu\.be\/)([\w-]+)/,/(?:youtube\.com\/embed\/)([\w-]+)/,/^([\w-]{11})$/];for(const e of t){const a=this.bgmUrl.match(e);if(a)return a[1]}return""}},watch:{bgmUrl(t,e){t&&t!==e?(this.stopPlayer(),this.isPlaying=!1,this.isPaused=!1,this.autoMutedForAutoplay=!1,this.hasUserToggledMute||(this.isMuted=!1),this.initializePlayer()):t||this.stopPlayer()},autoPlay(t,e){this.bgmUrl&&(t&&!e&&(this.shouldBePlaying=!0,this.$nextTick(()=>{this.startPlayback("autoPlay-prop-enabled")})),!t&&e&&this.stopPlayer())},volume(t){this.currentVolume=t,this.updateVolume()}},methods:{clearResumeTimer(){this.resumeTimer&&(clearTimeout(this.resumeTimer),this.resumeTimer=null)},scheduleResumeYouTube(t=""){this.bgmType==="youtube"&&this.youtubePlayer&&this.shouldBePlaying&&(document.hidden||(this.clearResumeTimer(),this.resumeTimer=setTimeout(()=>{if(this.resumeTimer=null,!(!this.youtubePlayer||!this.shouldBePlaying||document.hidden))try{console.warn("[BGMPlayer] YouTube Ïû¨ÏÉù Ïû¨ÏãúÎèÑ:",t),this.youtubePlayer.playVideo()}catch(e){console.warn("[BGMPlayer] YouTube Ïû¨ÏãúÎèÑ Ïã§Ìå®:",e)}},800)))},armUserGestureResume(){if(this.userGestureArmed)return;this.userGestureArmed=!0;const t=()=>{this.userGestureArmed=!1,this.shouldBePlaying&&this.resumePlayback("user-gesture")};window.addEventListener("pointerdown",t,{once:!0,passive:!0}),window.addEventListener("keydown",t,{once:!0})},resumePlayback(t=""){if(this.bgmUrl){if(this.bgmType==="audio"){const e=this.$refs.audioPlayer;if(!e)return;e.play().then(()=>{console.warn("[BGMPlayer] Ïò§ÎîîÏò§ Ïû¨ÏÉù Ïû¨ÏãúÎèÑ ÏÑ±Í≥µ:",t),this.isPlaying=!0,this.isPaused=!1}).catch(a=>{console.warn("[BGMPlayer] Ïò§ÎîîÏò§ Ïû¨ÏÉù Ïû¨ÏãúÎèÑ Ïã§Ìå®:",t,a),this.isPlaying=!1,this.isPaused=!0,this.armUserGestureResume()});return}if(this.bgmType==="youtube"&&this.youtubePlayer)try{console.warn("[BGMPlayer] YouTube Ïû¨ÏÉù Ïû¨ÏãúÎèÑ:",t),this.youtubePlayer.playVideo()}catch(e){console.warn("[BGMPlayer] YouTube Ïû¨ÏÉù Ïû¨ÏãúÎèÑ Ïã§Ìå®:",t,e),this.armUserGestureResume()}}},startPlayback(t=""){if(this.bgmUrl){if(this.bgmType==="audio"){const e=this.$refs.audioPlayer;if(!e)return;e.muted=this.isMuted,this.autoPlay&&(this.shouldBePlaying=!0),e.play().then(()=>{this.isPlaying=!0,this.isPaused=!1}).catch(a=>{console.warn("[BGMPlayer] Ïû¨ÏÉù ÏãúÏûë Ïã§Ìå®(Ìè¥Î∞± ÏãúÎèÑ):",t,a),this.isPlaying=!1,this.isPaused=!0,this.autoPlay&&!this.isMuted?(this.isMuted=!0,this.autoMutedForAutoplay=!0,e.muted=!0,e.play().then(()=>{this.isPlaying=!0,this.isPaused=!1}).catch(f=>{console.warn("[BGMPlayer] ÎÆ§Ìä∏ Ìè¥Î∞±ÎèÑ Ïã§Ìå®(Ï†úÏä§Ï≤ò ÌïÑÏöî Í∞ÄÎä•):",t,f),this.isPlaying=!1,this.isPaused=!0,this.armUserGestureResume()})):this.armUserGestureResume()});return}if(this.bgmType==="youtube"&&this.youtubePlayer){this.autoPlay&&(this.shouldBePlaying=!0);try{this.isMuted?this.youtubePlayer.mute():this.youtubePlayer.unMute(),this.youtubePlayer.playVideo()}catch(e){console.warn("[BGMPlayer] YouTube Ïû¨ÏÉù ÏãúÏûë Ïã§Ìå®(Ï†úÏä§Ï≤ò ÌïÑÏöî Í∞ÄÎä•):",t,e),this.armUserGestureResume();return}this.autoPlay&&setTimeout(()=>{if(!this.youtubePlayer||!this.shouldBePlaying||document.hidden)return;if((typeof this.youtubePlayer.getPlayerState=="function"?this.youtubePlayer.getPlayerState():null)!==1){if(!this.isMuted){this.isMuted=!0,this.autoMutedForAutoplay=!0;try{this.youtubePlayer.mute()}catch{}}try{this.youtubePlayer.playVideo()}catch{}this.armUserGestureResume()}},900)}}},loadYouTubeAPI(){if(window.YT&&window.YT.Player){this.youtubeApiReady=!0;return}if(!document.getElementById("youtube-iframe-api")){const t=document.createElement("script");t.id="youtube-iframe-api",t.src="https://www.youtube.com/iframe_api";const e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e);const a=window.onYouTubeIframeAPIReady;window.onYouTubeIframeAPIReady=()=>{try{typeof a=="function"&&a()}finally{this.youtubeApiReady=!0,this.initYouTubePlayer()}}}},initializePlayer(){this.$nextTick(()=>{this.bgmType==="youtube"?(this.loadYouTubeAPI(),this.youtubeApiReady&&this.initYouTubePlayer()):this.bgmType==="audio"&&this.initAudioPlayer()})},initYouTubePlayer(){!this.youtubeApiReady||!this.youtubeVideoId||(this.youtubePlayer&&(this.youtubePlayer.destroy(),this.youtubePlayer=null),this.$nextTick(()=>{this.youtubePlayer=new window.YT.Player(this.$refs.youtubeIframe,{height:"1",width:"1",videoId:this.youtubeVideoId,playerVars:{autoplay:this.autoPlay?1:0,loop:1,playlist:this.youtubeVideoId,controls:0,disablekb:1,fs:0,modestbranding:1,playsinline:1,origin:window.location.origin},events:{onReady:t=>{if(t.target.setVolume(this.currentVolume*100),this.autoPlay){this.shouldBePlaying=!0;try{this.isMuted?t.target.mute():t.target.unMute(),t.target.playVideo()}catch{this.armUserGestureResume()}setTimeout(()=>{if(!this.youtubePlayer||!this.shouldBePlaying||document.hidden)return;if((typeof this.youtubePlayer.getPlayerState=="function"?this.youtubePlayer.getPlayerState():null)!==1){if(!this.isMuted){this.isMuted=!0,this.autoMutedForAutoplay=!0;try{this.youtubePlayer.mute()}catch{}}try{this.youtubePlayer.playVideo()}catch{}this.armUserGestureResume()}},900)}},onStateChange:t=>{t.data===1?(this.isPlaying=!0,this.isPaused=!1):t.data===2?(this.isPlaying=!1,this.isPaused=!0,this.scheduleResumeYouTube("paused"),this.shouldBePlaying&&this.armUserGestureResume()):t.data===0||t.data===-1?(this.isPlaying=!1,this.isPaused=!1,this.scheduleResumeYouTube(t.data===0?"ended":"unstarted"),this.shouldBePlaying&&this.armUserGestureResume()):t.data===3&&this.scheduleResumeYouTube("buffering")},onError:t=>{console.error("[BGMPlayer] YouTube Ïû¨ÏÉù Ïò§Î•ò:",{code:t==null?void 0:t.data,url:this.bgmUrl,videoId:this.youtubeVideoId}),this.$emit("error","YouTube BGM Ïû¨ÏÉùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. (ÏûÑÎ≤†Îìú Ï†úÌïú/ÌôïÏû•ÌîÑÎ°úÍ∑∏Îû® Ï∞®Îã® Í∞ÄÎä•)"),this.scheduleResumeYouTube("error"),this.armUserGestureResume()}}})}))},initAudioPlayer(){const t=this.$refs.audioPlayer;t&&(t.volume=this.currentVolume,t.muted=this.isMuted,this.autoPlay&&(this.shouldBePlaying=!0,t.play().then(()=>{this.isPlaying=!0,this.isPaused=!1}).catch(e=>{console.warn("[BGMPlayer] ÏûêÎèôÏû¨ÏÉù Ïã§Ìå®(Ìè¥Î∞± ÏãúÎèÑ):",e),this.isPlaying=!1,this.isPaused=!0,this.isMuted?this.armUserGestureResume():(this.isMuted=!0,this.autoMutedForAutoplay=!0,t.muted=!0,t.play().then(()=>{this.isPlaying=!0,this.isPaused=!1}).catch(a=>{console.warn("[BGMPlayer] ÎÆ§Ìä∏ Ìè¥Î∞±ÎèÑ Ïã§Ìå®(Ï†úÏä§Ï≤ò ÌïÑÏöî Í∞ÄÎä•):",a),this.isPlaying=!1,this.isPaused=!0,this.armUserGestureResume()}))})))},togglePlay(){if(this.bgmType==="audio"){const t=this.$refs.audioPlayer;t&&(this.isPlaying?(this.shouldBePlaying=!1,this.autoMutedForAutoplay=!1,t.pause(),this.isPlaying=!1,this.isPaused=!0):(this.shouldBePlaying=!0,this.autoMutedForAutoplay=!1,t.play().then(()=>{this.isPlaying=!0,this.isPaused=!1}).catch(e=>{console.error("Ïû¨ÏÉù Ïã§Ìå®:",e),this.isPlaying=!1,this.isPaused=!0,this.armUserGestureResume()})))}else if(this.bgmType==="youtube"){if(!this.youtubePlayer)return;this.isPlaying?(this.shouldBePlaying=!1,this.autoMutedForAutoplay=!1,this.clearResumeTimer(),this.youtubePlayer.pauseVideo()):(this.shouldBePlaying=!0,this.autoMutedForAutoplay=!1,this.youtubePlayer.playVideo())}},toggleMute(){if(this.hasUserToggledMute=!0,this.isMuted=!this.isMuted,this.autoMutedForAutoplay=!1,this.bgmType==="audio"){const t=this.$refs.audioPlayer;t&&(t.muted=this.isMuted)}else this.bgmType==="youtube"&&this.youtubePlayer&&(this.isMuted?this.youtubePlayer.mute():this.youtubePlayer.unMute());!this.isMuted&&this.shouldBePlaying&&this.resumePlayback("unmute")},updateVolume(){if(this.bgmType==="audio"){const t=this.$refs.audioPlayer;t&&(t.volume=this.currentVolume)}else this.bgmType==="youtube"&&this.youtubePlayer&&this.youtubePlayer.setVolume(this.currentVolume*100)},stopPlayer(){if(this.shouldBePlaying=!1,this.clearResumeTimer(),this.bgmType==="audio"){const t=this.$refs.audioPlayer;t&&(t.pause(),t.currentTime=0)}else this.bgmType==="youtube"&&this.youtubePlayer&&this.youtubePlayer.stopVideo();this.isPlaying=!1,this.isPaused=!1},handleAudioError(t){console.error("Ïò§ÎîîÏò§ Î°úÎìú Ïã§Ìå®:",t),this.$emit("error","BGM ÌååÏùºÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.")}},mounted(){this.bgmUrl&&this.initializePlayer()},beforeUnmount(){this.stopPlayer(),this.youtubePlayer&&(this.youtubePlayer.destroy(),this.youtubePlayer=null)}},Ss={key:0,class:"bgm-player"},ws={key:0,class:"youtube-container"},xs={ref:"youtubeIframe"},Is=["src","autoplay"],As={key:2,class:"bgm-controls"},Bs=["title"],Ms={class:"bgm-info"},Rs={class:"bgm-status"},$s={class:"volume-control"},js=["title"];function Es(t,e,a,f,c,r){const d=P("EmojiToIcon");return a.bgmUrl?(o(),n("div",Ss,[a.bgmType==="youtube"&&r.youtubeVideoId?(o(),n("div",ws,[i("div",xs,null,512)])):a.bgmType==="audio"?(o(),n("audio",{key:1,ref:"audioPlayer",src:a.bgmUrl,autoplay:a.autoPlay,loop:"",onError:e[0]||(e[0]=(...s)=>r.handleAudioError&&r.handleAudioError(...s))},null,40,Is)):u("",!0),a.showControls?(o(),n("div",As,[i("button",{onClick:e[1]||(e[1]=(...s)=>r.togglePlay&&r.togglePlay(...s)),class:"bgm-button",title:c.isPlaying?"ÏùºÏãúÏ†ïÏßÄ":"Ïû¨ÏÉù"},[h(d,{emoji:c.isPlaying?"‚è∏Ô∏è":"‚ñ∂Ô∏è",size:16},null,8,["emoji"])],8,Bs),i("div",Ms,[e[5]||(e[5]=i("span",{class:"bgm-label"},"BGM",-1)),i("span",Rs,l(c.isPlaying?"Ïû¨ÏÉù Ï§ë":c.isPaused?"ÏùºÏãúÏ†ïÏßÄ":"Ï†ïÏßÄ"),1)]),i("div",$s,[i("button",{onClick:e[2]||(e[2]=(...s)=>r.toggleMute&&r.toggleMute(...s)),class:"volume-button",title:c.isMuted?"ÏùåÏÜåÍ±∞ Ìï¥Ï†ú":"ÏùåÏÜåÍ±∞"},[h(d,{emoji:c.isMuted?"üîá":"üîä",size:14},null,8,["emoji"])],8,js),B(i("input",{"onUpdate:modelValue":e[3]||(e[3]=s=>c.currentVolume=s),type:"range",min:"0",max:"1",step:"0.05",class:"volume-slider",onInput:e[4]||(e[4]=(...s)=>r.updateVolume&&r.updateVolume(...s))},null,544),[[M,c.currentVolume,void 0,{number:!0}]])])])):u("",!0)])):u("",!0)}const Os=k(Cs,[["render",Es],["__scopeId","data-v-e8e60b0d"]]);export{Os as B,Us as C,xe as D,Gs as P,zs as S,Hs as a,Vs as b};
