import{_ as T,c as o,f as d,F as g,m as C,r as k,o as n,n as v,a as i,d as h,t as l,g as P,l as S,w as _,T as b,h as I,e as x,q as A,i as j,v as E}from"./index-N7MTb__u.js";const $={name:"StatusChange",props:{statusChanges:{type:Array,default:()=>[]}},methods:{getStatusIcon(s){const e=s.toLowerCase();return e.includes("Ïπ®Ïãù")?"‚ö°":e.includes("hp")||e.includes("ÏÉùÎ™Ö")||e.includes("Ï≤¥Î†•")?"‚ù§Ô∏è":e.includes("mp")||e.includes("ÎßàÎÇò")||e.includes("ÎßàÎ†•")?"üíô":e.includes("san")||e.includes("Ï†ïÏã†")||e.includes("Ïù¥ÏÑ±")?"üß†":"üìä"}}},N={key:0,class:"status-change-container"},D={class:"status-icon"},V={class:"status-info"},R={class:"character-name"},B={class:"status-name"},z={class:"status-values"},H={class:"old-value"},M={class:"new-value"},O={key:1,class:"new-value"},U={key:2,class:"old-value"};function L(s,e,a,p,u,r){const c=k("EmojiToIcon");return a.statusChanges&&a.statusChanges.length>0?(n(),o("div",N,[(n(!0),o(g,null,C(a.statusChanges,(t,m)=>(n(),o("div",{key:m,class:v(["status-change",{"is-positive":t.delta>0,"is-negative":t.delta<0}])},[i("div",D,[h(c,{emoji:r.getStatusIcon(t.statusName),size:16},null,8,["emoji"])]),i("div",V,[i("span",R,l(t.characterName),1),i("span",B,l(t.statusName),1)]),i("div",z,[t.oldValue!==null&&t.newValue!==null?(n(),o(g,{key:0},[i("span",H,l(t.oldValue),1),e[0]||(e[0]=i("span",{class:"arrow"},"‚Üí",-1)),i("span",M,l(t.newValue),1)],64)):t.oldValue===null&&t.newValue!==null?(n(),o("span",O,l(t.newValue),1)):t.oldValue!==null&&t.newValue===null?(n(),o("span",U,l(t.oldValue),1)):d("",!0),t.delta!==0?(n(),o("span",{key:3,class:v(["delta",{"delta-positive":t.delta>0,"delta-negative":t.delta<0}])},l(t.delta>0?"+":"")+l(t.delta),3)):d("",!0)])],2))),128))])):d("",!0)}const Y=T($,[["render",L],["__scopeId","data-v-820fc90f"]]),q={name:"DXCombo",props:{dxCombos:{type:Array,default:()=>[]}},methods:{decodeHtml(s){if(!s)return s;const e=document.createElement("textarea");e.innerHTML=s;let a=e.value;return a=a.replace(/\\n/g,`
`),a=a.replace(/\\t/g,"	"),a=a.replace(/\\r/g,"\r"),a}}},G={key:0,class:"dx-combo-container"},X={class:"combo-header"},K={class:"combo-icon"},F={class:"combo-label"},J={key:0,class:"combo-name"},Q={key:1,class:"erosion-cost"},W={class:"combo-effects"},Z={class:"effect-name"},ee={class:"effect-level"},te={key:0,class:"combo-info-row"},se={key:0,class:"info-item"},ie={class:"info-value"},ae={key:1,class:"info-item"},ne={class:"info-value"},oe={key:2,class:"info-item"},le={class:"info-value"},re={key:3,class:"info-item"},de={class:"info-value"},ce={key:1,class:"combo-stats-row"},ue={key:0,class:"info-item"},he={class:"info-value"},me={key:1,class:"info-item"},ye={class:"info-value"},pe={key:2,class:"info-item"},fe={class:"info-value"},ge={key:3,class:"info-item"},_e={class:"info-value"},ve={key:2,class:"combo-description"},be={key:3,class:"combo-dice-roll"},ke={class:"dice-roll-header"},Ce={class:"dice-roll-content"},Te={class:"dice-formula"},Se={class:"dice-detail"},Pe={class:"dice-result"};function we(s,e,a,p,u,r){const c=k("EmojiToIcon");return a.dxCombos&&a.dxCombos.length>0?(n(),o("div",G,[(n(!0),o(g,null,C(a.dxCombos,(t,m)=>(n(),o("div",{key:m,class:"dx-combo"},[i("div",X,[i("div",K,[h(c,{emoji:"‚ö°",size:16})]),i("span",F,l(t.isSingleEffect?"Ïù¥ÌéôÌä∏":"ÏΩ§Î≥¥"),1),t.comboName?(n(),o("span",J,l(r.decodeHtml(t.comboName)),1)):d("",!0),t.erosionCost?(n(),o("span",Q,l(t.erosionCost)+"‚Üë",1)):d("",!0)]),i("div",W,[(n(!0),o(g,null,C(t.effects,(y,f)=>(n(),o("div",{key:f,class:"combo-effect"},[i("span",Z,l(r.decodeHtml(y.name)),1),i("span",ee,"Lv."+l(y.level),1)]))),128))]),t.timing||t.difficulty||t.target||t.range?(n(),o("div",te,[t.timing?(n(),o("span",se,[e[0]||(e[0]=i("span",{class:"info-label"},"ÌÉÄÏù¥Î∞ç:",-1)),i("span",ie,l(r.decodeHtml(t.timing)),1)])):d("",!0),t.difficulty?(n(),o("span",ae,[e[1]||(e[1]=i("span",{class:"info-label"},"ÎÇúÏù¥ÎèÑ:",-1)),i("span",ne,l(r.decodeHtml(t.difficulty)),1)])):d("",!0),t.target?(n(),o("span",oe,[e[2]||(e[2]=i("span",{class:"info-label"},"ÎåÄÏÉÅ:",-1)),i("span",le,l(r.decodeHtml(t.target)),1)])):d("",!0),t.range?(n(),o("span",re,[e[3]||(e[3]=i("span",{class:"info-label"},"ÏÇ¨Í±∞Î¶¨:",-1)),i("span",de,l(r.decodeHtml(t.range)),1)])):d("",!0)])):d("",!0),t.dice||t.critical||t.attack||t.erosion?(n(),o("div",ce,[t.dice?(n(),o("span",ue,[e[4]||(e[4]=i("span",{class:"info-label"},"Îã§Ïù¥Ïä§:",-1)),i("span",he,l(r.decodeHtml(t.dice)),1)])):d("",!0),t.critical?(n(),o("span",me,[e[5]||(e[5]=i("span",{class:"info-label"},"ÌÅ¨Î¶¨Ïπò:",-1)),i("span",ye,l(r.decodeHtml(t.critical)),1)])):d("",!0),t.attack?(n(),o("span",pe,[e[6]||(e[6]=i("span",{class:"info-label"},"Í≥µÍ≤©Î†•:",-1)),i("span",fe,l(r.decodeHtml(t.attack)),1)])):d("",!0),t.erosion?(n(),o("span",ge,[e[7]||(e[7]=i("span",{class:"info-label"},"Ïπ®Ïãù:",-1)),i("span",_e,l(r.decodeHtml(t.erosion)),1)])):d("",!0)])):d("",!0),t.description?(n(),o("div",ve,l(r.decodeHtml(t.description)),1)):d("",!0),t.diceRoll?(n(),o("div",be,[i("div",ke,[h(c,{emoji:"üé≤",size:14}),e[8]||(e[8]=i("span",{class:"dice-roll-label"},"ÌåêÏ†ï",-1))]),i("div",Ce,[i("span",Te,l(t.diceRoll.formula),1),e[9]||(e[9]=i("span",{class:"dice-separator"},"‚Üí",-1)),i("span",Se,l(t.diceRoll.diceRolls),1),e[10]||(e[10]=i("span",{class:"dice-separator"},"‚Üí",-1)),i("span",Pe,l(t.diceRoll.result),1)])])):d("",!0)]))),128))])):d("",!0)}const xe=T(q,[["render",we],["__scopeId","data-v-73107c03"]]),Ie={name:"Illustration",props:{illustrations:{type:Array,default:()=>[]}},data(){return{failedImages:new Set}},methods:{handleImageError(s){this.failedImages.add(s),this.$forceUpdate()},handleImageLoad(){}}},Ae={key:0,class:"illustration-container"},je=["src","alt","onError"];function Ee(s,e,a,p,u,r){return a.illustrations&&a.illustrations.length>0?(n(),o("div",Ae,[(n(!0),o(g,null,C(a.illustrations,(c,t)=>(n(),o("div",{key:t,class:"illustration-item"},[u.failedImages.has(t)?d("",!0):(n(),o("img",{key:0,src:c.url,alt:c.alt||"ÏÇΩÌôî",class:"illustration-image",onError:m=>r.handleImageError(t),onLoad:e[0]||(e[0]=(...m)=>r.handleImageLoad&&r.handleImageLoad(...m))},null,40,je))]))),128))])):d("",!0)}const $e=T(Ie,[["render",Ee],["__scopeId","data-v-c3f90253"]]),Ne={name:"DialogBox",components:{StatusChange:Y,DXCombo:xe,Illustration:$e},props:{stepType:{type:String,default:"dialogue",validator:s=>["dialogue","system","narrator","scene-description"].includes(s)},characterName:{type:String,default:""},characterColor:{type:String,default:"#333333"},text:{type:String,required:!0},statusChanges:{type:Array,default:()=>[]},dxCombos:{type:Array,default:()=>[]},illustrations:{type:Array,default:()=>[]},typingSpeed:{type:Number,default:50},autoPlaySpeed:{type:Number,default:1},autoAdvance:{type:Boolean,default:!1},hasOverlay:{type:Boolean,default:!1}},data(){return{displayedText:"",isTyping:!1,isComplete:!1,typingTimer:null,autoAdvanceTimer:null,currentIndex:0,originalHtmlText:null}},computed:{decodedText(){return this.decodeHtmlEntities(this.displayedText)}},watch:{text:{immediate:!0,handler(s){console.log("[DialogBox] text Î≥ÄÍ≤Ω, ÌÉÄÏù¥Ìïë ÏãúÏûë"),this.startTyping(s)}},autoAdvance(s,e){if(console.log("[DialogBox] autoAdvance Î≥ÄÍ≤Ω:",{old:e,new:s,isComplete:this.isComplete,hasOverlay:this.hasOverlay}),!s&&e){console.log("[DialogBox] ÏûêÎèôÏû¨ÏÉù Ï∑®ÏÜå - ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨"),this.stopAutoAdvance();return}s&&!e&&this.isComplete&&!this.hasOverlay&&(this.stopAutoAdvance(),this.autoAdvanceTimer=setTimeout(()=>{this.autoAdvance&&this.isComplete&&!this.hasOverlay&&(console.log("[DialogBox] autoAdvance watchÏóêÏÑú ÏßÑÌñâ"),this.autoAdvanceTimer=null,this.$emit("advance"))},1500))}},methods:{decodeHtmlEntities(s){if(!s)return s;const e={"&lt;":"<","&gt;":">","&amp;":"&","&quot;":'"',"&#39;":"'","&apos;":"'"};return s.replace(/&[a-z]+;|&#\d+;/gi,a=>e[a]||a)},startTyping(s){if(this.stopTyping(),this.stopAutoAdvance(),this.displayedText="",this.currentIndex=0,this.isTyping=!0,this.isComplete=!1,!s||s.length===0){this.displayedText=s,this.completeTyping(!0);return}if(s.includes("roll20-dx3-template")||s.includes("sheet-rolltemplate-")){this.displayedText=s,this.completeTyping(!0);return}if(this.hasHtmlTags(s)){const e=this.extractPlainText(s);this.originalHtmlText=s,this.typeNextCharacter(e,s);return}this.originalHtmlText=null,this.typeNextCharacter(s,s)},hasHtmlTags(s){return/<[^>]+>/i.test(s)},extractPlainText(s){const e=document.createElement("div");return e.innerHTML=s,e.textContent||e.innerText||""},typeNextCharacter(s,e){this.currentIndex<s.length?(this.originalHtmlText?this.displayedText=this.reconstructHtmlUpToIndex(this.originalHtmlText,this.currentIndex):this.displayedText+=s[this.currentIndex],this.currentIndex++,this.typingTimer=setTimeout(()=>{this.typeNextCharacter(s,e)},this.typingSpeed/this.autoPlaySpeed)):(this.displayedText=e,this.completeTyping())},reconstructHtmlUpToIndex(s,e){const a=document.createElement("div");a.innerHTML=s;let p=0,u="";const r=c=>{if(p>=e)return!1;if(c.nodeType===Node.TEXT_NODE){const t=c.textContent,m=e-p;if(p+t.length<=e)u+=t,p+=t.length;else return u+=t.substring(0,m),p=e,!1}else if(c.nodeType===Node.ELEMENT_NODE){const t=c.tagName.toLowerCase(),m=Array.from(c.attributes).map(y=>`${y.name}="${y.value}"`).join(" ");u+=`<${t}${m?" "+m:""}>`;for(let y of c.childNodes)if(!r(y))return!1;u+=`</${t}>`}return!0};for(let c of a.childNodes)if(!r(c))break;return u},completeTyping(s=!1){if(this.isTyping=!1,this.isComplete=!0,this.$emit("typing-complete"),console.log("[DialogBox] completeTyping:",{autoAdvance:this.autoAdvance,hasOverlay:this.hasOverlay,isEmpty:s,textLength:this.text.length}),this.autoAdvance&&!this.hasOverlay){let e=1500;s&&(e=3e3);const a=this.text.length*this.typingSpeed/this.autoPlaySpeed,u=a+e/this.autoPlaySpeed<3e3/this.autoPlaySpeed?3e3/this.autoPlaySpeed-a:e/this.autoPlaySpeed;console.log("[DialogBox] ÏûêÎèô ÏßÑÌñâ ÌÉÄÏù¥Î®∏ ÏãúÏûë:",Math.max(u,e),"ms"),this.autoAdvanceTimer=setTimeout(()=>{this.autoAdvance&&!this.hasOverlay?(console.log("[DialogBox] ÏûêÎèô ÏßÑÌñâ Ïã§Ìñâ"),this.autoAdvanceTimer=null,this.$emit("advance")):(console.log("[DialogBox] ÏûêÎèô ÏßÑÌñâ Ï∑®ÏÜåÎê® (autoAdvance:",this.autoAdvance,", hasOverlay:",this.hasOverlay,")"),this.autoAdvanceTimer=null)},Math.max(u,e))}},handleClick(){this.skipTyping()},skipTyping(){this.isTyping?(this.stopTyping(),this.displayedText=this.text,this.completeTyping()):this.isComplete&&this.$emit("advance")},stopTyping(){this.typingTimer&&(clearTimeout(this.typingTimer),this.typingTimer=null)},stopAutoAdvance(){this.autoAdvanceTimer&&(clearTimeout(this.autoAdvanceTimer),this.autoAdvanceTimer=null)}},beforeUnmount(){this.stopTyping(),this.stopAutoAdvance()}},De=["innerHTML"],Ve={key:0,class:"continue-indicator"};function Re(s,e,a,p,u,r){const c=k("EmojiToIcon"),t=k("Illustration"),m=k("DXCombo"),y=k("StatusChange");return n(),o("div",{class:v(["dialog-box",{"dialog-system":a.stepType==="system","dialog-narrator":a.stepType==="narrator","dialog-scene-description":a.stepType==="scene-description"}]),style:S({borderColor:a.characterColor}),onClick:e[0]||(e[0]=(...f)=>r.handleClick&&r.handleClick(...f))},[a.characterName?(n(),o("div",{key:0,class:"character-name",style:S({color:a.characterColor})},l(a.characterName),5)):d("",!0),a.text&&a.text.trim().length>0?(n(),o("div",{key:1,class:v(["dialog-text",{"is-typing":u.isTyping,"is-narration":!a.characterName}])},[i("p",{class:"text-content",innerHTML:r.decodedText},null,8,De),!u.isTyping&&!u.isComplete?(n(),o("div",Ve,[h(c,{emoji:"‚ñº",size:12})])):d("",!0)],2)):d("",!0),a.illustrations&&a.illustrations.length>0?(n(),P(t,{key:2,illustrations:a.illustrations},null,8,["illustrations"])):d("",!0),a.dxCombos&&a.dxCombos.length>0?(n(),P(m,{key:3,dxCombos:a.dxCombos},null,8,["dxCombos"])):d("",!0),a.statusChanges&&a.statusChanges.length>0?(n(),P(y,{key:4,statusChanges:a.statusChanges},null,8,["statusChanges"])):d("",!0)],6)}const zs=T(Ne,[["render",Re],["__scopeId","data-v-7c535831"]]),Be={name:"CharacterDisplay",props:{currentStep:{type:Object,default:null},characters:{type:Object,default:()=>({})},maxVisibleCharacters:{type:Number,default:3},layout:{type:String,default:"single",validator:s=>["single","left","center","right"].includes(s)}},data(){return{activeCharacterIds:[],failedImageIds:new Set}},computed:{speakingCharacterId(){var s;return!this.currentStep||this.currentStep.type==="system"||this.currentStep.type==="narrator"?null:((s=this.currentStep.character)==null?void 0:s.id)||null},currentCharacter(){return this.currentStep?this.getCurrentCharacter():null}},methods:{getCurrentCharacter(){if(!this.currentStep||!this.currentStep.character)return null;const s=this.currentStep.character;return{id:s.id||s.name,name:s.name,avatarUrl:s.avatarUrl,color:s.color,emotion:s.emotion||"default"}},getCharacterStyle(s){const e={};return s.color&&s.id===this.speakingCharacterId&&(e.borderColor=s.color),e},handleImageError(s){console.warn(`Ï∫êÎ¶≠ÌÑ∞ Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®: ${s.name}`),this.failedImageIds.add(s.id),this.$forceUpdate()}},watch:{currentStep:{handler(s){if(!s)return;const e=this.speakingCharacterId;e&&!this.activeCharacterIds.includes(e)&&(this.activeCharacterIds.push(e),this.activeCharacterIds.length>this.maxVisibleCharacters&&this.activeCharacterIds.shift())},immediate:!0}}},ze={class:"character-display"},He={class:"character-container"},Me={class:"character-avatar"},Oe=["src","alt"];function Ue(s,e,a,p,u,r){return n(),o("div",ze,[i("div",He,[h(b,{name:"character-fade",mode:"out-in"},{default:_(()=>[r.currentCharacter&&r.currentCharacter.avatarUrl&&!u.failedImageIds.has(r.currentCharacter.id)?(n(),o("div",{key:r.currentCharacter.id,class:v(["character-wrapper",{"is-speaking":r.currentCharacter.id===r.speakingCharacterId}]),style:S(r.getCharacterStyle(r.currentCharacter))},[i("div",Me,[i("img",{src:r.currentCharacter.avatarUrl,alt:r.currentCharacter.name,onError:e[0]||(e[0]=c=>r.handleImageError(r.currentCharacter))},null,40,Oe)])],6)):d("",!0)]),_:1})])])}const Hs=T(Be,[["render",Ue],["__scopeId","data-v-b271bfe7"]]),Le={name:"PlaybackControls",data(){return{speedOptions:[.5,1,1.2,2]}},props:{currentStepNumber:{type:Number,required:!0},totalSteps:{type:Number,required:!0},currentSceneName:{type:String,default:""},hasPreviousStep:{type:Boolean,default:!1},hasNextStep:{type:Boolean,default:!0},autoPlayEnabled:{type:Boolean,default:!1},autoPlaySpeed:{type:Number,default:1},showProgressBar:{type:Boolean,default:!0},showSceneSelector:{type:Boolean,default:!1}},computed:{progressPercentage(){return this.totalSteps===0?0:this.currentStepNumber/this.totalSteps*100}},methods:{handleSceneSelectorClick(){console.log("[PlaybackControls] Ïî¨ ÏÑ†ÌÉù Î≤ÑÌäº ÌÅ¥Î¶≠Îê®"),console.log("[PlaybackControls] showSceneSelector prop:",this.showSceneSelector),this.$emit("open-scene-selector"),console.log("[PlaybackControls] open-scene-selector Ïù¥Î≤§Ìä∏ emit ÏôÑÎ£å")}}},Ye={class:"playback-controls"},qe={key:0,class:"progress-bar"},Ge={class:"progress-info"},Xe={class:"scene-name"},Ke={class:"step-counter"},Fe={class:"controls-buttons"},Je=["disabled"],Qe=["disabled"],We={class:"speed-control"},Ze=["onClick","title"],et={key:1,class:"step-counter"};function tt(s,e,a,p,u,r){const c=k("EmojiToIcon");return n(),o("div",Ye,[a.showProgressBar?(n(),o("div",qe,[i("div",{class:"progress-fill",style:S({width:r.progressPercentage+"%"})},null,4),i("div",Ge,[i("span",Xe,l(a.currentSceneName),1),i("span",Ke,l(a.currentStepNumber)+" / "+l(a.totalSteps),1)])])):d("",!0),i("div",Fe,[i("button",{class:"control-button",onClick:e[0]||(e[0]=t=>s.$emit("previous")),disabled:!a.hasPreviousStep,title:"Ïù¥Ï†Ñ (‚Üê)"},[h(c,{emoji:"‚èÆÔ∏è",size:20})],8,Je),i("button",{class:"control-button primary",onClick:e[1]||(e[1]=t=>s.$emit("next")),disabled:!a.hasNextStep,title:"Îã§Ïùå (‚Üí / Space)"},[h(c,{emoji:"‚ñ∂Ô∏è",size:24})],8,Qe),i("button",{class:v(["control-button",{"is-active":a.autoPlayEnabled}]),onClick:e[2]||(e[2]=t=>s.$emit("toggle-autoplay")),title:"ÏûêÎèô Ïû¨ÏÉù"},[h(c,{emoji:a.autoPlayEnabled?"‚è∏Ô∏è":"‚èØÔ∏è",size:20},null,8,["emoji"])],2),i("div",We,[(n(!0),o(g,null,C(u.speedOptions,t=>(n(),o("button",{key:t,class:v(["speed-button",{"is-active":a.autoPlaySpeed===t}]),onClick:m=>s.$emit("change-speed",t),title:t+"Î∞∞ÏÜç"},l(t)+"x ",11,Ze))),128))]),a.showSceneSelector?(n(),o("button",{key:0,class:"control-button",onClick:e[3]||(e[3]=(...t)=>r.handleSceneSelectorClick&&r.handleSceneSelectorClick(...t)),title:"Ïî¨ ÏÑ†ÌÉù"},[h(c,{emoji:"üìë",size:20})])):d("",!0),a.showProgressBar?d("",!0):(n(),o("div",et,l(a.currentStepNumber)+" / "+l(a.totalSteps),1))])])}const Ms=T(Le,[["render",tt],["__scopeId","data-v-c19d5e78"]]),st={name:"SceneSelectorModal",props:{isVisible:{type:Boolean,default:!1},scenes:{type:Array,default:()=>[]},currentSceneIndex:{type:Number,default:0},currentStepIndex:{type:Number,default:0},closeOnOverlayClick:{type:Boolean,default:!0}},data(){return{expandedScenes:new Set}},methods:{close(){this.$emit("close")},handleOverlayClick(){this.closeOnOverlayClick&&this.close()},toggleScene(s){this.expandedScenes.has(s)?this.expandedScenes.delete(s):this.expandedScenes.add(s),this.$forceUpdate()},goToStep(s,e){this.$emit("go-to-step",s,e),this.close()},getStepPreview(s){return s?s.length>50?s.substring(0,50)+"...":s:"(ÌÖçÏä§Ìä∏ ÏóÜÏùå)"},handleKeyPress(s){s.key==="Escape"&&this.isVisible&&this.close()},initExpandedScenes(){this.currentSceneIndex!==null&&this.expandedScenes.add(this.currentSceneIndex)},scrollToCurrentScene(){setTimeout(()=>{this.$nextTick(()=>{const s=this.$refs.currentStep;if(s){const e=Array.isArray(s)?s[0]:s;e&&e.scrollIntoView({behavior:"smooth",block:"center"})}})},250)}},watch:{isVisible:{immediate:!0,handler(s){s?(this.initExpandedScenes(),window.addEventListener("keydown",this.handleKeyPress),document.body.style.overflow="hidden",this.scrollToCurrentScene()):(window.removeEventListener("keydown",this.handleKeyPress),document.body.style.overflow="",this.expandedScenes.clear())}},currentSceneIndex:{handler(s){this.isVisible&&s!==null&&(this.expandedScenes.add(s),this.$forceUpdate())}}},beforeUnmount(){window.removeEventListener("keydown",this.handleKeyPress),document.body.style.overflow=""}},it={class:"modal-header"},at={class:"modal-title"},nt={class:"modal-content"},ot=["onClick"],lt={class:"scene-info"},rt={class:"scene-number"},dt={class:"scene-name"},ct={class:"scene-meta"},ut={class:"step-count"},ht={key:0,class:"steps-list"},mt=["onClick"],yt={class:"step-number"},pt={class:"step-preview"},ft={class:"step-text"},gt={key:0,class:"empty-state"},_t={class:"modal-footer"},vt={class:"footer-info"};function bt(s,e,a,p,u,r){const c=k("EmojiToIcon");return n(),P(b,{name:"modal-overlay"},{default:_(()=>[a.isVisible?(n(),o("div",{key:0,class:"modal-overlay",onClick:e[3]||(e[3]=(...t)=>r.handleOverlayClick&&r.handleOverlayClick(...t))},[i("div",{class:"modal-container",onClick:e[2]||(e[2]=I(()=>{},["stop"]))},[i("div",it,[i("h2",at,[h(c,{emoji:"üìë",size:24}),e[4]||(e[4]=x(" Ïî¨ ÏÑ†ÌÉù ",-1))]),i("button",{class:"close-button",onClick:e[0]||(e[0]=(...t)=>r.close&&r.close(...t)),title:"Îã´Í∏∞ (ESC)"},[h(c,{emoji:"‚úñÔ∏è",size:20})])]),i("div",nt,[(n(!0),o(g,null,C(a.scenes,(t,m)=>(n(),o("div",{key:`scene-${m}`,class:v(["scene-item",{"is-current":m===a.currentSceneIndex}])},[i("div",{class:"scene-header",onClick:y=>r.toggleScene(m)},[i("div",lt,[i("span",rt,"Ïî¨ "+l(m+1),1),i("h3",dt,l(t.name||"Ï†úÎ™© ÏóÜÏùå"),1)]),i("div",ct,[i("span",ut,l(t.steps.length)+"Í∞ú Ïä§ÌÖù",1),h(c,{emoji:u.expandedScenes.has(m)?"üîΩ":"‚ñ∂Ô∏è",size:16,class:"expand-icon"},null,8,["emoji"])])],8,ot),h(b,{name:"steps-expand"},{default:_(()=>[u.expandedScenes.has(m)?(n(),o("div",ht,[(n(!0),o(g,null,C(t.steps,(y,f)=>{var w;return n(),o("div",{key:`step-${m}-${f}`,ref_for:!0,ref:m===a.currentSceneIndex&&f===a.currentStepIndex?"currentStep":null,class:v(["step-item",{"is-current":m===a.currentSceneIndex&&f===a.currentStepIndex}]),onClick:Rs=>r.goToStep(m,f)},[i("span",yt,l(f+1),1),i("div",pt,[(w=y.character)!=null&&w.name?(n(),o("span",{key:0,class:"step-character",style:S({color:y.character.color||"#ffffff"})},l(y.character.name)+": ",5)):d("",!0),i("span",ft,l(r.getStepPreview(y.text)),1)]),m===a.currentSceneIndex&&f===a.currentStepIndex?(n(),P(c,{key:0,emoji:"‚ñ∂Ô∏è",size:14,class:"current-indicator"})):d("",!0)],10,mt)}),128))])):d("",!0)]),_:2},1024)],2))),128)),a.scenes.length===0?(n(),o("div",gt,[h(c,{emoji:"üì≠",size:48}),e[5]||(e[5]=i("p",null,"Ïî¨Ïù¥ ÏóÜÏäµÎãàÎã§",-1))])):d("",!0)]),i("div",_t,[i("div",vt,[h(c,{emoji:"‚ÑπÔ∏è",size:14}),e[6]||(e[6]=i("span",null,"Ïî¨ÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÌéºÏπòÍ≥†, Ïä§ÌÖùÏùÑ ÏÑ†ÌÉùÌïòÏó¨ Ïù¥ÎèôÌï©ÎãàÎã§.",-1))]),i("button",{class:"action-button primary",onClick:e[1]||(e[1]=(...t)=>r.close&&r.close(...t))}," Îã´Í∏∞ ")])])])):d("",!0)]),_:1})}const Os=T(st,[["render",bt],["__scopeId","data-v-94d16136"]]),kt={name:"DiceRoll",props:{diceRolls:{type:Array,default:()=>[]},characterName:{type:String,default:""},characterColor:{type:String,default:"#ffffff"},animated:{type:Boolean,default:!0},animationDuration:{type:Number,default:800},playSoundEffect:{type:Boolean,default:!1}},data(){return{processedRolls:[],audioContext:null}},watch:{diceRolls:{immediate:!0,handler(s){this.processRolls(s)}}},methods:{processRolls(s){if(!s||s.length===0){this.processedRolls=[];return}this.processedRolls=s.map((e,a)=>({...e,isAnimating:!1,showResult:e.type==="choice"||e.type==="judgement",showDetails:!1})),this.animated?this.processedRolls.forEach((e,a)=>{e.type==="choice"||e.type==="judgement"||setTimeout(()=>{this.animateRoll(a)},a*200)}):this.processedRolls.forEach(e=>{e.showResult=!0})},animateRoll(s){const e=this.processedRolls[s];e&&(e.isAnimating=!0,this.playSoundEffect&&this.playDiceSound(),setTimeout(()=>{e.isAnimating=!1,e.showResult=!0},this.animationDuration))},toggleDetails(s){const e=this.processedRolls[s];e&&(e.showDetails=!e.showDetails)},playDiceSound(){this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext));const s=this.audioContext,e=s.createOscillator(),a=s.createGain();e.connect(a),a.connect(s.destination),e.type="square",e.frequency.setValueAtTime(200,s.currentTime),e.frequency.exponentialRampToValueAtTime(100,s.currentTime+.1),a.gain.setValueAtTime(.1,s.currentTime),a.gain.exponentialRampToValueAtTime(.01,s.currentTime+.1),e.start(s.currentTime),e.stop(s.currentTime+.1)}}},Ct={class:"dice-roll-container"},Tt={class:"dice-icon-wrapper"},St={class:"dice-result choice-result"},Pt=["onClick","title"],wt={key:0,class:"dice-details choice-options"},xt={key:1,class:"ougi-full-wrapper"},It={class:"ougi-header"},At={class:"dice-icon-wrapper"},jt={class:"ougi-info"},Et={class:"ougi-title-line"},$t={class:"ougi-name"},Nt={class:"ougi-main-name"},Dt={class:"ougi-info-table"},Vt={key:0},Rt={key:0},Bt={class:"ougi-presentation"},zt={key:1},Ht={key:2},Mt={class:"ougi-ninpou"},Ot={class:"shinobigami-full-wrapper"},Ut={class:"shinobigami-header"},Lt={class:"dice-icon-wrapper"},Yt={class:"shinobigami-info"},qt={class:"shinobigami-main"},Gt={class:"dice-formula"},Xt={class:"shinobigami-result-line"},Kt={key:1,class:"dice-placeholder"},Ft={class:"shinobigami-judgement"},Jt={key:0,class:"shinobigami-info-table"},Qt={key:0},Wt={key:1},Zt={key:2},es={key:3},ts={key:4},ss=["onClick","title"],is={key:0,class:"dice-details shinobigami-details"},as={class:"shinobigami-formula"},ns={class:"shinobigami-rolls"},os={key:0},ls={key:1},rs={class:"judgement-header"},ds={class:"dice-icon-wrapper"},cs={class:"judgement-info"},us={class:"judgement-main"},hs={class:"dice-formula"},ms={class:"judgement-result-line"},ys={key:1,class:"dice-placeholder"},ps={class:"judgement-text"},fs=["onClick","title"],gs={key:0,class:"dice-details"},_s={class:"dice-formula"},vs={key:1,class:"dice-placeholder"},bs={key:0,class:"dice-details-wrapper"},ks=["onClick","title"],Cs={key:0,class:"dice-details"};function Ts(s,e,a,p,u,r){const c=k("EmojiToIcon");return n(),o("div",Ct,[h(A,{name:"dice-list",tag:"div",class:"dice-rolls"},{default:_(()=>[(n(!0),o(g,null,C(u.processedRolls,(t,m)=>(n(),o("div",{key:`${t.formula}-${m}`,class:v(["dice-roll",[{"is-animating":t.isAnimating},`roll-type-${t.type}`]])},[t.type==="choice"?(n(),o(g,{key:0},[i("div",Tt,[h(c,{emoji:"üéØ",size:18,class:"dice-icon"})]),e[0]||(e[0]=i("span",{class:"dice-formula"},"ÏÑ†ÌÉù",-1)),e[1]||(e[1]=i("span",{class:"dice-arrow"},"‚Üí",-1)),i("span",St,l(t.result),1),i("button",{class:"details-toggle",onClick:y=>r.toggleDetails(m),title:t.showDetails?"ÏòµÏÖò Ïà®Í∏∞Í∏∞":"ÏòµÏÖò Î≥¥Í∏∞"},[h(c,{emoji:t.showDetails?"üîΩ":"‚ñ∂Ô∏è",size:12},null,8,["emoji"])],8,Pt),h(b,{name:"details-expand"},{default:_(()=>[t.showDetails?(n(),o("div",wt,[(n(!0),o(g,null,C(t.options,(y,f)=>(n(),o("span",{key:f,class:"choice-option"},l(y),1))),128))])):d("",!0)]),_:2},1024)],64)):t.type==="ougi"?(n(),o("div",xt,[i("div",It,[i("div",At,[h(c,{emoji:"üåü",size:20,class:"dice-icon"})]),i("div",jt,[i("div",Et,[i("span",{class:"ougi-character",style:S({color:a.characterColor})},l(a.characterName),5),i("span",$t,"„ÄêÂ••Áæ©: "+l(t.ougiType)+"„Äë",1),i("span",Nt,l(t.ougiName),1)]),i("table",Dt,[i("tbody",null,[i("tr",null,[e[2]||(e[2]=i("th",null,"ÏßÄÏ†ï ÌäπÍ∏∞",-1)),i("td",null,[(n(!0),o(g,null,C(t.skills,(y,f)=>(n(),o("span",{key:f,class:"ougi-skill"},[x(" „Ää"+l(y)+"„Äã",1),f<t.skills.length-1?(n(),o("span",Vt,", ")):d("",!0)]))),128))])]),t.presentation?(n(),o("tr",Rt,[e[3]||(e[3]=i("th",null,"Ïó∞Ï∂ú",-1)),i("td",Bt,l(t.presentation),1)])):d("",!0),t.ougiEffect?(n(),o("tr",zt,[e[4]||(e[4]=i("th",null,"Ìö®Í≥º",-1)),i("td",null,l(t.ougiEffect),1)])):d("",!0),t.ninpouInfo?(n(),o("tr",Ht,[e[5]||(e[5]=i("th",null,"Ïù∏Î≤ï",-1)),i("td",Mt,l(t.ninpouInfo),1)])):d("",!0)])])])])])):t.type==="shinobigami"?(n(),o(g,{key:2},[i("div",Ot,[i("div",Ut,[i("div",Lt,[h(c,{emoji:"‚öîÔ∏è",size:18,class:"dice-icon"})]),i("div",Yt,[i("div",qt,[i("span",{class:"shinobigami-character",style:S({color:a.characterColor})},l(a.characterName),5),i("span",Gt,"„Äê"+l(t.checkName)+"„Äë",1)]),i("div",Xt,[e[6]||(e[6]=i("span",{class:"dice-arrow"},"‚Üí",-1)),h(b,{name:"dice-result",mode:"out-in"},{default:_(()=>[t.showResult?(n(),o("span",{key:t.result,class:"dice-result"},l(t.result),1)):(n(),o("span",Kt,"???"))]),_:2},1024),i("span",Ft,l(t.judgement),1)]),t.additionalInfo?(n(),o("table",Jt,[i("tbody",null,[t.additionalInfo.type?(n(),o("tr",Qt,[e[7]||(e[7]=i("th",null,"ÌÉÄÏûÖ",-1)),i("td",null,l(t.additionalInfo.type),1)])):d("",!0),t.additionalInfo.range?(n(),o("tr",Wt,[e[8]||(e[8]=i("th",null,"Í∞ÑÍ≤©",-1)),i("td",null,l(t.additionalInfo.range.replace("Í∞ÑÍ≤©:","").trim()),1)])):d("",!0),t.additionalInfo.cost?(n(),o("tr",Zt,[e[9]||(e[9]=i("th",null,"ÏΩîÏä§Ìä∏",-1)),i("td",null,l(t.additionalInfo.cost.replace("ÏΩîÏä§Ìä∏:","").trim()),1)])):d("",!0),t.additionalInfo.skill?(n(),o("tr",es,[e[10]||(e[10]=i("th",null,"ÌäπÍ∏∞",-1)),i("td",null,l(t.additionalInfo.skill),1)])):d("",!0),t.additionalInfo.description?(n(),o("tr",ts,[e[11]||(e[11]=i("th",null,"ÏÑ§Î™Ö",-1)),i("td",null,l(t.additionalInfo.description),1)])):d("",!0)])])):d("",!0)])])]),i("button",{class:"details-toggle",onClick:y=>r.toggleDetails(m),title:t.showDetails?"ÏÉÅÏÑ∏ Ïà®Í∏∞Í∏∞":"ÏÉÅÏÑ∏ Î≥¥Í∏∞"},[h(c,{emoji:t.showDetails?"üîΩ":"‚ñ∂Ô∏è",size:12},null,8,["emoji"])],8,ss),h(b,{name:"details-expand"},{default:_(()=>[t.showDetails?(n(),o("div",is,[i("div",as,l(t.command),1),i("div",ns,[t.diceExpression?(n(),o("span",os,"Ï£ºÏÇ¨ÏúÑ: "+l(t.diceExpression),1)):(n(),o("span",ls,"Í∞úÎ≥Ñ Ï£ºÏÇ¨ÏúÑ: "+l(t.diceRolls),1))])])):d("",!0)]),_:2},1024)],64)):t.type==="judgement"?(n(),o(g,{key:3},[i("div",rs,[i("div",ds,[h(c,{emoji:"‚öñÔ∏è",size:18,class:"dice-icon"})]),i("div",cs,[i("div",us,[i("span",{class:"judgement-character",style:S({color:a.characterColor})},l(a.characterName),5),i("span",hs,l(t.checkName),1)]),i("div",ms,[e[12]||(e[12]=i("span",{class:"dice-arrow"},"‚Üí",-1)),h(b,{name:"dice-result",mode:"out-in"},{default:_(()=>[t.showResult?(n(),o("span",{key:t.result,class:"dice-result"},l(t.result),1)):(n(),o("span",ys,"???"))]),_:2},1024),i("span",ps,l(t.judgement),1)])])]),i("button",{class:"details-toggle",onClick:y=>r.toggleDetails(m),title:t.showDetails?"ÏÉÅÏÑ∏ Ïà®Í∏∞Í∏∞":"ÏÉÅÏÑ∏ Î≥¥Í∏∞"},[h(c,{emoji:t.showDetails?"üîΩ":"‚ñ∂Ô∏è",size:12},null,8,["emoji"])],8,fs),h(b,{name:"details-expand"},{default:_(()=>[t.showDetails?(n(),o("div",gs,l(t.formula),1)):d("",!0)]),_:2},1024)],64)):(n(),o(g,{key:4},[i("div",{class:v(["dice-icon-wrapper",{"is-rolling":t.isAnimating}])},[h(c,{emoji:"üé≤",size:18,class:"dice-icon"})],2),i("span",_s,l(t.formula),1),e[13]||(e[13]=i("span",{class:"dice-arrow"},"‚Üí",-1)),h(b,{name:"dice-result",mode:"out-in"},{default:_(()=>[t.showResult?(n(),o("span",{key:t.result,class:"dice-result"},l(t.result),1)):(n(),o("span",vs,"???"))]),_:2},1024),t.type==="dx3"&&t.diceRolls?(n(),o("div",bs,[i("button",{class:"details-toggle",onClick:y=>r.toggleDetails(m),title:t.showDetails?"ÏÉÅÏÑ∏ Ïà®Í∏∞Í∏∞":"ÏÉÅÏÑ∏ Î≥¥Í∏∞"},[h(c,{emoji:t.showDetails?"üîΩ":"‚ñ∂Ô∏è",size:12},null,8,["emoji"])],8,ks),h(b,{name:"details-expand"},{default:_(()=>[t.showDetails?(n(),o("div",Cs,l(t.diceRolls),1)):d("",!0)]),_:2},1024)])):d("",!0)],64))],2))),128))]),_:1})])}const Us=T(kt,[["render",Ts],["__scopeId","data-v-3b3fb983"]]),Ss={name:"BGMPlayer",props:{bgmUrl:{type:String,default:""},bgmType:{type:String,default:"youtube",validator:s=>["youtube","audio"].includes(s)},volume:{type:Number,default:.5},autoPlay:{type:Boolean,default:!1}},data(){return{isPlaying:!1,isPaused:!1,isMuted:!1,currentVolume:this.volume,youtubePlayer:null,youtubeApiReady:!1}},computed:{youtubeVideoId(){if(this.bgmType!=="youtube"||!this.bgmUrl)return"";const s=[/(?:youtube\.com\/watch\?v=)([\w-]+)/,/(?:youtu\.be\/)([\w-]+)/,/(?:youtube\.com\/embed\/)([\w-]+)/,/^([\w-]{11})$/];for(const e of s){const a=this.bgmUrl.match(e);if(a)return a[1]}return""}},watch:{bgmUrl(s,e){s&&s!==e?(this.stopPlayer(),this.isPlaying=!1,this.isPaused=!1,this.initializePlayer()):s||this.stopPlayer()},volume(s){this.currentVolume=s,this.updateVolume()}},methods:{loadYouTubeAPI(){if(window.YT&&window.YT.Player){this.youtubeApiReady=!0;return}if(!document.getElementById("youtube-iframe-api")){const s=document.createElement("script");s.id="youtube-iframe-api",s.src="https://www.youtube.com/iframe_api";const e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(s,e),window.onYouTubeIframeAPIReady=()=>{this.youtubeApiReady=!0,this.initYouTubePlayer()}}},initializePlayer(){this.$nextTick(()=>{this.bgmType==="youtube"?(this.loadYouTubeAPI(),this.youtubeApiReady&&this.initYouTubePlayer()):this.bgmType==="audio"&&this.initAudioPlayer()})},initYouTubePlayer(){!this.youtubeApiReady||!this.youtubeVideoId||(this.youtubePlayer&&(this.youtubePlayer.destroy(),this.youtubePlayer=null),this.$nextTick(()=>{this.youtubePlayer=new window.YT.Player(this.$refs.youtubeIframe,{videoId:this.youtubeVideoId,playerVars:{autoplay:this.autoPlay?1:0,loop:1,playlist:this.youtubeVideoId,controls:0,disablekb:1,fs:0,modestbranding:1},events:{onReady:s=>{s.target.setVolume(this.currentVolume*100),this.autoPlay&&(s.target.playVideo(),this.isPlaying=!0,this.isPaused=!1)},onStateChange:s=>{s.data===1?(this.isPlaying=!0,this.isPaused=!1):s.data===2?(this.isPlaying=!1,this.isPaused=!0):(s.data===0||s.data===-1)&&(this.isPlaying=!1,this.isPaused=!1)}}})}))},initAudioPlayer(){const s=this.$refs.audioPlayer;s&&(s.volume=this.currentVolume,this.autoPlay&&s.play().then(()=>{this.isPlaying=!0,this.isPaused=!1}).catch(e=>{console.warn("ÏûêÎèôÏû¨ÏÉù Ïã§Ìå®:",e),this.isPaused=!0}))},togglePlay(){if(this.bgmType==="audio"){const s=this.$refs.audioPlayer;s&&(this.isPlaying?(s.pause(),this.isPlaying=!1,this.isPaused=!0):s.play().then(()=>{this.isPlaying=!0,this.isPaused=!1}).catch(e=>{console.error("Ïû¨ÏÉù Ïã§Ìå®:",e),this.isPlaying=!1,this.isPaused=!0}))}else if(this.bgmType==="youtube"){if(!this.youtubePlayer)return;this.isPlaying?this.youtubePlayer.pauseVideo():this.youtubePlayer.playVideo()}},toggleMute(){if(this.isMuted=!this.isMuted,this.bgmType==="audio"){const s=this.$refs.audioPlayer;s&&(s.muted=this.isMuted)}else this.bgmType==="youtube"&&this.youtubePlayer&&(this.isMuted?this.youtubePlayer.mute():this.youtubePlayer.unMute())},updateVolume(){if(this.bgmType==="audio"){const s=this.$refs.audioPlayer;s&&(s.volume=this.currentVolume)}else this.bgmType==="youtube"&&this.youtubePlayer&&this.youtubePlayer.setVolume(this.currentVolume*100)},stopPlayer(){if(this.bgmType==="audio"){const s=this.$refs.audioPlayer;s&&(s.pause(),s.currentTime=0)}else this.bgmType==="youtube"&&this.youtubePlayer&&this.youtubePlayer.stopVideo();this.isPlaying=!1,this.isPaused=!1},handleAudioError(s){console.error("Ïò§ÎîîÏò§ Î°úÎìú Ïã§Ìå®:",s),this.$emit("error","BGM ÌååÏùºÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.")}},mounted(){this.bgmUrl&&this.initializePlayer()},beforeUnmount(){this.stopPlayer(),this.youtubePlayer&&(this.youtubePlayer.destroy(),this.youtubePlayer=null)}},Ps={key:0,class:"bgm-player"},ws={key:0,class:"youtube-container"},xs={ref:"youtubeIframe",style:{display:"none"}},Is=["src","autoplay"],As={class:"bgm-controls"},js=["title"],Es={class:"bgm-info"},$s={class:"bgm-status"},Ns={class:"volume-control"},Ds=["title"];function Vs(s,e,a,p,u,r){const c=k("EmojiToIcon");return a.bgmUrl?(n(),o("div",Ps,[a.bgmType==="youtube"&&r.youtubeVideoId?(n(),o("div",ws,[i("div",xs,null,512)])):a.bgmType==="audio"?(n(),o("audio",{key:1,ref:"audioPlayer",src:a.bgmUrl,autoplay:a.autoPlay,loop:"",onError:e[0]||(e[0]=(...t)=>r.handleAudioError&&r.handleAudioError(...t))},null,40,Is)):d("",!0),i("div",As,[i("button",{onClick:e[1]||(e[1]=(...t)=>r.togglePlay&&r.togglePlay(...t)),class:"bgm-button",title:u.isPlaying?"ÏùºÏãúÏ†ïÏßÄ":"Ïû¨ÏÉù"},[h(c,{emoji:u.isPlaying?"‚è∏Ô∏è":"‚ñ∂Ô∏è",size:16},null,8,["emoji"])],8,js),i("div",Es,[e[5]||(e[5]=i("span",{class:"bgm-label"},"BGM",-1)),i("span",$s,l(u.isPlaying?"Ïû¨ÏÉù Ï§ë":u.isPaused?"ÏùºÏãúÏ†ïÏßÄ":"Ï†ïÏßÄ"),1)]),i("div",Ns,[i("button",{onClick:e[2]||(e[2]=(...t)=>r.toggleMute&&r.toggleMute(...t)),class:"volume-button",title:u.isMuted?"ÏùåÏÜåÍ±∞ Ìï¥Ï†ú":"ÏùåÏÜåÍ±∞"},[h(c,{emoji:u.isMuted?"üîá":"üîä",size:14},null,8,["emoji"])],8,Ds),j(i("input",{"onUpdate:modelValue":e[3]||(e[3]=t=>u.currentVolume=t),type:"range",min:"0",max:"1",step:"0.05",class:"volume-slider",onInput:e[4]||(e[4]=(...t)=>r.updateVolume&&r.updateVolume(...t))},null,544),[[E,u.currentVolume,void 0,{number:!0}]])])])])):d("",!0)}const Ls=T(Ss,[["render",Vs],["__scopeId","data-v-c8511153"]]);export{Ls as B,Hs as C,xe as D,Ms as P,Os as S,Us as a,zs as b};
