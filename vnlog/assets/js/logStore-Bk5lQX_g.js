import{s as k}from"./index-En_KFgI6.js";const v="vnlog-storage",I=1,l="kv";let u=null;function m(n){return new Promise((e,t)=>{n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)})}function p(n){return new Promise((e,t)=>{n.oncomplete=()=>e(),n.onerror=()=>t(n.error),n.onabort=()=>t(n.error)})}async function y(){return u||(u=new Promise((n,e)=>{if(typeof indexedDB>"u"){e(new Error("IndexedDB not supported"));return}const t=indexedDB.open(v,I);t.onupgradeneeded=()=>{const r=t.result;r.objectStoreNames.contains(l)||r.createObjectStore(l,{keyPath:"key"})},t.onsuccess=()=>n(t.result),t.onerror=()=>e(t.error)}),u)}class h{static async setJson(e,t){const a=(await y()).transaction(l,"readwrite");return a.objectStore(l).put({key:e,value:t,updatedAt:Date.now()}),await p(a),!0}static async getJson(e){const r=(await y()).transaction(l,"readonly"),c=r.objectStore(l).get(e),o=await m(c);return await p(r),(o==null?void 0:o.value)??null}static async remove(e){const r=(await y()).transaction(l,"readwrite");return r.objectStore(l).delete(e),await p(r),!0}}const f="vnlog-save-",d="vnlog-filedata-",g=5,b="vnlog-autosave";class s{static isQuotaExceededError(e){return e&&(e.name==="QuotaExceededError"||e.name==="NS_ERROR_DOM_QUOTA_REACHED"||e.code===22||e.code===1014)}static evictLocalFileData(){try{const e=[];for(let t=0;t<localStorage.length;t++){const r=localStorage.key(t);r&&r.startsWith(d)&&e.push(r)}e.forEach(t=>localStorage.removeItem(t)),e.length>0&&console.warn(`LocalStorage 파일데이터 ${e.length}개 정리 완료`)}catch(e){console.warn("LocalStorage 파일데이터 정리 실패:",e)}}static async save(e,t,r=null){try{const a=e===null?b:`${f}${e}`,c={...t,timestamp:Date.now(),version:"1.0.0"},o=JSON.stringify(c);try{localStorage.setItem(a,o)}catch(i){if(this.isQuotaExceededError(i))this.evictLocalFileData(),localStorage.setItem(a,o);else throw i}return r&&t.fileCode&&await this.saveFileData(t.fileCode,r),console.log(`저장 완료: ${a}`),!0}catch(a){return console.error("저장 실패:",a),!1}}static async saveFileData(e,t){try{const r=`${d}${e}`,a=JSON.stringify(t);try{await h.setJson(r,a);try{localStorage.removeItem(r)}catch{}return console.log(`파일 데이터(IDB) 저장 완료: ${r}`),!0}catch(c){console.warn("IndexedDB 저장 실패, localStorage로 fallback:",c)}try{return localStorage.setItem(r,a),console.log(`파일 데이터(localStorage) 저장 완료: ${r}`),!0}catch(c){return console.error("파일 데이터 저장 실패:",c),!1}}catch(r){return console.error("파일 데이터 저장 실패:",r),!1}}static async loadFileData(e){try{const t=`${d}${e}`;try{const a=localStorage.getItem(t);if(a)return JSON.parse(a)}catch{}const r=await h.getJson(t);return r?JSON.parse(r):null}catch(t){return console.error("파일 데이터 불러오기 실패:",t),null}}static load(e){try{const t=e===null?b:`${f}${e}`,r=localStorage.getItem(t);if(!r)return null;const a=JSON.parse(r);return console.log(`불러오기 완료: ${t}`),a}catch(t){return console.error("불러오기 실패:",t),null}}static deleteSave(e){try{const t=`${f}${e}`;return localStorage.removeItem(t),console.log(`삭제 완료: ${t}`),!0}catch(t){return console.error("삭제 실패:",t),!1}}static async deleteFileData(e){const t=`${d}${e}`;try{localStorage.removeItem(t)}catch{}try{await h.remove(t)}catch(r){console.warn("IndexedDB 파일데이터 삭제 실패:",r)}}static async deleteSaveAndCleanup(e){try{const t=this.load(e),r=t==null?void 0:t.fileCode;return this.deleteSave(e)?(r&&((()=>{for(let i=0;i<g;i++){if(i===e)continue;const S=this.load(i);if((S==null?void 0:S.fileCode)===r)return!0}const o=this.loadAutoSave();return(o==null?void 0:o.fileCode)===r})()||await this.deleteFileData(r)),!0):!1}catch(t){return console.error("저장 데이터 삭제/정리 실패:",t),!1}}static getAllSaves(){const e=[];for(let t=0;t<g;t++){const r=this.load(t);e.push({slotIndex:t,isEmpty:!r,timestamp:(r==null?void 0:r.timestamp)||null,fileCode:(r==null?void 0:r.fileCode)||null,logTitle:(r==null?void 0:r.logTitle)||"",currentSceneIndex:(r==null?void 0:r.currentSceneIndex)||0,currentStepIndex:(r==null?void 0:r.currentStepIndex)||0,totalSteps:(r==null?void 0:r.totalSteps)||0})}return e}static autoSave(e){return this.save(null,e)}static loadAutoSave(){return this.load(null)}static canSave(){try{const e="vnlog-test";return localStorage.setItem(e,"test"),localStorage.removeItem(e),!0}catch(e){return console.error("LocalStorage 사용 불가:",e),!1}}static createSaveData(e){return{fileCode:e.vnData.fileCode,logTitle:e.vnData.title||"제목 없음",currentSceneIndex:e.playback.currentSceneIndex,currentStepIndex:e.playback.currentStepIndex,totalSteps:e.vnData.scenes.reduce((t,r)=>t+r.steps.length,0)}}static async applySaveData(e,t){try{if(!t||!t.fileCode)return!1;const r=await this.loadFileData(t.fileCode);return r?(e.setVNData(r,!1),e.playback.currentSceneIndex=t.currentSceneIndex,e.playback.currentStepIndex=t.currentStepIndex,console.log("진행도 및 파일 데이터 복원 완료:",t),!0):(console.error("저장된 파일 데이터를 찾을 수 없습니다:",t.fileCode),!1)}catch(r){return console.error("진행도 복원 실패:",r),!1}}static formatSaveInfo(e){if(e.isEmpty)return{title:"빈 슬롯",subtitle:"",date:""};const t=new Date(e.timestamp),r=t.toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"}),a=t.toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit"}),c=e.totalSteps>0?Math.round(e.currentStepIndex/e.totalSteps*100):0;return{title:e.logTitle,subtitle:`진행도: ${c}% (${e.currentStepIndex}/${e.totalSteps})`,date:`${r} ${a}`}}}const w=k("log",{state:()=>({rawLog:null,vnData:{title:"",scenes:[],characters:{},handouts:[]},playback:{currentSceneIndex:0,currentStepIndex:0,isPlaying:!1,autoPlayEnabled:!1,autoPlaySpeed:2e3},settings:{textSpeed:50,skipUnread:!1}}),getters:{currentScene:n=>n.vnData.scenes[n.playback.currentSceneIndex]||null,currentStep:n=>{const e=n.vnData.scenes[n.playback.currentSceneIndex];return(e==null?void 0:e.steps[n.playback.currentStepIndex])||null},hasNextStep:n=>{const e=n.vnData.scenes[n.playback.currentSceneIndex];return e?n.playback.currentStepIndex<e.steps.length-1?!0:n.playback.currentSceneIndex<n.vnData.scenes.length-1:!1},hasPreviousStep:n=>n.playback.currentStepIndex>0||n.playback.currentSceneIndex>0},actions:{setRawLog(n){this.rawLog=n},setVNData(n,e=!0){this.vnData=n,e&&(this.playback.currentSceneIndex=0,this.playback.currentStepIndex=0)},nextStep(){const n=this.vnData.scenes[this.playback.currentSceneIndex];return n?this.playback.currentStepIndex<n.steps.length-1?(this.playback.currentStepIndex++,!0):this.playback.currentSceneIndex<this.vnData.scenes.length-1?(this.playback.currentSceneIndex++,this.playback.currentStepIndex=0,!0):!1:!1},previousStep(){if(this.playback.currentStepIndex>0)return this.playback.currentStepIndex--,!0;if(this.playback.currentSceneIndex>0){this.playback.currentSceneIndex--;const n=this.vnData.scenes[this.playback.currentSceneIndex];return this.playback.currentStepIndex=n.steps.length-1,!0}return!1},goToStep(n,e){return n>=0&&n<this.vnData.scenes.length&&e>=0&&e<this.vnData.scenes[n].steps.length?(this.playback.currentSceneIndex=n,this.playback.currentStepIndex=e,!0):!1},toggleAutoPlay(){this.playback.autoPlayEnabled=!this.playback.autoPlayEnabled},setPlaying(n){this.playback.isPlaying=n},reset(){this.rawLog=null,this.vnData={title:"",scenes:[],characters:{},handouts:[]},this.playback.currentSceneIndex=0,this.playback.currentStepIndex=0,this.playback.isPlaying=!1},async saveProgress(n){const e=s.createSaveData(this);return await s.save(n,e,this.vnData)},async loadProgress(n){const e=s.load(n);return e?await s.applySaveData(this,e):!1},async autoSave(){const n=s.createSaveData(this);return await s.autoSave(n)},async loadAutoSave(){const n=s.loadAutoSave();return n?await s.applySaveData(this,n):!1}}});export{s as S,w as u};
