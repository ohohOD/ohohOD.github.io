import{u as B}from"./logStore-D5UUMuK5.js";import{_ as G,c as _,a as T,b as X,d as $,e as U,r as z,n as H,f as Z,t as j,o as J}from"./index-rtssYZtx.js";class V{static parseHTMLLog(e){const r=new DOMParser().parseFromString(e,"text/html"),t={title:"ì½”ì½”í¬ë¦¬ì•„ ë¡œê·¸",scenes:[],characters:{},handouts:[]},n=r.querySelectorAll(".ccl_tab");if(n.length>0)n.forEach((i,o)=>{const l=this.parseScene(i,o);l.steps.length>0&&t.scenes.push(l),this.collectCharacters(i,t.characters)});else{const i=r.querySelector(".ccfolia_wrap");if(i&&i.querySelectorAll(".gap").length>0){console.log("[Parser] cclog-custom í˜•ì‹ ê°ì§€ (gap êµ¬ì¡°)");const o=this.parseCCLogCustom(i);o.steps.length>0&&t.scenes.push(o),this.collectCharactersCustom(i,t.characters)}else{const o=r.querySelector(".cclog_wrap")||r.body,l=this.parseSceneFlat(o);l.steps.length>0&&t.scenes.push(l),this.collectCharactersFlat(o,t.characters)}}return t}static parseScene(e,s){const r=e.querySelector(".ccl_tabtitle"),t=r?r.textContent.trim():`ì”¬ ${s+1}`,n={id:`scene_${s}`,name:t,description:null,steps:[]},i=e.querySelectorAll(".ccl_player");let o=0;return i.forEach(l=>{const g=this.parseStep(l,s,o);g&&g.length>0&&g.forEach(d=>{n.steps.push(d),o++})}),n}static parseStep(e,s,r){const t=e.classList.contains("system"),n=e.classList.contains("narrator"),i=e.querySelector(".ccl_Uname"),o=e.querySelector(".ccl_Utext"),l=e.querySelector(".ccl_imgWrap img");if(!o)return null;const g=i?i.textContent.trim():"",d=i?this.extractColor(i):"var(--text-color)",m=o.innerHTML.trim(),D=l?l.getAttribute("src"):null,h=/^ì”¬\s+(\d+)::\s*(.+?)(?:\s*\(([^)]+)\))?\s*(?:<br|$)/i,y=m.match(h);if(y){const u=y[1],S=y[2]?y[2].trim():"",v=y[3]?y[3].trim():null;let N="";const M=m.indexOf("<br>");return M!==-1&&(N=this.cleanText(m.substring(M+4))),console.log("Scene Description Parsed:",{sceneNumber:u,sceneTitle:S,scenePCs:v,sceneDescription:N,rawHTML:m.substring(0,100)}),[{id:`scene_${s}_desc_${r}`,type:"scene-description",character:{name:g,color:d},text:this.cleanText(m),rawText:m,isSceneDescription:!0,sceneNumber:u,sceneTitle:S,scenePCs:v,sceneDescription:N,avatarUrl:D}]}const b=m;if(!b||!b.trim())return null;const{rolls:C,ougis:f,shinobigamis:w}=this.extractDiceRolls(b),x=this.extractStatusChanges(b),p=this.extractDXCombo(b);let c=b;if((C.length>0||f.length>0||w.length>0||x.length>0||p.length>0)&&(c=this.removeDiceCommands(b)),!this.cleanText(c).trim())if(f.length>0)c="* ì˜¤ì˜";else if(w.length>0)c="* ì¸ë²•";else if(C.length>0){const u=C.some(v=>v.type==="judgement"),S=C.some(v=>v.type==="choice");u?c="* íŒì •":S?c="* ì„ íƒ":c="* ë‹¤ì´ìŠ¤"}else x.length>0?c="* ìƒíƒœ ë³€í™”":p.length>0&&(p.length>1||p[0].effects&&p[0].effects.length>1?c="* ì½¤ë³´":c="* ì´í™íŠ¸");return[{id:`step_${s}_${r}`,type:t?"system":n?"narrator":"dialogue",character:{name:g,color:d,avatarUrl:D},text:this.cleanText(c),rawText:b,diceRolls:C,hasDice:C.length>0,ougis:f,hasOugi:f.length>0,shinobigamis:w,hasShinobigami:w.length>0,statusChanges:x,hasStatusChange:x.length>0,dxCombos:p,hasDXCombo:p.length>0,effects:{sfx:null,bgm:null,background:null,backgroundOpacity:.3}}]}static splitByBreaks(e){return e.split(/<br[^>]*\/?>/gi).map(s=>s.trim()).filter(s=>s.length>0)}static parseSceneFlat(e){const s={id:"scene_0",name:"ë¡œê·¸",description:null,steps:[]},r=e.querySelectorAll(".gap");let t=0;return r.forEach(n=>{const i=this.parseStepFlat(n,0,t);i&&i.length>0&&i.forEach(o=>{s.steps.push(o),t++})}),s}static parseStepFlat(e,s,r){const t=e.querySelector("p");if(!t)return null;if((e.getAttribute("style")||"").includes("display: flow-root"))return this.parseFlowRootStep(t,s,r);const o=e.querySelector(".msg_container img"),l=t.querySelectorAll("span");let g="",d="var(--text-color)",m="";l.forEach(u=>{var S;window.getComputedStyle||u.style.fontWeight,(u.style.fontWeight==="bold"||(S=u.getAttribute("style"))!=null&&S.includes("font-weight: bold"))&&(g||(g=u.textContent.trim(),d=this.extractColorFromStyle(u.getAttribute("style"))||"var(--text-color)"))});const D=t.innerHTML,h=D.indexOf("<br>");if(h!==-1&&(m=D.substring(h+4).trim()),!m)return null;const y=o?o.getAttribute("src"):null,b=m;if(!b||!b.trim())return null;const{rolls:C,ougis:f,shinobigamis:w}=this.extractDiceRolls(b),x=this.extractStatusChanges(b),p=this.extractDXCombo(b);let c=b;if((C.length>0||f.length>0||w.length>0||x.length>0||p.length>0)&&(c=this.removeDiceCommands(b)),!this.cleanText(c).trim()){if(f.length>0)c="* ì˜¤ì˜";else if(w.length>0)c="* ì¸ë²•";else if(C.length>0){const u=C.some(N=>N.type==="judgement"),S=C.some(N=>N.type==="choice"),v=C.some(N=>N.type==="table");u?c="* íŒì •":v?c="* ì¥ë©´í‘œ":S?c="* ì„ íƒ":c="* ë‹¤ì´ìŠ¤"}}return x.length>0&&!this.cleanText(c).trim()&&(c="* ìƒíƒœ ë³€í™”"),p.length>0&&!this.cleanText(c).trim()&&(p.length>1||p[0].effects&&p[0].effects.length>1?c="* ì½¤ë³´":c="* ì´í™íŠ¸"),[{id:`step_${s}_${r}`,type:g==="GM"?"narrator":"dialogue",character:{name:g,color:d,avatarUrl:y},text:this.cleanText(c),rawText:b,diceRolls:C,hasDice:C.length>0,ougis:f,hasOugi:f.length>0,shinobigamis:w,hasShinobigami:w.length>0,statusChanges:x,hasStatusChange:x.length>0,dxCombos:p,hasDXCombo:p.length>0,effects:{sfx:null,bgm:null,background:null,backgroundOpacity:.3}}]}static collectCharacters(e,s){e.querySelectorAll(".ccl_player:not(.system):not(.narrator)").forEach(t=>{const n=t.querySelector(".ccl_Uname"),i=t.querySelector(".ccl_imgWrap img");if(n){const o=n.textContent.trim(),l=this.extractColor(n),g=i?i.getAttribute("src"):null;o&&!s[o]&&(s[o]={id:`char_${Object.keys(s).length}`,name:o,color:l,avatarUrl:g,emotions:{default:g}})}})}static parseFlowRootStep(e,s,r){const t=e.querySelectorAll("span");let n="",i="var(--text-color)",o="",l=!1,g=null;if(t.forEach((f,w)=>{const x=f.getAttribute("style")||"",p=f.textContent.trim();if(x.includes("background: black")||x.includes("background:black")){l=!0;const c=p.split(" - ");c.length>=1&&(n=c[0].trim())}if(l&&!g){const c=this.extractColorFromStyle(x);c&&!x.includes("background: black")&&!x.includes("background:black")&&(i=c)}if(l&&p&&!x.includes("background: black")&&!x.includes("background:black")&&(p.includes("cc")||p.includes("CHOICE")||p.includes("choice")||p.includes("ï¼"))&&!g){o=p,g=f;const c=this.extractColorFromStyle(x);c&&(i=c)}}),!n){const w=e.textContent.trim().match(/^([^-]+)\s*-\s*íŒì •/);w&&(n=w[1].trim())}if(!o){const f=e.textContent.trim(),w=f.match(/([^-]+)\s*-\s*íŒì •\s*(.+)/);if(w)n||(n=w[1].trim()),o=w[2].trim();else if(l){const x=f.split(/íŒì •\s*/);x.length>1&&(o=x[1].trim())}o||(o=f)}if(o=o.replace(/^[^-]+-\s*íŒì •\s*/,"").trim(),!o)return null;const{rolls:d,ougis:m,shinobigamis:D}=this.extractDiceRolls(o),h=this.extractStatusChanges(o);let y=o;if((d.length>0||m.length>0||D.length>0||h.length>0)&&(y=this.removeDiceCommands(o)),(d.length>0||m.length>0||D.length>0)&&!y.trim())if(m.length>0)y="* ì˜¤ì˜";else if(D.length>0)y="* ì¸ë²•";else{const f=d.some(p=>p.type==="judgement"),w=d.some(p=>p.type==="choice"),x=d.some(p=>p.type==="table");f?y="* íŒì •":x?y="* ì¥ë©´í‘œ":w?y="* ì„ íƒ":y="* ë‹¤ì´ìŠ¤"}h.length>0&&!y.trim()&&(y="* ìƒíƒœ ë³€í™”");const b=this.extractDXCombo(o);return b.length>0&&!y.trim()&&(b.length>1||b[0].effects&&b[0].effects.length>1?y="* ì½¤ë³´":y="* ì´í™íŠ¸"),[{id:`step_${s}_${r}`,type:"system",character:{name:n||"ì‹œìŠ¤í…œ",color:i,avatarUrl:null},text:this.cleanText(y),rawText:o,diceRolls:d,hasDice:d.length>0,ougis:m,hasOugi:m.length>0,shinobigamis:D,hasShinobigami:D.length>0,statusChanges:h,hasStatusChange:h.length>0,dxCombos:b,hasDXCombo:b.length>0,effects:{sfx:null,bgm:null,background:null}}]}static parseCCLogCustom(e){const s={id:"scene_0",name:"ë¡œê·¸",description:null,steps:[]},r=e.querySelectorAll(".gap, .message-container");return console.log(`[parseCCLogCustom] ì´ ${r.length}ê°œì˜ ë©”ì‹œì§€ ìš”ì†Œ(.gap/.message-container) ë°œê²¬`),r.forEach((t,n)=>{const o=(t.getAttribute("style")||"").includes("display: flow-root");let l=null;if(o){const g=t.querySelector("p");g?l=this.parseFlowRootStep(g,0,n):l=this.parseCCLogCustomStep(t,0,n)}else l=this.parseCCLogCustomStep(t,0,n);l&&s.steps.push(...l)}),s}static parseCCLogCustomStep(e,s,r){const t=e.querySelector("p"),n=e.querySelector(".msg_container img"),i=n?n.getAttribute("src"):null;let o="",l="rgb(221, 221, 221)",g=[];if(t)t.querySelectorAll("span").forEach(a=>{const u=a.getAttribute("style")||"",S=a.textContent.trim();if(u.includes("font-weight: bold")){o=S;const v=u.match(/color:\s*rgb\(([^)]+)\)/);v&&(l=`rgb(${v[1]})`)}}),t.innerHTML.split(/<br\s*\/?>/).forEach(a=>{const u=document.createElement("div");u.innerHTML=a;const S=(u.textContent||"").replace(/\u00A0/g," ").trim(),v=/^-?\s*\d{4}\/\d{2}\/\d{2}/.test(S),N=!S||S==="(-)"||S==="-",M=S===o||o&&S.includes(o);!N&&!M&&!v&&g.push(S)});else{let x=e.querySelector(".msg-normal-text, .dice, .desc, .msg-system-text, .msg-info-text, .msg-other-text, .info:not(.message-container), .other:not(.message-container)");if(!x){const u=Array.from(e.querySelectorAll("div, span")).filter(S=>!(!S||!S.textContent||!S.textContent.replace(/\u00A0/g," ").trim()||S.querySelector&&S.querySelector("strong")||S.classList&&S.classList.contains("msg_container")));x=u.length>0?u[u.length-1]:null}if(!x)return null;const p=e.querySelector("strong");if(p){o=p.textContent.trim();const u=this.extractColorFromStyle(p.getAttribute("style")||"");u&&(l=u)}this.cleanText(x.innerHTML||"").split(/\n+/).map(u=>u.replace(/\u00A0/g," ").trim()).filter(u=>u).forEach(u=>{!u||u==="(-)"||u==="-"||g.push(u)})}if(g.length===0)return null;const d=g.join(`
`),{rolls:m,ougis:D,shinobigamis:h}=this.extractDiceRolls(d),y=this.extractStatusChanges(d),b=this.extractDXCombo(d);let C=d;if((m.length>0||D.length>0||h.length>0||y.length>0||b.length>0)&&(C=this.removeDiceCommands(d)),!this.cleanText(C).trim())if(D.length>0)C="* ì˜¤ì˜";else if(h.length>0)C="* ì¸ë²•";else if(m.length>0){const x=m.some(a=>a.type==="judgement"),p=m.some(a=>a.type==="choice"),c=m.some(a=>a.type==="table");x?C="* íŒì •":c?C="* ì¥ë©´í‘œ":p?C="* ì„ íƒ":C="* ë‹¤ì´ìŠ¤"}else y.length>0?C="* ìƒíƒœ ë³€í™”":b.length>0&&(b.length>1||b[0].effects&&b[0].effects.length>1?C="* ì½¤ë³´":C="* ì´í™íŠ¸");const f=!!o;return[{id:`step_${s}_${r}`,sceneNumber:s,type:f?"dialogue":"system",character:{name:o||"ì‹œìŠ¤í…œ",color:l,avatarUrl:f?i:null},text:this.cleanText(C),rawText:d,diceRolls:m,hasDice:m.length>0,ougis:D,hasOugi:D.length>0,shinobigamis:h,hasShinobigami:h.length>0,statusChanges:y,hasStatusChange:y.length>0,dxCombos:b,hasDXCombo:b.length>0,effects:{sfx:null,bgm:null,background:null,backgroundOpacity:.3}}]}static collectCharactersCustom(e,s){e.querySelectorAll(".gap, .message-container").forEach(t=>{const n=t.querySelector(".msg_container img"),i=n?n.getAttribute("src"):null,o=t.querySelector("p");if(o){o.querySelectorAll("span").forEach(h=>{const y=h.getAttribute("style")||"";if(y.includes("font-weight: bold")){const b=h.textContent.trim();if(b&&!s[b]){const C=y.match(/color:\s*rgb\(([^)]+)\)/),f=C?`rgb(${C[1]})`:"rgb(221, 221, 221)";s[b]={name:b,color:f,avatarUrl:i}}}});return}const l=t.querySelector("strong");if(!l)return;const g=l.textContent.trim();if(!g||s[g])return;const m=this.extractColorFromStyle(l.getAttribute("style")||"")||"rgb(221, 221, 221)";s[g]={name:g,color:m,avatarUrl:i}})}static collectCharactersFlat(e,s){e.querySelectorAll(".gap").forEach(t=>{const n=t.querySelector(".msg_container img"),i=t.querySelector("p");if(i){const o=i.querySelectorAll("span");let l="",g="var(--text-color)";if(o.forEach(d=>{var m;(d.style.fontWeight==="bold"||(m=d.getAttribute("style"))!=null&&m.includes("font-weight: bold"))&&(l||(l=d.textContent.trim(),g=this.extractColorFromStyle(d.getAttribute("style"))||"var(--text-color)"))}),l&&!s[l]){const d=n?n.getAttribute("src"):null;s[l]={id:`char_${Object.keys(s).length}`,name:l,color:g,avatarUrl:d,emotions:{default:d}}}}})}static extractColorFromStyle(e){if(!e)return null;const s=e.match(/color:\s*rgb\(([^)]+)\)/);if(s)return`rgb(${s[1]})`;const r=e.match(/color:\s*(#[0-9a-fA-F]{3,6})/);return r?r[1]:null}static extractColor(e){const s=e.getAttribute("style");if(s){const r=s.match(/color:\s*([^;]+)/);if(r)return r[1].trim()}return"var(--text-color)"}static extractDXCombo(e){const s=[],r=/(?:(\d+)[â†‘â†“])?\s*([^ã€Š\|]+?)?\s*ã€ŠC:([^ã€‹]+)ã€‹(?:\s*\|\s*([^\|]+)\s*\|\s*([^\|]+)\s*\|\s*(.+?))?(?:<br\s*\/?>|\n)?(?:\s*(\d+dx\d*(?:\+\d+)?)\s*\(([^)]+)\)\s*[ï¼>]\s*([^\sï¼>]+)\s*[ï¼>]\s*(\d+))?(?:<br\s*\/?>|$)/gim;let t;for(;(t=r.exec(e))!==null;){const o=t[1]?parseInt(t[1],10):null,l=t[2]?t[2].trim():"",g=t[3].trim(),d=t[4]?t[4].trim():"",m=t[5]?t[5].trim():"",D=t[6]?t[6].trim():"",h=t[7],y=t[8],b=t[9],C=t[10],f=[];if(g.split("+").forEach(x=>{const p=x.trim().match(/(.+?)\((\d+)\)/);p&&f.push({name:p[1].trim(),level:parseInt(p[2],10)})}),f.length>0){const x=d.split("/").map(R=>R.trim()),p=x[0]||"",c=x[1]||"",a=m.split("/").map(R=>R.trim()),u=(a[0]||"").replace(/^ë‹¤ì´ìŠ¤\s*/i,""),S=(a[1]||"").replace(/^í¬ë¦¬ì¹˜\s*/i,""),v=(a[2]||"").replace(/^ê³µê²©ë ¥\s*/i,""),N=(a[3]||"").replace(/^ì¹¨ì‹\s*/i,"");let M=null;h&&C&&(M={type:"dx3",formula:h.toUpperCase(),fullFormula:y,diceRolls:b,result:parseInt(C,10)}),s.push({type:"dx-combo",isSingleEffect:f.length===1,comboName:l,effects:f,erosionCost:o,timing:p,difficulty:c,dice:u,critical:S,attack:v,erosion:N,description:D,diceRoll:M,rawText:t[0]})}}const n=/ã€Š([^ã€‹]+)ã€‹\s*Lv(\d+)\s*\|\s*([^\|]+)\s*\|\s*([^\|]+)\s*\|\s*([^\|]+)\s*\|\s*([^\|]+)\s*\|\s*([^\|]+)(?:\s*\|\s*(.+?))?(?:<br\s*\/?>|\n)?(?:\s*(\d+dx\d*(?:\+\d+)?)\s*\(([^)]+)\)\s*[ï¼>]\s*([^\sï¼>]+)\s*[ï¼>]\s*(\d+))?(?:<br\s*\/?>|$)/gim;for(;(t=n.exec(e))!==null;){const o=t[1].trim(),l=parseInt(t[2],10),g=t[3].trim(),d=t[4].trim(),m=t[5].trim(),D=t[6].trim(),h=t[7].trim(),y=t[8]?t[8].trim():"",b=t[9],C=t[10],f=t[11],w=t[12];let x=null;b&&w&&(x={type:"dx3",formula:b.toUpperCase(),fullFormula:C,diceRolls:f,result:parseInt(w,10)}),s.push({type:"dx-effect",isSingleEffect:!0,effects:[{name:o,level:l}],timing:g,difficulty:d,target:m,range:D,description:h,erosion:y,diceRoll:x,rawText:t[0]})}const i=/(?:(\d+)[â†‘â†“])?\s*([^\|ã€Š]+?)?\s*(ã€Š[^ã€‹]+ã€‹(?:\s*\+\s*ã€Š[^ã€‹]+ã€‹)+)\s*(?:\|\s*([^\|]+)\s*\|\s*([^\|]+)\s*\|\s*(.+?))?(?:<br\s*\/?>|\n)?(?:\s*(\d+dx\d*(?:\+\d+)?)\s*\(([^)]+)\)\s*[ï¼>]\s*([^\sï¼>]+)\s*[ï¼>]\s*(\d+))?(?:<br\s*\/?>|$)/gim;for(;(t=i.exec(e))!==null;){const o=t[1]?parseInt(t[1],10):null,l=t[2]?t[2].trim():"",g=t[3],d=t[4]?t[4].trim():"",m=t[5]?t[5].trim():"",D=t[6]?t[6].trim():"",h=t[7],y=t[8],b=t[9],C=t[10],f=[],w=g.match(/ã€Š([^ã€‹]+)ã€‹/gi);w&&w.forEach(R=>{const A=R.match(/ã€Š(.+?)\((\d+)\)ã€‹/);A&&f.push({name:A[1].trim(),level:parseInt(A[2],10)})});const x=d.split("/").map(R=>R.trim()),p=x[0]||"",c=x[1]||"",a=m.split("/").map(R=>R.trim()),u=(a[0]||"").replace(/^ë‹¤ì´ìŠ¤\s*/i,""),S=(a[1]||"").replace(/^í¬ë¦¬ì¹˜\s*/i,""),v=(a[2]||"").replace(/^ê³µê²©ë ¥\s*/i,""),N=(a[3]||"").replace(/^ì¹¨ì‹\s*/i,"");let M=null;h&&C&&(M={type:"dx3",formula:h.toUpperCase(),fullFormula:y,diceRolls:b,result:parseInt(C,10)}),f.length>1&&s.push({type:"dx-combo",isSingleEffect:!1,comboName:l,effects:f,erosionCost:o,timing:p,difficulty:c,dice:u,critical:S,attack:v,erosion:N,description:D,diceRoll:M,rawText:t[0]})}return s}static extractStatusChanges(e){const s=[],r=/\[\s*([^\]]+)\s*\]\s*([^:ï¼š]+)\s*[ï¼š:]\s*(\d+)\s*[â†’>]\s*(\d+)/gi;let t;for(;(t=r.exec(e))!==null;){const n=t[1].trim(),i=t[2].trim(),o=parseInt(t[3],10),l=parseInt(t[4],10);s.push({characterName:n,statusName:i,oldValue:o,newValue:l,delta:l-o})}return s}static extractDiceRolls(e){const s=[],r=[],t=[];e.includes("SG@")&&e.includes("ã€")&&console.log("[DEBUG] Shinobigami text detected:",e.substring(0,100));const n=/([^ã€Š<]+?)\s*ã€Š([^ã€‹]+)ã€‹\s*\|\s*((?:(?!ã€Š).)+?)ã€ì˜¤ì˜:\s*([^ã€‘]+)ã€‘/gi;let i;for(;(i=n.exec(e))!==null;){const c=i[1].trim(),a=i[2].trim(),u=i[3].trim(),S=i[4].trim(),v=u.split("|").map(A=>A.trim()).filter(A=>A);let N="",M="",R="";v.length>=3?(N=v[0],M=v.slice(1,-1).join(" | "),R=v[v.length-1]):v.length===2?(N=v[0],R=v[1]):v.length===1&&(N=v[0]),r.push({type:"ougi",ougiName:c,skills:a.split(/[,ã€]/).map(A=>A.trim()),presentation:N,ougiEffect:M,ninpouInfo:R,ougiType:S})}const o=/(?:CHOICE|choice)\[([^\]]+)\]\s*(?:\([^)]*\))?\s*[ï¼>]\s*(.+?)(?:<|$)/gi;let l;for(;(l=o.exec(e))!==null;){const c=l[1].split(",").map(u=>u.trim()),a=l[2].trim();s.push({type:"choice",options:c,result:a,formula:`CHOICE[${c.join(",")}]`})}const g=/(?:CHOICE|choice)\s+([^(]+?)\s*\((?:CHOICE|choice)\s+[^)]+\)\s*[ï¼>]\s*(.+?)(?:<|$)/gi;for(;(l=g.exec(e))!==null;){const c=l[1].trim(),a=l[2].trim(),u=c.split(/[,\u3001]/).map(S=>S.trim()).filter(S=>S);u.length===0&&u.push(c),s.push({type:"choice",options:u,result:a,formula:`CHOICE[${u.join(",")}]`})}const d=/(\d*[A-Z]+[+\-]?\d*@\d+(?:#\d+)?(?:[+\-]\d+)?(?:(?:&gt;|&lt;|[<>=])+\d+)?)\s*\|\s*ã€([^ã€‘]+)ã€‘([^(]*?)\(([^)]+)\)\s*[ï¼>]\s*(.+?)(?=<|\n|$)/gi,m=[];for(;(l=d.exec(e))!==null;){console.log("[DEBUG] Shinobigami match found:",{command:l[1],checkName:l[2],additionalInfo:l[3],formula:l[4],resultText:l[5]});const c=l[3].trim(),a=l[5],u=a.split(/\s*[ï¼>]\s*/),S=u[u.length-1].trim();let v="",N="",M=0;const R=a.match(/\[([^\]]+)\]\s*[ï¼>]\s*(\d+)\[([^\]]+)\](?:[+\-]\d+)?\s*[ï¼>]\s*(\d+)/);if(R)N=R[1],v=`${R[2]}[${R[3]}]`,M=parseInt(R[4],10);else{const I=a.match(/(\d+\[[^\]]+\](?:[+\-]\d+)?)\s*[ï¼>]\s*(\d+)/);if(I){v=I[1];const F=v.match(/\[([^\]]+)\]/);N=F?F[1]:"",M=parseInt(I[2],10)}}const A=this.parseShinobiAdditionalInfo(c),k={type:"shinobigami",command:l[1],checkName:l[2],additionalInfo:A,formula:l[4],diceRolls:N,diceExpression:v,result:M,judgement:S};console.log("[DEBUG] Pushing shinobigami:",k),t.push(k),m.push(l[0])}const D=/\((\d*[A-Z]+[+\-]?\d*@\d+(?:#\d+)?(?:[+\-]\d+)?(?:(?:&gt;|&lt;|[<>=])+\d+)?)\)\s*[ï¼>]\s*(.+?)(?=<|\n|$)/gi;for(;(l=D.exec(e))!==null;){if(m.some(A=>A.includes(l[0])))continue;const a=l[2],u=a.split(/\s*[ï¼>]\s*/),S=u[u.length-1].trim();let v="",N="",M=0;const R=a.match(/(\d+\[[^\]]+\](?:[+\-]\d+)?)\s*[ï¼>]\s*(\d+)/);if(R){v=R[1];const A=v.match(/\[([^\]]+)\]/);N=A?A[1]:"",M=parseInt(R[2],10)}t.push({type:"shinobigami",command:l[1],checkName:"íŒì •",additionalInfo:null,formula:l[1],diceRolls:N,diceExpression:v,result:M,judgement:S}),m.push(l[0])}const h=/([^\dï¼>]+)\s+(\d+[dD]\d+)\s+([^(ï¼>]+)\((\d+)\)\s*[ï¼>]\s*(.+?)(?=<|\n|$)/gi,y=[];for(;(l=h.exec(e))!==null;)s.push({type:"table",command:l[2],checkName:l[1].trim(),formula:`${l[2]} ${l[3].trim()}`,options:[],result:l[5].trim(),diceResult:parseInt(l[4],10)}),y.push(l[0]);const b=/([A-Z]+)\s*\|\s*ã€([^ã€‘]+)ã€‘\s*([^ï¼>]*)\s*[ï¼>]\s*(.+?)(?=<|\n|$)/gi;for(;(l=b.exec(e))!==null;)l[0].includes("[")||s.push({type:"choice",command:l[1],checkName:l[2],formula:`${l[1]} ${l[3].trim()}`,options:[],result:l[4].trim()});const C=/(cc[<>=]+\d+)\s+(.+?)\((\d+[dD]\d+[<>=]+\d+)\)\s*.*?[ï¼>]\s*(\d+)(?:\s*[ï¼>]\s*\d+)*\s*[ï¼>]\s*(.+?)$/gi;for(;(l=C.exec(e))!==null;)m.some(a=>a.includes(l[0]))||s.push({type:"judgement",command:l[1],checkName:l[2].trim(),formula:l[3],result:parseInt(l[4],10),judgement:l[5].trim()});const f=/(\d+dx\d*(?:\+\d+)?)\s*\(([^)]+)\)\s*[ï¼>]\s*([^\sï¼>]+)\s*[ï¼>]\s*(\d+)/gi;for(;(l=f.exec(e))!==null;)s.push({type:"dx3",formula:l[1].toUpperCase(),fullFormula:l[2],diceRolls:l[3],result:parseInt(l[4],10)});const w=/((?:\d+[dD]\d+[+\-]?)+)\s*\([^)]+\)\s*[ï¼>]\s*([^\sï¼>]+)\s*[ï¼>]\s*(\d+)/gi,x=[];for(;(l=w.exec(e))!==null;){const c=l[1];c.toLowerCase().includes("dx")||(s.push({type:"detailed",formula:c.toUpperCase(),diceRolls:l[2],result:parseInt(l[3],10)}),x.push(l[0]))}const p=/(\d+[dD]\d+)\s*(?:\([^)]+\))?\s*[ï¼>]\s*(\d+)/gi;for(;(l=p.exec(e))!==null;){const c=l[1],a=l[0],u=x.some(v=>v.includes(a)),S=y.some(v=>v.includes(a));!c.toLowerCase().includes("dx")&&!u&&!S&&s.push({type:"normal",formula:c.toUpperCase(),result:parseInt(l[2],10)})}return console.log("[DEBUG] extractDiceRolls result:",{rollsCount:s.length,ougisCount:r.length,shinobigamisCount:t.length}),{rolls:s,ougis:r,shinobigamis:t}}static parseShinobiAdditionalInfo(e){if(!e||!e.trim())return null;const s=e.split("|").map(t=>t.trim()).filter(t=>t);if(s.length===0)return null;const r={type:null,range:null,cost:null,skill:null,description:null};return s.forEach((t,n)=>{n===0&&t.includes("ì¸ë²•")?r.type=t:t.includes("ê°„ê²©")?r.range=t:t.includes("ì½”ìŠ¤íŠ¸")?r.cost=t:t.includes("ã€Š")&&t.includes("ã€‹")?r.skill=t:r.description?r.description+=" | "+t:r.description=t}),r}static cleanText(e){return(e||"").replace(/<br\s*\/?>/gi,`
`).replace(/<\/(?:div|p|li|tr|h[1-6])\s*>/gi,`
`).replace(/<[^>]+>/g,"").replace(/\n{3,}/g,`

`).trim()}static removeDiceCommands(e){console.log("[DEBUG] removeDiceCommands input:",e.substring(0,100));let s=e;return s=s.replace(/[^ã€Š<]+?\s*ã€Š[^ã€‹]+ã€‹\s*\|(?:(?!ã€Š).)+?ã€ì˜¤ì˜:[^ã€‘]+ã€‘/gi,""),s=s.replace(/(?:CHOICE|choice)\[[^\]]+\]\s*(?:\([^)]*\))?\s*[ï¼>]\s*.+?(?=<|\n|$)/gi,""),s=s.replace(/(?:CHOICE|choice)\s+[^(]+?\s*\((?:CHOICE|choice)\s+[^)]+\)\s*[ï¼>]\s*.+?(?=<|\n|$)/gi,""),s=s.replace(/[^\dï¼>]+\s+\d+[dD]\d+\s+[^(ï¼>]+\(\d+\)\s*[ï¼>]\s*.+?(?=<|\n|$)/gi,""),s=s.replace(/\d*[A-Z]+[+\-]?\d*@\d+(?:#\d+)?(?:[+\-]\d+)?(?:(?:&gt;|&lt;|[<>=])+\d+)?\s*\|\s*ã€[^ã€‘]+ã€‘.*?\([^)]+\)\s*[ï¼>]\s*.+?(?=<|\n|$)/gi,""),s=s.replace(/\(\d*[A-Z]+[+\-]?\d*@\d+(?:#\d+)?(?:[+\-]\d+)?(?:(?:&gt;|&lt;|[<>=])+\d+)?\)\s*[ï¼>]\s*.+?(?=<|\n|$)/gi,""),s=s.replace(/[A-Z]+\s*\|\s*ã€[^ã€‘]+ã€‘\s*[^ï¼>\[]*\s*[ï¼>]\s*[^\[<]+?(?=<|\n|$)/gi,""),s=s.replace(/(cc[<>=]+\d+)\s+(.*?)\((\d+D\d+[<>=]+\d+)\)\s*[^ï¼>]*?ï¼\s*\d+(?:\s*ï¼\s*\d+)*\s*ï¼\s*.+?$/gi,""),s=s.replace(/(\d+dx\d*(?:\+\d+)?)\s*\([^)]+\)\s*[ï¼>]\s*[^\sï¼>]+\s*[ï¼>]\s*\d+/gi,""),s=s.replace(/((?:\d+[dD]\d+[+\-]?)+)\s*\([^)]+\)\s*[ï¼>]\s*[^\sï¼>]+\s*[ï¼>]\s*\d+/gi,""),s=s.replace(/(\d+[dD]\d+)\s*(?:\([^)]+\))?\s*[ï¼>]\s*\d+/gi,""),s=s.replace(/\[\s*[^\]]+?\s*\]\s*[^:ï¼š\n]+?\s*[ï¼š:]\s*\d+\s*[â†’>]\s*\d+/g,""),s=s.replace(/ã€Š[^ã€‹]+ã€‹\s*Lv\d+\s*(?:\|[^\n<]*)+(?:(?:<br\s*\/?>\s*|\n)\d+dx\d*(?:\+\d+)?\s*\([^)]+\)\s*[ï¼>]\s*[^\sï¼>]+\s*[ï¼>]\s*\d+)?/gi,""),s=s.replace(/(?:\d+[â†‘â†“])?\s*[^\|ã€Š\n]*?\s*ã€Š[^ã€‹]+ã€‹(?:\s*\+\s*ã€Š[^ã€‹]+ã€‹)*\s*(?:\|[^\n<]*){0,3}(?:(?:<br\s*\/?>\s*|\n)\d+dx\d*(?:\+\d+)?\s*\([^)]+\)\s*[ï¼>]\s*[^\sï¼>]+\s*[ï¼>]\s*\d+)?/gi,""),s=s.replace(/ã€ŠC:[^ã€‹]+ã€‹(?:\s*\|[^\n<]*)*(?:(?:<br\s*\/?>\s*|\n)\d+dx\d*(?:\+\d+)?\s*\([^)]+\)\s*[ï¼>]\s*[^\sï¼>]+\s*[ï¼>]\s*\d+)?/gi,""),s=s.replace(/ã€Š[^ã€‹]+ã€‹(?:\s*\+\s*ã€Š[^ã€‹]+ã€‹)+(?:(?:<br\s*\/?>\s*|\n)\d+dx\d*(?:\+\d+)?\s*\([^)]+\)\s*[ï¼>]\s*[^\sï¼>]+\s*[ï¼>]\s*\d+)?/gi,""),s=s.replace(/^(<br\s*\/?>|\s)+$/gi,""),console.log("[DEBUG] removeDiceCommands output:",s.substring(0,100)),s.trim()}static parseTextLog(e){return console.warn("í”Œë ˆì¸ í…ìŠ¤íŠ¸ íŒŒì‹±ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."),{title:"í…ìŠ¤íŠ¸ ë¡œê·¸",scenes:[{id:"scene_0",name:"ë¡œê·¸",steps:[{id:"step_0_0",type:"narrator",character:{name:"",color:"#333"},text:e,rawText:e,diceRolls:[],hasDice:!1}]}],characters:{},handouts:[]}}static parseRoll20Log(e){console.log("[Roll20 Parser] Starting parse..."),console.log("[Roll20 Parser] Content length:",e.length);const r=new DOMParser().parseFromString(e,"text/html");console.log("[Roll20 Parser] DOM parsed, body exists:",!!r.body);const t=r.querySelector("title"),n=t?t.textContent.replace("Chat Log for ","").trim():"Roll20 ë¡œê·¸";console.log("[Roll20 Parser] Title:",n);const i={title:n,scenes:[],characters:{},handouts:[]},o={id:"scene_0",name:"ë¡œê·¸",description:null,steps:[]};let l=r.querySelectorAll("div.message");if(console.log(`[Roll20 Parser] Found ${l.length} messages with 'div.message'`),l.length===0){const m=r.querySelector(".content");console.log("[Roll20 Parser] Content container exists:",!!m),m&&(l=m.querySelectorAll(".message"),console.log(`[Roll20 Parser] Found ${l.length} messages inside .content`))}if(l.length===0){const m=r.querySelectorAll("div[class*='message']");console.log(`[Roll20 Parser] Found ${m.length} divs with 'message' in class`),l=m}let g=0,d=null;return l.forEach((m,D)=>{const h=this.parseRoll20Message(m,g,d);h?(console.log(`[Roll20 Parser] Step ${g}:`,h.character.name,"-",h.text.substring(0,50)),o.steps.push(h),h.character&&h.character.name&&!i.characters[h.character.name]&&(i.characters[h.character.name]={id:`char_${Object.keys(i.characters).length}`,name:h.character.name,color:h.character.color||"var(--text-color)",avatarUrl:h.character.avatarUrl||null,emotions:{default:h.character.avatarUrl||null}}),d=h.character,g++):console.log(`[Roll20 Parser] Skipped message ${D}: empty or invalid`)}),o.steps.length>0&&i.scenes.push(o),i}static parseRoll20Message(e,s,r=null){const t=e.classList;let n="dialogue";t.contains("desc")||t.contains("emote")?n="narrator":t.contains("rollresult")&&(n="system");const i=e.querySelector(".by");let o="",l=!1;i?(o=i.textContent.replace(":","").trim(),(o==="GM"||o.includes("(GM)"))&&(n="narrator",o="GM")):n!=="narrator"&&r?(o=r.name,l=!0):n==="narrator"&&(o="GM");const g=e.querySelector(".avatar img");let d=g?g.getAttribute("src"):null;d&&d.startsWith("/")&&(d="https://app.roll20.net"+d),l&&!d&&r&&r.avatarUrl&&(d=r.avatarUrl);const m=[];e.querySelectorAll("img").forEach(L=>{if(!L.closest(".avatar")){let E=L.getAttribute("src");const P=L.getAttribute("alt")||"";E&&(E.startsWith("/")&&(E="https://app.roll20.net"+E),m.push({url:E,alt:P}))}});let h="",y=[],b=[],C=[];const f=e.querySelector(".sheet-rolltemplate-coc, .sheet-rolltemplate-coc-1");if(f){const L=this.parseRoll20DiceTemplate(f);L&&(y.push(L),h="* íŒì •")}e.querySelectorAll("[class*='sheet-rolltemplate-']").forEach(L=>{if(!L.classList.contains("sheet-rolltemplate-coc")&&!L.classList.contains("sheet-rolltemplate-coc-1")&&!L.classList.contains("sheet-rolltemplate-Dx3Dice")){const E=this.parseRoll20TableTemplate(L);E&&(h||(h=E.html))}});const x=e.querySelector(".sheet-rolltemplate-Dx3Dice");x&&(h=`<div class="roll20-dx3-template">${x.outerHTML}</div>`);let p=null;const c=/<strong>([^<]+)<\/strong>\s*\/\s*<span[^>]*>(\d*)<\/span>\s*<span[^>]*>\s*â†’\s*<\/span>\s*<b>(\d*)<\/b>/;let a=e.innerHTML.match(c);if(a){const L=a[1].trim(),E=a[2]?parseInt(a[2],10):null,P=a[3]?parseInt(a[3],10):null;if(p=a[0],E!==null||P!==null){const O=(P||0)-(E||0);C.push({characterName:o,statusName:L,oldValue:E,newValue:P,delta:O})}}else{e.textContent;const L=/(ì¹¨ì‹ë¥ |HP|MP|SAN|æ­£æ°—åº¦|ä¾µè•ç‡)\s*<span[^>]*inlinerollresult[^>]*>(\d+)<\/span>\s*(ìƒìŠ¹|í•˜ê°•|ì¦ê°€|ê°ì†Œ|ä¸Šæ˜‡|æ¸›å°‘)/i;if(a=e.innerHTML.match(L),a){const E=a[1].trim(),P=parseInt(a[2],10),W=a[3].match(/ìƒìŠ¹|ì¦ê°€|ä¸Šæ˜‡/)?P:-P;p=a[0],C.push({characterName:o,statusName:E,oldValue:null,newValue:null,delta:W})}}const u=e.querySelectorAll(".inlinerollresult");u.length>0&&!f&&!x&&!a&&u.forEach(L=>{const E=L.getAttribute("title"),P=L.textContent.trim();if(E&&P){const O=E.match(/Rolling\s+([^\s=]+)/i);O&&y.push({type:"inline",formula:O[1].toUpperCase(),result:parseInt(P,10)||P})}});const S=e.cloneNode(!0);[".by",".tstamp",".avatar",".spacer",".flyout","[class*='sheet-rolltemplate']"].forEach(L=>{S.querySelectorAll(L).forEach(P=>P.remove())}),S.querySelectorAll("a").forEach(L=>{L.querySelector("img")&&L.remove()}),S.querySelectorAll(".inlinerollresult").forEach(L=>{L.removeAttribute("title"),L.removeAttribute("original-title"),L.className="inlinerollresult"});let R=S.innerHTML.trim();p&&(R=R.replace(p,"")),R=R.replace(/<br\s*\/?>/gi," "),R=R.replace(/<div>/gi," "),R=R.replace(/<\/div>/gi,"");const A=document.createElement("div");A.innerHTML=R;let k=R,I=A.textContent.trim();if(o&&I.startsWith(o)){const L=o.length;I=I.substring(L).trim(),k=k.replace(new RegExp(`^${o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}`),"").trim()}return I.startsWith(":")&&(I=I.substring(1).trim(),k=k.replace(/^:\s*/,"")),I&&I!==h&&(h=k||I),!h&&m.length===0?null:(e.querySelector("em")&&(h=h),{id:`step_0_${s}`,type:n,character:{name:o||"ì•Œ ìˆ˜ ì—†ìŒ",color:"var(--text-color)",avatarUrl:d},text:h||"",rawText:h,diceRolls:y,hasDice:y.length>0,statusChanges:C,hasStatusChange:C.length>0,dxCombos:b,hasDXCombo:b.length>0,illustrations:m,hasIllustration:m.length>0,effects:{sfx:null,bgm:null,background:null,backgroundOpacity:.3}})}static parseRoll20DiceTemplate(e){var s;try{const r=(s=e.querySelector("caption"))==null?void 0:s.textContent.trim(),t=e.querySelectorAll("tr");let n=null,i=null,o=null,l=null;if(t.forEach(g=>{var D;const d=(D=g.querySelector(".sheet-template_label"))==null?void 0:D.textContent.trim(),m=g.querySelector(".sheet-template_value");if(d&&m){const h=m.textContent.trim();if(d.includes("ê¸°ì¤€ì¹˜")||d.includes("value")){const y=h.split("/");n=parseInt(y[0],10)}else if(d.includes("êµ´ë¦¼")||d.includes("rolled")){const y=h.match(/\d+/);y&&(i=parseInt(y[0],10));const b=h.match(/\d+/g);b&&b.length>1&&(l=b.slice(1).map(C=>parseInt(C,10)))}else(d.includes("íŒì •ê²°ê³¼")||d.includes("result")||d.includes("íŒì •"))&&(o=h)}}),i!==null){const g={type:"judgement",checkName:r||"íŒì •",formula:n?`1D100<=${n}`:"1D100",threshold:n||100,result:i,judgement:o||"ì•Œ ìˆ˜ ì—†ìŒ"};return l&&l.length>0&&(g.bonusDice=l),g}}catch(r){console.error("Roll20 ë‹¤ì´ìŠ¤ í…œí”Œë¦¿ íŒŒì‹± ì˜¤ë¥˜:",r)}return null}static parseRoll20DX3Template(e){var s,r,t,n,i;try{const o=(s=e.querySelector(".sheet-chname"))==null?void 0:s.textContent.trim(),l=(r=e.querySelector(".sheet-title"))==null?void 0:r.textContent.trim(),g=(t=e.querySelector(".sheet-sub-title"))==null?void 0:t.textContent.trim(),d=(n=e.querySelector(".sheet-mid-title"))==null?void 0:n.textContent.trim(),m=(i=e.querySelector(".sheet-descript"))==null?void 0:i.textContent.trim();let D=null,h=null,y=null;const b=e.querySelector(".sheet-dicearea");if(b){const p=b.querySelector(".inlinerollresult");if(p){D=parseInt(p.textContent.trim(),10);const c=e.querySelector(".sheet-sub-title .inlinerollresult");if(c){const a=c.getAttribute("title");(a==null?void 0:a.match(/Rolling\s+\d+\s*=\s*(\d+)/i))&&(h=g.trim())}}}const C=e.querySelector(".sheet-dicedetail .inlinerollresult");C&&(y=C.textContent.trim());const f={};return e.querySelectorAll(".sheet-info p, .sheet-info span").forEach(p=>{const c=p.querySelector("strong");if(c){const a=c.textContent.trim(),u=p.textContent.replace(c.textContent,"").trim();a==="íƒ€ì´ë°"?f.timing=u:a==="ë‚œì´ë„"?f.difficulty=u:a==="ëŒ€ìƒ"?f.target=u:a==="ì‚¬ê±°ë¦¬"?f.range=u:a==="ê³µê²©ë ¥"?f.attack=u:a==="ì¹¨ì‹ì¹˜"||a==="ì¹¨ì‹ë¥ "?f.erosion=u:a==="Lv"?f.level=u:a==="ê¸°ëŠ¥"&&(f.spec=u)}}),{type:"dx-effect",isSingleEffect:!0,characterName:o,effectName:l,comboName:d||null,effects:[{name:l,level:f.level?parseInt(f.level,10):null}],timing:f.timing||"",difficulty:f.difficulty||"",target:f.target||"",range:f.range||"",attack:f.attack||"",erosion:f.erosion||"",spec:f.spec||"",description:m||"",diceRoll:D?{type:"dx3",formula:h||"",result:D,detail:y||""}:null}}catch(o){console.error("Roll20 DX3 í…œí”Œë¦¿ íŒŒì‹± ì˜¤ë¥˜:",o)}return null}static parseRoll20TableTemplate(e){var s;try{const r=(s=e.querySelector("caption"))==null?void 0:s.textContent.trim(),t=e.querySelector("table");if(!t)return null;let n='<div class="roll20-table">';return r&&(n+=`<div class="table-caption"><strong>${r}</strong></div>`),n+="<table>",t.querySelectorAll("tr").forEach(o=>{const l=o.querySelectorAll("td");l.length>0&&(n+="<tr>",l.forEach(g=>{const d=g.querySelector(".inlinerollresult");let m=g.innerHTML;m=m.replace(/<span[^>]*>/gi,""),m=m.replace(/<\/span>/gi,""),n+=`<td>${m}</td>`}),n+="</tr>")}),n+="</table></div>",{type:"table",caption:r,html:n}}catch(r){console.error("Roll20 í…Œì´ë¸” í…œí”Œë¦¿ íŒŒì‹± ì˜¤ë¥˜:",r)}return null}static parse(e,s=null,r="auto"){if(!e)throw new Error("ë¡œê·¸ ë‚´ìš©ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");let t;if(r==="roll20")console.log("[Parser] ê°•ì œ Roll20 ëª¨ë“œ"),t=this.parseRoll20Log(e);else if(r==="cocofolia")console.log("[Parser] ê°•ì œ Cocofolia ëª¨ë“œ"),t=this.parseHTMLLog(e);else if(r==="cclog-custom")console.log("[Parser] ê°•ì œ CCLog-Custom ëª¨ë“œ"),t=this.parseHTMLLog(e);else if(r==="auto")if(console.log("[Parser] ìë™ ê°ì§€ ëª¨ë“œ"),e.trim().startsWith("<!DOCTYPE html")||e.trim().startsWith("<html"))e.includes('class="message"')&&(e.includes('class="sheet-rolltemplate')||e.includes('class="by"')||e.includes("Chat Log for"))?(console.log("[Parser] Roll20 ë¡œê·¸ ê°ì§€"),t=this.parseRoll20Log(e)):e.includes('<div class="ccfolia_wrap"')&&(e.includes('<div class="gap"')||e.includes("message-container"))?(console.log("[Parser] cclog-custom ë¡œê·¸ ê°ì§€"),t=this.parseHTMLLog(e)):e.includes('<div class="cclog_wrap"')?(console.log("[Parser] Cocofolia ë¡œê·¸ ê°ì§€"),t=this.parseHTMLLog(e)):(console.log("[Parser] ê¸°ë³¸ HTML íŒŒì„œ ì‚¬ìš©"),t=this.parseHTMLLog(e));else if(e.trim().startsWith("{")||e.trim().startsWith("[")){console.log("[Parser] JSON í˜•ì‹ ê°ì§€");try{t=JSON.parse(e)}catch(n){throw new Error("JSON íŒŒì‹± ì‹¤íŒ¨: "+n.message)}}else console.log("[Parser] í”Œë ˆì¸ í…ìŠ¤íŠ¸ë¡œ ì²˜ë¦¬"),t=this.parseTextLog(e);if(t.fileCode=this.generateFileCode(e),s){const n=s.replace(/\.(txt|log|json|html)$/i,"");t.title=n||t.title,t.fileName=s}return t}static generateFileCode(e){let s=0;for(let r=0;r<e.length;r++){const t=e.charCodeAt(r);s=(s<<5)-s+t,s=s&s}return"file_"+Math.abs(s).toString(36)+"_"+e.length}}const Y={name:"Home",setup(){return{logStore:B()}},data(){return{isLoading:!1,errorMessage:"",parserMode:"cocofolia",fileUrl:""}},methods:{triggerFileInput(){this.$refs.fileInput.click()},triggerJSONInput(){this.$refs.jsonInput.click()},convertToDirectDownloadURL(q){const e=q.trim(),s=e.match(/drive\.google\.com\/file\/d\/([^\/]+)/);return s?`https://drive.google.com/uc?export=download&id=${s[1]}`:e.includes("dropbox.com")?e.replace(/[?&]dl=0/,"?dl=1"):e.includes("1drv.ms")||e.includes("onedrive.live.com")?e.replace("/embed?","/download?"):e},async handleURLLoad(){if(!this.fileUrl.trim()){this.errorMessage="URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";return}this.isLoading=!0,this.errorMessage="";try{const q=this.convertToDirectDownloadURL(this.fileUrl);console.log("[Home] URL ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘:",{original:this.fileUrl,converted:q});const e=await fetch(q,{method:"GET",mode:"cors"});if(!e.ok)throw new Error(`íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (${e.status})`);const s=e.headers.get("content-type"),r=await e.text();if(console.log("[Home] URL íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:",{contentType:s,contentLength:r.length,preview:r.substring(0,200)}),s!=null&&s.includes("application/json")||this.fileUrl.endsWith(".json")){const t=JSON.parse(r);if(!t.scenes||!Array.isArray(t.scenes))throw new Error("ìœ íš¨í•˜ì§€ ì•Šì€ VN ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.");this.logStore.setRawLog(JSON.stringify(t)),this.logStore.setVNData(t,!0),this.$router.push("/player")}else{this.logStore.setRawLog(r);const t=V.parse(r,"url-file.html",this.parserMode);if(!t.scenes||t.scenes.length===0)throw new Error("íŒŒì‹±ëœ ì”¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");this.logStore.setVNData(t),this.$router.push("/player")}this.fileUrl=""}catch(q){console.error("[Home] URL ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:",q),q.name==="TypeError"&&q.message.includes("Failed to fetch")?this.errorMessage="CORS ì˜¤ë¥˜: íŒŒì¼ì´ ê³µê°œ ê³µìœ ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì§ì ‘ ë‹¤ìš´ë¡œë“œë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.":this.errorMessage=`íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${q.message}`}finally{this.isLoading=!1}},handleJSONSelect(q){const e=q.target.files[0];if(!e)return;if(!e.name.endsWith(".json")){this.errorMessage="JSON íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.";return}this.isLoading=!0,this.errorMessage="";const s=new FileReader;s.onload=r=>{try{const t=r.target.result,n=JSON.parse(t);let i=null,o=null;if(n.vnData&&n.version)i=n.vnData,o=n.theme||null,console.log("[Home] ìƒˆ í˜•ì‹ JSON ê°ì§€ (v"+n.version+")");else if(n.scenes)i=n,console.log("[Home] êµ¬ í˜•ì‹ JSON ê°ì§€ (í˜¸í™˜ ëª¨ë“œ)");else throw new Error("ìœ íš¨í•˜ì§€ ì•Šì€ JSON í˜•ì‹ì…ë‹ˆë‹¤.");if(!i.scenes||!Array.isArray(i.scenes))throw new Error("ìœ íš¨í•˜ì§€ ì•Šì€ VN ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.");if(console.log("[Home] JSON ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ:",{title:i.title,sceneCount:i.scenes.length,hasTheme:!!o}),o)try{localStorage.setItem("vnlog-theme-settings",JSON.stringify(o)),console.log("[Home] í…Œë§ˆ ì„¤ì • ì ìš© ì™„ë£Œ")}catch(l){console.warn("[Home] í…Œë§ˆ ì„¤ì • ì €ì¥ ì‹¤íŒ¨:",l)}this.logStore.setRawLog(JSON.stringify(i)),this.logStore.setVNData(i,!0),this.$router.push("/player")}catch(t){console.error("[Home] JSON íŒŒì‹± ì˜¤ë¥˜:",t),this.errorMessage=`JSON íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${t.message}`}finally{this.isLoading=!1}},s.onerror=()=>{this.errorMessage="íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",this.isLoading=!1},s.readAsText(e)},async handleFileSelect(q){const e=q.target.files[0];if(!e)return;this.isLoading=!0,this.errorMessage="";const s=new FileReader;s.onload=r=>{var t,n;try{const i=r.target.result;console.log("[Home] íŒŒì¼ ì½ê¸° ì™„ë£Œ:",{fileName:e.name,fileSize:i.length,parserMode:this.parserMode,contentPreview:i.substring(0,200)}),this.logStore.setRawLog(i);const o=V.parse(i,e.name,this.parserMode);if(console.log("[Home] íŒŒì‹± ì™„ë£Œ:",{title:o.title,sceneCount:((t=o.scenes)==null?void 0:t.length)||0,characterCount:Object.keys(o.characters||{}).length,firstScene:(n=o.scenes)==null?void 0:n[0]}),!o.scenes||o.scenes.length===0)throw new Error("íŒŒì‹±ëœ ì”¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");this.logStore.setVNData(o),console.log("[Home] logStoreì— ë°ì´í„° ì €ì¥ ì™„ë£Œ, PlayerViewë¡œ ì´ë™"),this.$refs.fileInput.value="",this.$router.push("/player")}catch(i){console.error("[Home] íŒŒì‹± ì˜¤ë¥˜:",i),this.errorMessage=`íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨: ${i.message}`,this.$refs.fileInput.value=""}finally{this.isLoading=!1}},s.onerror=()=>{this.errorMessage="íŒŒì¼ ì½ê¸° ì‹¤íŒ¨",this.isLoading=!1,this.$refs.fileInput.value=""},s.readAsText(e)}}},K={class:"home"},Q={class:"container"},ee={class:"header"},te={class:"parser-mode-section"},se={class:"mode-buttons"},le={class:"upload-section"},oe={class:"upload-card"},re=["disabled"],ne={key:0,class:"error-message"},ie={class:"upload-card"},ce=["disabled"];function ae(q,e,s,r,t,n){const i=z("EmojiToIcon");return J(),_("div",K,[T("div",Q,[T("header",ee,[T("h1",null,[$(i,{emoji:"ğŸ“–",size:40}),e[7]||(e[7]=U(" VNLog Player (v0.9.3) ",-1))]),e[8]||(e[8]=X('<p class="subtitle" data-v-e28e119c>TRPG ë¡œê·¸ë¥¼ ë¹„ì£¼ì–¼ ë…¸ë²¨ë¡œ ì¬ìƒí•˜ì„¸ìš”</p><details class="patch-notes" data-v-e28e119c><summary data-v-e28e119c> íŒ¨ì¹˜ ë‚´ì—­ ë³´ê¸° </summary><div class="patch-list" data-v-e28e119c><small data-v-e28e119c>(2025.11.19 15:28) ì €ì¥ &amp; ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥ ì¶”ê°€, ìë™ì¬ìƒ ì†ë„ ê°œì„ </small><small data-v-e28e119c>(2025.11.20 09:45) ëª¨ë°”ì¼ ì§€ì› ì¶”ê°€ ë° ìë™ì¬ìƒ ë²„ê·¸ ìˆ˜ì •</small><small data-v-e28e119c>(2025.11.20 11:39) ë¡œê·¸ í¸ì§‘ ëª¨ë“œ ì¶”ê°€ ë° ìì˜í•œ ë²„ê·¸ ê°œì„ </small><small data-v-e28e119c>(2025.11.24 10:23) ê°„í—ì ìœ¼ë¡œ ìŠ¤í…ì´ ë¶„ë¦¬ë˜ì§€ ì•ŠëŠ” ë²„ê·¸ ë° ìì˜í•œ ë¹„ì£¼ì–¼ ìˆ˜ì •</small><small data-v-e28e119c>(2025.11.24 12:00) ì¸ë²•/ì˜¤ì˜/íŒì •/ì„ íƒ/í…Œì´ë¸” ë‹¤ì´ìŠ¤ í‘œì‹œ ê¸°ëŠ¥ ì¶”ê°€</small><small data-v-e28e119c>(2025.11.24 13:09) ì½”ì½”í¬ë¦¬ì•„ ì»¤ìŠ¤í…€ ë¡œê·¸ íŒŒì„œ ëª¨ë“œ ì¶”ê°€</small><small data-v-e28e119c>(2025.11.24 17:53) ì•„ë°”íƒ€, ë°°ê²½ì´ë¯¸ì§€, BGM, SFX íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥ ì§€ì›</small><small data-v-e28e119c>(2025.11.25 10.12) ê°ìƒ ëª¨ë“œ ë° ì¬ìƒì†ë„ ì¡°ì ˆ ê¸°ëŠ¥ ì¶”ê°€</small><small data-v-e28e119c>(2025.11.27 09:46) ì„ë² ë“œ í”Œë ˆì´ì–´ ì¶”ê°€</small><small data-v-e28e119c>(2025.11.27 14:17) íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë§í¬ë¡œë¶€í„° ë¶ˆëŸ¬ì˜¤ê¸° ì§€ì›</small><small data-v-e28e119c>(2025.11.27 17:28) CSS ì»¤ìŠ¤í„°ë§ˆì´ì§• ê¸°ëŠ¥ ì¶”ê°€(ë² íƒ€)</small><small data-v-e28e119c>(2026.01.04 22:38) .html ë¡œê·¸ íŒŒì„œ 2ë²„ì „ í˜¸í™˜ì„± ì ìš©</small><small data-v-e28e119c>(2026.01.05 11:34) .html ë¡œê·¸ íŒŒì„œ 2ë²„ì „ì—ì„œ íŠ¹ìˆ˜ ë©”ì„¸ì§€ í‘œê¸° ì•ˆë¨ ë²„ê·¸ ìˆ˜ì •</small><small data-v-e28e119c>(2026.01.18 10:41) ê°ìƒ ëª¨ë“œë¡œ ì¬ìƒ ì‹œ bgmì´ ì¬ìƒë˜ì§€ ì•ŠëŠ” ë¬¸ì œ ì™¸ 2ê±´</small><small data-v-e28e119c>(2026.01.29 13:37) ë™ì¼ í…ìŠ¤íŠ¸ ìŠ¤í… ì—°ì† ì‹œ ìë™ì¬ìƒ ì •ì§€ ì´ìŠˆ ìˆ˜ì •</small></div></details>',2))]),T("div",te,[e[15]||(e[15]=T("h2",null,"íŒŒì„œ ëª¨ë“œ ì„ íƒ",-1)),T("div",se,[T("button",{class:H(["mode-button",{active:t.parserMode==="cocofolia"}]),onClick:e[0]||(e[0]=o=>t.parserMode="cocofolia")},[$(i,{emoji:"ğŸ¦",size:24}),e[9]||(e[9]=T("span",null,"Cocolog",-1)),e[10]||(e[10]=T("small",null,"ì½”ì½”ë¡œê·¸ í˜•ì‹ .html",-1))],2),T("button",{class:H(["mode-button",{active:t.parserMode==="roll20"}]),onClick:e[1]||(e[1]=o=>t.parserMode="roll20")},[$(i,{emoji:"ğŸ²",size:24}),e[11]||(e[11]=T("span",null,"Roll20",-1)),e[12]||(e[12]=T("small",null,"Roll20 ì±„íŒ… ë¡œê·¸ .html",-1))],2),T("button",{class:H(["mode-button",{active:t.parserMode==="cclog-custom"}]),onClick:e[2]||(e[2]=o=>t.parserMode="cclog-custom")},[$(i,{emoji:"ğŸ”§",size:24}),e[13]||(e[13]=T("span",null,"CCLog Custom",-1)),e[14]||(e[14]=T("small",null,"ì»¤ìŠ¤í…€ ccfolia ë¡œê·¸ .html",-1))],2)])]),T("div",le,[T("div",oe,[$(i,{emoji:"ğŸ“",size:48,class:"upload-icon"}),e[16]||(e[16]=T("h2",null,"ë¡œê·¸ íŒŒì¼ ì—…ë¡œë“œ",-1)),e[17]||(e[17]=T("p",null,"HTML ë¡œê·¸ íŒŒì¼ì„ ì„ íƒí•˜ì—¬ íŒŒì‹±í•©ë‹ˆë‹¤",-1)),T("input",{ref:"fileInput",type:"file",accept:".txt,.log,.html",onChange:e[3]||(e[3]=(...o)=>n.handleFileSelect&&n.handleFileSelect(...o)),class:"file-input"},null,544),T("button",{onClick:e[4]||(e[4]=(...o)=>n.triggerFileInput&&n.triggerFileInput(...o)),class:"upload-button",disabled:t.isLoading},[$(i,{emoji:"ğŸ“¤",size:20}),U(" "+j(t.isLoading?"ì²˜ë¦¬ ì¤‘...":"íŒŒì¼ ì„ íƒ"),1)],8,re),t.errorMessage?(J(),_("p",ne,j(t.errorMessage),1)):Z("",!0)]),e[20]||(e[20]=T("div",{class:"upload-divider"},[T("span",null,"ë˜ëŠ”")],-1)),T("div",ie,[$(i,{emoji:"ğŸ’»",size:48,class:"upload-icon"}),e[18]||(e[18]=T("h2",null,"JSON íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°",-1)),e[19]||(e[19]=T("p",null,"í¸ì§‘ëœ VN ë°ì´í„°ë¥¼ ì§ì ‘ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤ (íŒŒì‹± ìƒëµ)",-1)),T("input",{ref:"jsonInput",type:"file",accept:".json",onChange:e[5]||(e[5]=(...o)=>n.handleJSONSelect&&n.handleJSONSelect(...o)),class:"file-input"},null,544),T("button",{onClick:e[6]||(e[6]=(...o)=>n.triggerJSONInput&&n.triggerJSONInput(...o)),class:"upload-button json-button",disabled:t.isLoading},[$(i,{emoji:"ğŸ“¦",size:20}),U(" "+j(t.isLoading?"ì²˜ë¦¬ ì¤‘...":"JSON ì„ íƒ"),1)],8,ce)]),e[21]||(e[21]=T("div",{class:"features"},[T("a",{href:"https://www.postype.com/@logforme/post/17320264",target:"_blank",class:"feature-card"}," Cocolog "),T("a",{href:"https://roll20.net/",target:"_blank",class:"feature-card"}," Roll20 "),T("a",{href:"https://sukenell.github.io/cclog_custom/",target:"_blank",class:"feature-card"}," CCFolia ì±„íŒ… ë¡œê·¸ ì»¤ìŠ¤í…€ ")],-1))])])])}const ge=G(Y,[["render",ae],["__scopeId","data-v-e28e119c"]]);export{ge as default};
