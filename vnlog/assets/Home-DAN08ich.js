import{u as A}from"./logStore-BtNb8HMr.js";import{_ as q,c as L,a as _,b as k,d as N,r as U,e as M,t as P,o as $}from"./index-Bgn5HBnd.js";class j{static parseHTMLLog(e){const i=new DOMParser().parseFromString(e,"text/html"),t={title:"ì½”ì½”í¬ë¦¬ì•„ ë¡œê·¸",scenes:[],characters:{},handouts:[]},l=i.querySelectorAll(".ccl_tab");if(l.length>0)l.forEach((o,r)=>{const n=this.parseScene(o,r);n.steps.length>0&&t.scenes.push(n),this.collectCharacters(o,t.characters)});else{const o=i.querySelector(".ccfolia_wrap")||i.body,r=this.parseSceneFlat(o);r.steps.length>0&&t.scenes.push(r),this.collectCharactersFlat(o,t.characters)}return t}static parseScene(e,s){const i=e.querySelector(".ccl_tabtitle"),t=i?i.textContent.trim():`ì”¬ ${s+1}`,l={id:`scene_${s}`,name:t,description:null,steps:[]},o=e.querySelectorAll(".ccl_player");let r=0;return o.forEach(n=>{const a=this.parseStep(n,s,r);a&&a.length>0&&a.forEach(u=>{l.steps.push(u),r++})}),l}static parseStep(e,s,i){const t=e.classList.contains("system"),l=e.classList.contains("narrator"),o=e.querySelector(".ccl_Uname"),r=e.querySelector(".ccl_Utext"),n=e.querySelector(".ccl_imgWrap img");if(!r)return null;const a=o?o.textContent.trim():"",u=o?this.extractColor(o):"#333333",d=r.innerHTML.trim(),b=n?n.getAttribute("src"):null,S=/^ì”¬\s+(\d+)::\s*(.+?)(?:\s*\(([^)]+)\))?\s*(?:<br|$)/i,p=d.match(S);if(p){const c=p[1],f=p[2]?p[2].trim():"",m=p[3]?p[3].trim():null;let g="";const y=d.indexOf("<br>");return y!==-1&&(g=this.cleanText(d.substring(y+4))),console.log("Scene Description Parsed:",{sceneNumber:c,sceneTitle:f,scenePCs:m,sceneDescription:g,rawHTML:d.substring(0,100)}),[{id:`scene_${s}_desc_${i}`,type:"scene-description",character:{name:a,color:u},text:this.cleanText(d),rawText:d,isSceneDescription:!0,sceneNumber:c,sceneTitle:f,scenePCs:m,sceneDescription:g,avatarUrl:b}]}const C=this.splitByBreaks(d),h=[];return C.forEach((c,f)=>{if(!c.trim())return;const m=this.extractDiceRolls(c),g=this.extractStatusChanges(c),y=this.extractDXCombo(c);let x=c;if((m.length>0||g.length>0||y.length>0)&&(x=this.removeDiceCommands(c)),m.length>0&&!this.cleanText(x).trim()){const F=m.some(R=>R.type==="judgement"),w=m.some(R=>R.type==="choice");F?x="* íŒì •":w?x="* ì„ íƒ":x="* ë‹¤ì´ìŠ¤"}g.length>0&&!this.cleanText(x).trim()&&(x="* ìƒíƒœ ë³€í™”");const T={id:`step_${s}_${i+f}`,type:t?"system":l?"narrator":"dialogue",character:{name:a,color:u,avatarUrl:b},text:this.cleanText(x),rawText:c,diceRolls:m,hasDice:m.length>0,statusChanges:g,hasStatusChange:g.length>0,dxCombos:y,hasDXCombo:y.length>0};h.push(T)}),h.length>0?h:null}static splitByBreaks(e){return e.split(/<br\s*\/?>/gi).map(s=>s.trim()).filter(s=>s.length>0)}static parseSceneFlat(e){const s={id:"scene_0",name:"ë¡œê·¸",description:null,steps:[]},i=e.querySelectorAll(".gap");let t=0;return i.forEach(l=>{const o=this.parseStepFlat(l,0,t);o&&o.length>0&&o.forEach(r=>{s.steps.push(r),t++})}),s}static parseStepFlat(e,s,i){const t=e.querySelector("p");if(!t)return null;if((e.getAttribute("style")||"").includes("display: flow-root"))return this.parseFlowRootStep(t,s,i);const r=e.querySelector(".msg_container img"),n=t.querySelectorAll("span");let a="",u="#333333",d="";n.forEach(c=>{var f;window.getComputedStyle||c.style.fontWeight,(c.style.fontWeight==="bold"||(f=c.getAttribute("style"))!=null&&f.includes("font-weight: bold"))&&(a||(a=c.textContent.trim(),u=this.extractColorFromStyle(c.getAttribute("style"))||"#333333"))});const b=t.innerHTML,S=b.indexOf("<br>");if(S!==-1&&(d=b.substring(S+4).trim()),!d)return null;const p=r?r.getAttribute("src"):null,C=this.splitByBreaks(d),h=[];return C.forEach((c,f)=>{if(!c.trim())return;const m=this.extractDiceRolls(c),g=this.extractStatusChanges(c);let y=c;if((m.length>0||g.length>0)&&(y=this.removeDiceCommands(c)),m.length>0&&!this.cleanText(y).trim()){const T=m.some(w=>w.type==="judgement"),F=m.some(w=>w.type==="choice");T?y="* íŒì •":F?y="* ì„ íƒ":y="* ë‹¤ì´ìŠ¤"}g.length>0&&!this.cleanText(y).trim()&&(y="* ìƒíƒœ ë³€í™”");const x={id:`step_${s}_${i+f}`,type:a==="GM"?"narrator":"dialogue",character:{name:a,color:u,avatarUrl:p},text:this.cleanText(y),rawText:c,diceRolls:m,hasDice:m.length>0,statusChanges:g,hasStatusChange:g.length>0,dxCombos:this.extractDXCombo(c),hasDXCombo:this.extractDXCombo(c).length>0};h.push(x)}),h.length>0?h:null}static collectCharacters(e,s){e.querySelectorAll(".ccl_player:not(.system):not(.narrator)").forEach(t=>{const l=t.querySelector(".ccl_Uname"),o=t.querySelector(".ccl_imgWrap img");if(l){const r=l.textContent.trim(),n=this.extractColor(l),a=o?o.getAttribute("src"):null;r&&!s[r]&&(s[r]={id:`char_${Object.keys(s).length}`,name:r,color:n,avatarUrl:a,emotions:{default:a}})}})}static parseFlowRootStep(e,s,i){const t=e.querySelectorAll("span");let l="",o="#333333",r="",n=!1;if(t.forEach((p,C)=>{const h=p.getAttribute("style")||"",c=p.textContent.trim();if(h.includes("background: black")||h.includes("background:black")){n=!0;const f=c.split(" - ");f.length>=1&&(l=f[0].trim())}if(!o||o==="#333333"){const f=this.extractColorFromStyle(h);f&&!h.includes("background: black")&&(o=f)}c&&!h.includes("background: black")&&!h.includes("background:black")&&(c.includes("cc")||c.includes("CHOICE")||c.includes("choice")||c.includes("ï¼"))&&(r=c)}),!l){const C=e.textContent.trim().match(/^([^-]+)\s*-\s*íŒì •/);C&&(l=C[1].trim())}if(!r){const p=e.textContent.trim();if(n){const C=p.split(/íŒì •\s*/);C.length>1&&(r=C[1].trim())}r||(r=p)}if(r=r.replace(/^[^-]+-\s*íŒì •\s*/,"").trim(),!r)return null;const a=this.extractDiceRolls(r),u=this.extractStatusChanges(r);let d=r;if((a.length>0||u.length>0)&&(d=this.removeDiceCommands(r)),a.length>0&&!d.trim()){const p=a.some(h=>h.type==="judgement"),C=a.some(h=>h.type==="choice");p?d="* íŒì •":C?d="* ì„ íƒ":d="* ë‹¤ì´ìŠ¤"}u.length>0&&!d.trim()&&(d="* ìƒíƒœ ë³€í™”");const b=this.extractDXCombo(r);return[{id:`step_${s}_${i}`,type:"system",character:{name:l||"ì‹œìŠ¤í…œ",color:o,avatarUrl:null},text:this.cleanText(d),rawText:r,diceRolls:a,hasDice:a.length>0,statusChanges:u,hasStatusChange:u.length>0,dxCombos:b,hasDXCombo:b.length>0}]}static collectCharactersFlat(e,s){e.querySelectorAll(".gap").forEach(t=>{const l=t.querySelector(".msg_container img"),o=t.querySelector("p");if(o){const r=o.querySelectorAll("span");let n="",a="#333333";if(r.forEach(u=>{var d;(u.style.fontWeight==="bold"||(d=u.getAttribute("style"))!=null&&d.includes("font-weight: bold"))&&(n||(n=u.textContent.trim(),a=this.extractColorFromStyle(u.getAttribute("style"))||"#333333"))}),n&&!s[n]){const u=l?l.getAttribute("src"):null;s[n]={id:`char_${Object.keys(s).length}`,name:n,color:a,avatarUrl:u,emotions:{default:u}}}}})}static extractColorFromStyle(e){if(!e)return null;const s=e.match(/color:\s*rgb\(([^)]+)\)/);if(s)return`rgb(${s[1]})`;const i=e.match(/color:\s*(#[0-9a-fA-F]{3,6})/);return i?i[1]:null}static extractColor(e){const s=e.getAttribute("style");if(s){const i=s.match(/color:\s*([^;]+)/);if(i)return i[1].trim()}return"#333333"}static extractDXCombo(e){const s=[],i=/(?:(\d+)[â†‘â†“])?\s*([^ã€Š\|]+?)?\s*ã€ŠC:([^ã€‹]+)ã€‹(?:\s*\|\s*([^\|]+)\s*\|\s*([^\|]+)\s*\|\s*(.+?))?(?:<br\s*\/?>|\n)?(?:\s*(\d+dx\d*(?:\+\d+)?)\s*\(([^)]+)\)\s*[ï¼>]\s*([^\sï¼>]+)\s*[ï¼>]\s*(\d+))?(?:<br\s*\/?>|$)/gim;let t;for(;(t=i.exec(e))!==null;){const r=t[1]?parseInt(t[1],10):null,n=t[2]?t[2].trim():"",a=t[3].trim(),u=t[4]?t[4].trim():"",d=t[5]?t[5].trim():"",b=t[6]?t[6].trim():"",S=t[7],p=t[8],C=t[9],h=t[10],c=[];if(a.split("+").forEach(m=>{const g=m.trim().match(/(.+?)\((\d+)\)/);g&&c.push({name:g[1].trim(),level:parseInt(g[2],10)})}),c.length>0){const m=u.split("/").map(D=>D.trim()),g=m[0]||"",y=m[1]||"",x=d.split("/").map(D=>D.trim()),T=(x[0]||"").replace(/^ë‹¤ì´ìŠ¤\s*/i,""),F=(x[1]||"").replace(/^í¬ë¦¬ì¹˜\s*/i,""),w=(x[2]||"").replace(/^ê³µê²©ë ¥\s*/i,""),R=(x[3]||"").replace(/^ì¹¨ì‹\s*/i,"");let v=null;S&&h&&(v={type:"dx3",formula:S.toUpperCase(),fullFormula:p,diceRolls:C,result:parseInt(h,10)}),s.push({type:"dx-combo",isSingleEffect:c.length===1,comboName:n,effects:c,erosionCost:r,timing:g,difficulty:y,dice:T,critical:F,attack:w,erosion:R,description:b,diceRoll:v,rawText:t[0]})}}const l=/ã€Š([^ã€‹]+)ã€‹\s*Lv(\d+)\s*\|\s*([^\|]+)\s*\|\s*([^\|]+)\s*\|\s*([^\|]+)\s*\|\s*([^\|]+)\s*\|\s*([^\|]+)(?:\s*\|\s*(.+?))?(?:<br\s*\/?>|\n)?(?:\s*(\d+dx\d*(?:\+\d+)?)\s*\(([^)]+)\)\s*[ï¼>]\s*([^\sï¼>]+)\s*[ï¼>]\s*(\d+))?(?:<br\s*\/?>|$)/gim;for(;(t=l.exec(e))!==null;){const r=t[1].trim(),n=parseInt(t[2],10),a=t[3].trim(),u=t[4].trim(),d=t[5].trim(),b=t[6].trim(),S=t[7].trim(),p=t[8]?t[8].trim():"",C=t[9],h=t[10],c=t[11],f=t[12];let m=null;C&&f&&(m={type:"dx3",formula:C.toUpperCase(),fullFormula:h,diceRolls:c,result:parseInt(f,10)}),s.push({type:"dx-effect",isSingleEffect:!0,effects:[{name:r,level:n}],timing:a,difficulty:u,target:d,range:b,description:S,erosion:p,diceRoll:m,rawText:t[0]})}const o=/(?:(\d+)[â†‘â†“])?\s*([^\|ã€Š]+?)?\s*(ã€Š[^ã€‹]+ã€‹(?:\s*\+\s*ã€Š[^ã€‹]+ã€‹)+)\s*(?:\|\s*([^\|]+)\s*\|\s*([^\|]+)\s*\|\s*(.+?))?(?:<br\s*\/?>|\n)?(?:\s*(\d+dx\d*(?:\+\d+)?)\s*\(([^)]+)\)\s*[ï¼>]\s*([^\sï¼>]+)\s*[ï¼>]\s*(\d+))?(?:<br\s*\/?>|$)/gim;for(;(t=o.exec(e))!==null;){const r=t[1]?parseInt(t[1],10):null,n=t[2]?t[2].trim():"",a=t[3],u=t[4]?t[4].trim():"",d=t[5]?t[5].trim():"",b=t[6]?t[6].trim():"",S=t[7],p=t[8],C=t[9],h=t[10],c=[],f=a.match(/ã€Š([^ã€‹]+)ã€‹/gi);f&&f.forEach(D=>{const I=D.match(/ã€Š(.+?)\((\d+)\)ã€‹/);I&&c.push({name:I[1].trim(),level:parseInt(I[2],10)})});const m=u.split("/").map(D=>D.trim()),g=m[0]||"",y=m[1]||"",x=d.split("/").map(D=>D.trim()),T=(x[0]||"").replace(/^ë‹¤ì´ìŠ¤\s*/i,""),F=(x[1]||"").replace(/^í¬ë¦¬ì¹˜\s*/i,""),w=(x[2]||"").replace(/^ê³µê²©ë ¥\s*/i,""),R=(x[3]||"").replace(/^ì¹¨ì‹\s*/i,"");let v=null;S&&h&&(v={type:"dx3",formula:S.toUpperCase(),fullFormula:p,diceRolls:C,result:parseInt(h,10)}),c.length>1&&s.push({type:"dx-combo",isSingleEffect:!1,comboName:n,effects:c,erosionCost:r,timing:g,difficulty:y,dice:T,critical:F,attack:w,erosion:R,description:b,diceRoll:v,rawText:t[0]})}return s}static extractStatusChanges(e){const s=[],i=/\[\s*([^\]]+)\s*\]\s*([^:ï¼š]+)\s*[ï¼š:]\s*(\d+)\s*[â†’>]\s*(\d+)/gi;let t;for(;(t=i.exec(e))!==null;){const l=t[1].trim(),o=t[2].trim(),r=parseInt(t[3],10),n=parseInt(t[4],10);s.push({characterName:l,statusName:o,oldValue:r,newValue:n,delta:n-r})}return s}static extractDiceRolls(e){const s=[],i=/(?:CHOICE|choice)\[([^\]]+)\]\([^)]+\)\s*[ï¼>]\s*(.+?)(?:<|$)/gi;let t;for(;(t=i.exec(e))!==null;){const n=t[1].split(",").map(u=>u.trim()),a=t[2].trim();s.push({type:"choice",options:n,result:a,formula:`CHOICE[${n.join(",")}]`})}const l=/(cc[<>=]+\d+)\s+(.+?)\((\d+[dD]\d+[<>=]+\d+)\)\s*.*?[ï¼>]\s*(\d+)(?:\s*[ï¼>]\s*\d+)*\s*[ï¼>]\s*(.+?)$/gi;for(;(t=l.exec(e))!==null;)s.push({type:"judgement",command:t[1],checkName:t[2].trim(),formula:t[3],result:parseInt(t[4],10),judgement:t[5].trim()});const o=/(\d+dx\d*(?:\+\d+)?)\s*\(([^)]+)\)\s*[ï¼>]\s*([^\sï¼>]+)\s*[ï¼>]\s*(\d+)/gi;for(;(t=o.exec(e))!==null;)s.push({type:"dx3",formula:t[1].toUpperCase(),fullFormula:t[2],diceRolls:t[3],result:parseInt(t[4],10)});const r=/(\d+[dD]\d+)\s*(?:\([^)]+\))?\s*[ï¼>]\s*(\d+)/gi;for(;(t=r.exec(e))!==null;)t[1].toLowerCase().includes("dx")||s.push({type:"normal",formula:t[1].toUpperCase(),result:parseInt(t[2],10)});return s}static cleanText(e){return e.replace(/<br\s*\/?>/gi,`
`).replace(/<[^>]+>/g,"").trim()}static removeDiceCommands(e){let s=e;return s=s.replace(/(?:CHOICE|choice)\[[^\]]+\]\([^)]+\)\s*[ï¼>]\s*.+?(?=<|$)/gi,""),s=s.replace(/(cc[<>=]+\d+)\s+(.*?)\((\d+D\d+[<>=]+\d+)\)\s*[^ï¼>]*?ï¼\s*\d+(?:\s*ï¼\s*\d+)*\s*ï¼\s*.+?$/gi,""),s=s.replace(/(\d+dx\d*(?:\+\d+)?)\s*\([^)]+\)\s*[ï¼>]\s*[^\sï¼>]+\s*[ï¼>]\s*\d+/gi,""),s=s.replace(/(\d+[dD]\d+)\s*(?:\([^)]+\))?\s*[ï¼>]\s*\d+/gi,""),s=s.replace(/\[\s*[^\]]+?\s*\]\s*[^:ï¼š\n]+?\s*[ï¼š:]\s*\d+\s*[â†’>]\s*\d+/g,""),s=s.replace(/ã€Š[^ã€‹]+ã€‹\s*Lv\d+\s*(?:\|[^\n<]*)+(?:(?:<br\s*\/?>\s*|\n)\d+dx\d*(?:\+\d+)?\s*\([^)]+\)\s*[ï¼>]\s*[^\sï¼>]+\s*[ï¼>]\s*\d+)?/gi,""),s=s.replace(/(?:\d+[â†‘â†“])?\s*[^\|ã€Š\n]*?\s*ã€Š[^ã€‹]+ã€‹(?:\s*\+\s*ã€Š[^ã€‹]+ã€‹)*\s*(?:\|[^\n<]*){0,3}(?:(?:<br\s*\/?>\s*|\n)\d+dx\d*(?:\+\d+)?\s*\([^)]+\)\s*[ï¼>]\s*[^\sï¼>]+\s*[ï¼>]\s*\d+)?/gi,""),s=s.replace(/ã€ŠC:[^ã€‹]+ã€‹(?:\s*\|[^\n<]*)*(?:(?:<br\s*\/?>\s*|\n)\d+dx\d*(?:\+\d+)?\s*\([^)]+\)\s*[ï¼>]\s*[^\sï¼>]+\s*[ï¼>]\s*\d+)?/gi,""),s=s.replace(/ã€Š[^ã€‹]+ã€‹(?:\s*\+\s*ã€Š[^ã€‹]+ã€‹)+(?:(?:<br\s*\/?>\s*|\n)\d+dx\d*(?:\+\d+)?\s*\([^)]+\)\s*[ï¼>]\s*[^\sï¼>]+\s*[ï¼>]\s*\d+)?/gi,""),s=s.replace(/^(<br\s*\/?>|\s)+$/gi,""),s.trim()}static parseTextLog(e){return console.warn("í”Œë ˆì¸ í…ìŠ¤íŠ¸ íŒŒì‹±ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."),{title:"í…ìŠ¤íŠ¸ ë¡œê·¸",scenes:[{id:"scene_0",name:"ë¡œê·¸",steps:[{id:"step_0_0",type:"narrator",character:{name:"",color:"#333"},text:e,rawText:e,diceRolls:[],hasDice:!1}]}],characters:{},handouts:[]}}static parse(e){if(!e)throw new Error("ë¡œê·¸ ë‚´ìš©ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");if(e.trim().startsWith("<!DOCTYPE html")||e.trim().startsWith("<html")||e.includes('<div class="cclog_wrap"')||e.includes('<div class="ccfolia_wrap"')||e.includes('<div class="gap"'))return this.parseHTMLLog(e);if(e.trim().startsWith("{")||e.trim().startsWith("["))try{return JSON.parse(e)}catch(s){throw new Error("JSON íŒŒì‹± ì‹¤íŒ¨: "+s.message)}return this.parseTextLog(e)}}const H={name:"Home",setup(){return{logStore:A()}},data(){return{isLoading:!1,errorMessage:""}},methods:{triggerFileInput(){this.$refs.fileInput.click()},async handleFileSelect(E){const e=E.target.files[0];if(!e)return;this.isLoading=!0,this.errorMessage="";const s=new FileReader;s.onload=i=>{try{const t=i.target.result;this.logStore.setRawLog(t);const l=j.parse(t);console.log("íŒŒì‹± ì™„ë£Œ:",l),this.logStore.setVNData(l),this.$router.push("/player")}catch(t){console.error("íŒŒì‹± ì˜¤ë¥˜:",t),this.errorMessage=`íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨: ${t.message}`}finally{this.isLoading=!1}},s.onerror=()=>{this.errorMessage="íŒŒì¼ ì½ê¸° ì‹¤íŒ¨",this.isLoading=!1},s.readAsText(e)}}},O={class:"home"},B={class:"container"},W={class:"header"},V={class:"upload-section"},X={class:"upload-card"},J=["disabled"],z={key:0,class:"error-message"};function G(E,e,s,i,t,l){const o=U("EmojiToIcon");return $(),L("div",O,[_("div",B,[_("header",W,[_("h1",null,[k(o,{emoji:"ğŸ“–",size:40}),e[2]||(e[2]=N(" VNLog Player ",-1))]),e[3]||(e[3]=_("p",{class:"subtitle"},"TRPG ë¡œê·¸ë¥¼ ë¹„ì£¼ì–¼ ë…¸ë²¨ë¡œ ì¬ìƒí•˜ì„¸ìš”",-1))]),_("div",V,[_("div",X,[k(o,{emoji:"ğŸ“",size:48,class:"upload-icon"}),e[4]||(e[4]=_("h2",null,"ë¡œê·¸ íŒŒì¼ ì—…ë¡œë“œ",-1)),e[5]||(e[5]=_("p",null,"ë“œë˜ê·¸ & ë“œë¡­ ë˜ëŠ” í´ë¦­í•˜ì—¬ ë¡œê·¸ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”",-1)),_("input",{ref:"fileInput",type:"file",accept:".txt,.log,.json,.html",onChange:e[0]||(e[0]=(...r)=>l.handleFileSelect&&l.handleFileSelect(...r)),class:"file-input"},null,544),_("button",{onClick:e[1]||(e[1]=(...r)=>l.triggerFileInput&&l.triggerFileInput(...r)),class:"upload-button",disabled:t.isLoading},[k(o,{emoji:"ğŸ“¤",size:20}),N(" "+P(t.isLoading?"ì²˜ë¦¬ ì¤‘...":"íŒŒì¼ ì„ íƒ"),1)],8,J),t.errorMessage?($(),L("p",z,P(t.errorMessage),1)):M("",!0)])])])])}const Q=q(H,[["render",G],["__scopeId","data-v-1ed5d714"]]);export{Q as default};
